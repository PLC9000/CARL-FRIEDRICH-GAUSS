<!DOCTYPE html>
<html lang="es-AR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Carl Friedrich Gauss</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%230a0d14'/%3E%3Cline x1='8' y1='6' x2='8' y2='26' stroke='%2322c55e' stroke-width='1.5'/%3E%3Crect x='5.5' y='10' width='5' height='10' rx='1' fill='%2322c55e'/%3E%3Cline x1='16' y1='4' x2='16' y2='28' stroke='%23ef4444' stroke-width='1.5'/%3E%3Crect x='13.5' y='8' width='5' height='14' rx='1' fill='%23ef4444'/%3E%3Cline x1='24' y1='7' x2='24' y2='25' stroke='%2322c55e' stroke-width='1.5'/%3E%3Crect x='21.5' y='11' width='5' height='8' rx='1' fill='%2322c55e'/%3E%3C/svg%3E">
<link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%230a0d14'/%3E%3Cline x1='8' y1='6' x2='8' y2='26' stroke='%2322c55e' stroke-width='1.5'/%3E%3Crect x='5.5' y='10' width='5' height='10' rx='1' fill='%2322c55e'/%3E%3Cline x1='16' y1='4' x2='16' y2='28' stroke='%23ef4444' stroke-width='1.5'/%3E%3Crect x='13.5' y='8' width='5' height='14' rx='1' fill='%23ef4444'/%3E%3Cline x1='24' y1='7' x2='24' y2='25' stroke='%2322c55e' stroke-width='1.5'/%3E%3Crect x='21.5' y='11' width='5' height='8' rx='1' fill='%2322c55e'/%3E%3C/svg%3E">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='36' fill='%230a0d14'/%3E%3Cline x1='45' y1='30' x2='45' y2='150' stroke='%2322c55e' stroke-width='6'/%3E%3Crect x='31' y='55' width='28' height='60' rx='4' fill='%2322c55e'/%3E%3Cline x1='90' y1='20' x2='90' y2='160' stroke='%23ef4444' stroke-width='6'/%3E%3Crect x='76' y='45' width='28' height='80' rx='4' fill='%23ef4444'/%3E%3Cline x1='135' y1='35' x2='135' y2='145' stroke='%2322c55e' stroke-width='6'/%3E%3Crect x='121' y='60' width='28' height='50' rx='4' fill='%2322c55e'/%3E%3C/svg%3E">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0d14;--surface:#111520;--card:#161b28;--border:#1e2538;--border-hover:#2a3352;--text:#d1d5e0;--text-bright:#f0f2f5;--muted:#5a6480;--accent:#3b82f6;--accent-hover:#5b9bf7;--accent2:#10b981;--buy:#22c55e;--sell:#ef4444;--hold:#f59e0b;--radius:6px;--shadow:0 2px 8px rgba(0,0,0,.3);--mono:'JetBrains Mono','SF Mono','Cascadia Code',Consolas,monospace;--ticker-bg:#060a06;--ticker-border:#142014;--ticker-text:#39ff14;--ticker-glow:rgba(57,255,20,.4);--overlay-bg:rgba(0,0,0,.75);--table-stripe:rgba(255,255,255,.015);--table-hover:rgba(59,130,246,.04);--btn-primary-text:#fff;--flow-input:#3b9dff;--flow-risk:#8b5cf6;--auto-badge:#a78bfa;--auto-badge-bg:var(--auto-badge-bg);--strength-color:var(--strength-color);--direction-color:var(--direction-color);--card-shadow:0 1px 3px rgba(0,0,0,.2);--input-bg:var(--surface)}

/* ── Theme: Twilight (Medium) ───────────────────────── */
[data-theme="medium"]{--bg:#1a1d2e;--surface:#222640;--card:#282d4a;--border:#353b5e;--border-hover:#454d78;--text:#c8cce0;--text-bright:#e8eaf2;--muted:#7880a0;--accent:#5b9bf7;--accent-hover:#7db3ff;--accent2:#34d399;--buy:#34d399;--sell:#f87171;--hold:#fbbf24;--shadow:0 2px 8px rgba(0,0,0,.25);--ticker-bg:#121426;--ticker-border:#252a4a;--ticker-text:#6aff5a;--ticker-glow:rgba(106,255,90,.3);--overlay-bg:rgba(10,10,30,.7);--table-stripe:rgba(255,255,255,.02);--table-hover:rgba(91,155,247,.06);--btn-primary-text:#fff;--flow-input:#5badff;--flow-risk:#a78bfa;--auto-badge:#c4b5fd;--auto-badge-bg:rgba(167,139,250,.15);--strength-color:#fbbf24;--direction-color:#5badff;--card-shadow:0 1px 3px rgba(0,0,0,.18);--input-bg:#1e2238}

/* ── Theme: Light ───────────────────────────────────── */
[data-theme="light"]{--bg:#f0f2f8;--surface:#ffffff;--card:#ffffff;--border:#dde0ea;--border-hover:#c0c6d6;--text:#2d3148;--text-bright:#111827;--muted:#6b7194;--accent:#2563eb;--accent-hover:#1d4ed8;--accent2:#059669;--buy:#16a34a;--sell:#dc2626;--hold:#d97706;--shadow:0 2px 8px rgba(0,0,0,.07);--ticker-bg:#e8ece8;--ticker-border:#c0d4c0;--ticker-text:#15803d;--ticker-glow:rgba(21,128,61,.25);--overlay-bg:rgba(0,0,0,.35);--table-stripe:rgba(0,0,0,.018);--table-hover:rgba(37,99,235,.05);--btn-primary-text:#fff;--flow-input:#2563eb;--flow-risk:#7c3aed;--auto-badge:#7c3aed;--auto-badge-bg:rgba(124,58,237,.08);--strength-color:#d97706;--direction-color:#2563eb;--card-shadow:0 1px 4px rgba(0,0,0,.06);--input-bg:#f5f6fa}
[data-theme="light"] .card,[data-theme="light"] .panel{border:1px solid var(--border)}
[data-theme="light"] input,[data-theme="light"] select,[data-theme="light"] textarea{background:var(--input-bg);border-color:var(--border)}
[data-theme="light"] .header{background:var(--surface);border-bottom:1px solid var(--border)}
[data-theme="light"] .main-tabs{background:var(--surface);border-bottom:1px solid var(--border)}

body{font-family:'Inter',-apple-system,system-ui,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;min-height:-webkit-fill-available;overflow-x:hidden;font-size:13px;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}

/* ── Container & Panels ─────────────────────────────── */
.container{max-width:1080px;margin:0 auto;padding:20px 16px 50px}
.panel{display:none;animation:fadeUp .25s ease}.panel.visible{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.panel-title{font-size:1.25rem;font-weight:800;margin-bottom:2px;color:var(--text-bright)}
.panel-sub{color:var(--muted);font-size:.82rem;margin-bottom:18px;line-height:1.5}

/* ── Cards & Forms ──────────────────────────────────── */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px;transition:border-color .15s}
.card:hover{border-color:var(--border-hover)}
label{display:block;font-weight:600;font-size:.7rem;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);margin-bottom:4px}
label .hint{display:block;font-weight:400;text-transform:none;letter-spacing:0;font-size:.72rem;margin-top:2px;color:var(--muted);line-height:1.4;opacity:.7}
input,select,textarea{width:100%;padding:8px 10px;border-radius:4px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:.85rem;transition:border-color .15s,box-shadow .15s;outline:none;appearance:none;-webkit-appearance:none;font-family:inherit}
input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(59,130,246,.15)}
select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%235a6480' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:30px;cursor:pointer}
select option{background:var(--surface);color:var(--text)}
textarea{resize:vertical;min-height:60px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
.form-row-3{display:grid;grid-template-columns:2fr 1fr;gap:10px;margin-bottom:10px}
.form-group{margin-bottom:10px}
@media(max-width:600px){.form-row,.form-row-3{grid-template-columns:1fr}}

/* ── Buttons ────────────────────────────────────────── */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:8px 20px;border-radius:4px;border:none;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:.05em;font-family:inherit}
.btn:active{opacity:.85}.btn:disabled{opacity:.25;cursor:not-allowed}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:var(--accent-hover)}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text)}
.btn-outline:hover{border-color:var(--accent);color:var(--accent);background:rgba(59,130,246,.06)}
.btn-sm{padding:5px 12px;font-size:.75rem}
.btn-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:14px}
.btn-danger{background:rgba(239,68,68,.1);border:1px solid var(--sell);color:var(--sell);padding:5px 12px;border-radius:4px;font-size:.75rem;font-weight:600;cursor:pointer;transition:all .15s}
.btn-danger:hover{background:rgba(239,68,68,.2)}

/* ── Header ─────────────────────────────────────────── */
.header{display:flex;align-items:center;justify-content:space-between;padding:0 16px;height:42px;background:var(--bg);border-bottom:1px solid var(--border)}
.header-title{font-weight:800;font-size:.85rem;color:var(--accent);flex-shrink:0;letter-spacing:.02em}
/* ── Retro phosphor ticker ── */
.gauss-ticker-wrap{flex:1;max-width:480px;margin:0 12px;height:24px;border-radius:3px;background:var(--ticker-bg);border:1px solid var(--ticker-border);position:relative;overflow:hidden;box-shadow:inset 0 0 8px rgba(0,0,0,.5)}
.gauss-ticker-wrap::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.12) 2px,rgba(0,0,0,.12) 4px);pointer-events:none;z-index:2}
.gauss-ticker-wrap::after{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at center,transparent 50%,rgba(0,0,0,.3) 100%);pointer-events:none;z-index:1}
.gauss-ticker-inner{position:absolute;top:0;left:0;height:100%;display:flex;align-items:center;white-space:nowrap;animation:gaussScroll 18s linear infinite;will-change:transform}
.gauss-ticker-inner span{font-family:var(--mono);font-size:.65rem;font-weight:600;color:var(--ticker-text);text-shadow:0 0 4px var(--ticker-glow);letter-spacing:.3px;padding:0 60px 0 0}
@keyframes gaussScroll{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}
.header-right{display:flex;align-items:center;gap:6px;font-size:.75rem;font-family:var(--mono)}
.header-right .gear{cursor:pointer;font-size:1rem;opacity:.5;transition:opacity .15s}.header-right .gear:hover{opacity:1}
.header-right .logout{cursor:pointer;color:var(--sell);font-weight:600;margin-left:6px;font-size:.72rem;opacity:.8}.header-right .logout:hover{opacity:1}
.badge{display:inline-block;padding:2px 6px;border-radius:3px;font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.03em}
.badge-pending{background:rgba(245,158,11,.12);color:var(--hold)}
.badge-approved{background:rgba(34,197,94,.12);color:var(--buy)}
.badge-rejected{background:rgba(239,68,68,.12);color:var(--sell)}
.badge-keys{background:rgba(16,185,129,.12);color:var(--accent2)}

/* ── Main Tab Bar ──────────────────────────────────── */
.main-tabs{display:flex;gap:0;background:var(--surface);border-bottom:1px solid var(--border);padding:0 16px;overflow-x:auto;-webkit-overflow-scrolling:touch}
.main-tab{padding:10px 16px;font-size:.72rem;font-weight:700;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .15s;background:none;border-top:none;border-left:none;border-right:none;text-transform:uppercase;letter-spacing:.06em;white-space:nowrap}
.main-tab:hover{color:var(--text);background:rgba(59,130,246,.03)}.main-tab.active{color:var(--accent);border-bottom-color:var(--accent);background:rgba(59,130,246,.05)}

/* ── Settings Modal ─────────────────────────────────── */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);z-index:90;justify-content:center;align-items:center}
.modal-overlay.show{display:flex}
.modal{background:var(--card);border:1px solid var(--border);border-top:2px solid var(--accent);border-radius:var(--radius);padding:20px;width:90%;max-width:480px;box-shadow:0 16px 48px rgba(0,0,0,.5);animation:modalIn .2s ease}
@keyframes modalIn{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
.modal-title{font-size:1.05rem;font-weight:800;margin-bottom:2px;color:var(--text-bright)}
.modal-sub{font-size:.78rem;color:var(--muted);margin-bottom:14px;line-height:1.4}
.modal-close{float:right;cursor:pointer;font-size:1.1rem;opacity:.4;transition:opacity .15s;background:none;border:none;color:var(--text);padding:4px}.modal-close:hover{opacity:1}

/* ── Server IP Box ────────────────────────────────── */
.server-ip-box{display:flex;align-items:center;gap:8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:8px 12px;margin-bottom:12px}
.server-ip-box .ip-label{font-size:.68rem;color:var(--muted);font-weight:600;white-space:nowrap;text-transform:uppercase;letter-spacing:.04em}
.server-ip-box .ip-value{font-family:var(--mono);font-size:.85rem;font-weight:700;color:var(--accent);flex:1;user-select:all}
.server-ip-box .ip-copy{cursor:pointer;padding:4px 10px;border-radius:3px;border:1px solid var(--border);background:none;color:var(--text);font-size:.68rem;font-weight:600;transition:all .15s;white-space:nowrap}
.server-ip-box .ip-copy:hover{border-color:var(--accent);color:var(--accent)}
.server-ip-box .ip-copy.copied{border-color:var(--buy);color:var(--buy)}

/* ── Permissions Grid ─────────────────────────────── */
.perm-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;margin-top:12px}
.perm-card{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:4px;background:var(--bg);border:1px solid var(--border);transition:border-color .15s}
.perm-card .perm-icon{font-size:1rem;flex-shrink:0}.perm-card .perm-info{flex:1;min-width:0}
.perm-card .perm-name{font-size:.7rem;font-weight:600;line-height:1.3}
.perm-card .perm-status{font-size:.6rem;font-weight:700;text-transform:uppercase;margin-top:1px}
.perm-card.perm-on{border-color:rgba(34,197,94,.25)}.perm-card.perm-on .perm-status{color:var(--buy)}
.perm-card.perm-off{border-color:rgba(239,68,68,.15);opacity:.5}.perm-card.perm-off .perm-status{color:var(--sell)}
.perm-card.perm-warn{border-color:rgba(239,68,68,.4);background:rgba(239,68,68,.04)}.perm-card.perm-warn .perm-status{color:var(--sell)}
.perm-card.perm-secure{border-color:rgba(16,185,129,.3);background:rgba(16,185,129,.04)}.perm-card.perm-secure .perm-status{color:var(--accent2)}
.perm-loader{text-align:center;padding:16px;color:var(--muted);font-size:.8rem}
.perm-created{font-size:.68rem;color:var(--muted);margin-top:10px;text-align:center}

/* ── Recipe Cards ──────────────────────────────────── */
.recipe-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:8px;transition:border-color .15s}
.recipe-card:hover{border-color:var(--border-hover)}
.recipe-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:8px}
.recipe-name{font-weight:700;font-size:.95rem;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text-bright)}
.recipe-header>div:last-child{flex-shrink:0}
.recipe-badge{display:inline-block;padding:2px 8px;border-radius:3px;font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.04em}
.recipe-badge.active{background:rgba(34,197,94,.12);color:var(--buy)}
.recipe-badge.inactive{background:rgba(90,100,128,.12);color:var(--muted)}
.recipe-meta{display:flex;gap:4px 12px;flex-wrap:wrap;font-size:.68rem;color:var(--muted);margin-bottom:6px;font-family:var(--mono)}
.recipe-meta span{display:flex;align-items:center;gap:3px}
.recipe-config{display:flex;gap:4px 6px;flex-wrap:wrap;margin-bottom:6px}
.recipe-config .rc-chip{display:inline-flex;align-items:center;gap:2px;padding:1px 6px;border-radius:3px;font-size:.58rem;font-weight:600;background:rgba(90,100,128,.08);color:var(--muted);white-space:nowrap;font-family:var(--mono)}
.recipe-config .rc-chip.buy{color:var(--buy);background:rgba(34,197,94,.06)}
.recipe-config .rc-chip.sell{color:var(--sell);background:rgba(239,68,68,.06)}
.recipe-config .rc-chip.auto{color:var(--accent);background:rgba(59,130,246,.06)}
.recipe-config .rc-chip.strength{color:#f59e0b;background:rgba(245,158,11,.06)}
.recipe-config .rc-chip.confirm{color:#3b82f6;background:rgba(59,130,246,.06)}
.recipe-config .rc-chip.turbo{color:#f97316;background:rgba(249,115,22,.06)}
.rcp-param-group{border-radius:var(--radius);padding:14px 16px;margin-bottom:12px;border:1px solid}
.rcp-param-group .rpg-title{font-size:.72rem;font-weight:800;text-transform:uppercase;letter-spacing:.04em;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.rcp-param-group .form-row{margin-bottom:0}
.rcp-param-group.signals{border-color:rgba(34,197,94,.18);background:rgba(34,197,94,.02)}
.rcp-param-group.signals .rpg-title{color:var(--buy)}
.rcp-param-group.execution{border-color:rgba(59,130,246,.15);background:rgba(59,130,246,.02)}
.rcp-param-group.execution .rpg-title{color:var(--accent)}
.rcp-param-group.risk{border-color:rgba(245,158,11,.18);background:rgba(245,158,11,.02)}
.rcp-param-group.risk .rpg-title{color:#f59e0b}
.rcp-param-group.eval-grp{border-color:rgba(90,100,128,.12);background:rgba(90,100,128,.02)}
.rcp-param-group.eval-grp .rpg-title{color:var(--muted)}
.recipe-strats{display:flex;gap:4px 6px;flex-wrap:wrap;margin-bottom:8px}
.recipe-strat-badge{display:inline-block;padding:2px 6px;border-radius:3px;font-size:.62rem;font-weight:600;background:rgba(59,130,246,.1);color:var(--accent);font-family:var(--mono)}
.recipe-actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
.recipe-actions button{font-size:.72rem;padding:4px 10px;border-radius:4px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--text);transition:all .15s}
.recipe-actions button:hover{border-color:var(--accent);color:var(--accent);background:rgba(59,130,246,.04)}
.recipe-score-wrap{margin:6px 0 2px;position:relative}
.recipe-score-track{height:4px;border-radius:2px;background:rgba(90,100,128,.10);position:relative;overflow:visible;margin-top:6px}
.recipe-score-center{position:absolute;left:50%;top:-1px;width:1px;height:6px;background:rgba(90,100,128,.20)}
.recipe-score-fill{position:absolute;top:0;height:100%;border-radius:2px;transition:width .6s,left .6s,background .6s}
.recipe-score-dot{position:absolute;top:50%;width:7px;height:7px;border-radius:50%;transform:translate(-50%,-50%);border:1.5px solid var(--card);box-shadow:0 0 3px rgba(0,0,0,.3);transition:left .6s,background .6s}
.recipe-score-labels{display:flex;justify-content:space-between;font-size:.55rem;color:rgba(90,100,128,.4);margin-top:18px;user-select:none}
.recipe-score-value{position:absolute;top:-13px;transform:translateX(-50%);font-size:.58rem;font-weight:700;white-space:nowrap;transition:left .6s}
.recipe-score-marker{position:absolute;top:-3px;width:1px;height:10px;opacity:.45}
.recipe-score-marker-label{position:absolute;bottom:-14px;transform:translateX(-50%);font-size:.48rem;font-weight:600;white-space:nowrap;opacity:.55}

/* ── Setup Grid ──────────────────────────────────── */
.setup-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px}
.setup-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px;transition:all .15s;position:relative}
.setup-card:hover{border-color:var(--border-hover)}
.setup-card.enabled{border-left:2px solid var(--buy)}
.setup-card.disabled{opacity:.45;border-left:2px solid var(--border)}
.setup-card-header{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.setup-card-icon{font-size:1.4rem}
.setup-card-name{font-weight:700;font-size:.88rem;color:var(--text-bright)}
.setup-card-key{display:inline-block;padding:1px 5px;border-radius:3px;font-size:.6rem;font-weight:600;background:rgba(59,130,246,.1);color:var(--accent);margin-left:4px;font-family:var(--mono)}
.setup-card-category{font-size:.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px}
.setup-card-desc{font-size:.78rem;color:var(--muted);line-height:1.5;margin-bottom:10px}
.setup-card-status{display:flex;align-items:center;justify-content:space-between}
.setup-card-badge{padding:2px 8px;border-radius:3px;font-size:.65rem;font-weight:700;text-transform:uppercase}
.setup-card-badge.on{background:rgba(34,197,94,.12);color:var(--buy)}
.setup-card-badge.off{background:rgba(239,68,68,.08);color:var(--sell)}
.setup-toggle-btn{padding:4px 12px;border-radius:4px;font-size:.72rem;font-weight:600;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--text);transition:all .15s}
.setup-toggle-btn:hover{border-color:var(--accent);color:var(--accent)}
.setup-toggle-btn:disabled{opacity:.25;cursor:not-allowed}
@media(max-width:600px){.setup-grid{grid-template-columns:1fr}}

/* ── Mode Selector ───────────────────────────────── */
.mode-selector{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.mode-card{padding:14px;border-radius:4px;border:1px solid var(--border);background:var(--surface);cursor:pointer;transition:all .15s;text-align:center}
.mode-card:hover{border-color:var(--accent)}
.mode-card.selected{border-color:var(--accent);background:rgba(59,130,246,.06);box-shadow:inset 0 0 0 1px var(--accent)}
.mode-card .mode-icon{font-size:1.4rem;margin-bottom:4px}
.mode-card .mode-name{font-weight:700;font-size:.85rem;margin-bottom:3px;color:var(--text-bright)}
.mode-card .mode-desc{font-size:.7rem;color:var(--muted);line-height:1.4}
.mode-chip{display:inline-block;padding:2px 6px;border-radius:3px;font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.04em;font-family:var(--mono)}
.mode-chip.weighted{background:rgba(59,130,246,.1);color:var(--accent)}
.mode-chip.roles{background:rgba(16,185,129,.1);color:var(--accent2)}
.mode-chip.nomode{background:rgba(239,68,68,.1);color:var(--sell)}
@media(max-width:600px){.mode-selector{grid-template-columns:1fr}}

/* ── Strategy Checkboxes ──────────────────────────── */
.strat-check-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:8px;margin-bottom:12px}
@media(max-width:600px){.strat-check-grid{grid-template-columns:1fr}}
.strat-check{padding:12px;border-radius:4px;border:1px solid var(--border);background:var(--surface);cursor:pointer;transition:all .15s;text-align:center}
.strat-check:hover{border-color:var(--accent)}
.strat-check.selected{border-color:var(--accent);background:rgba(59,130,246,.06)}
.strat-check .sc-icon{font-size:1.3rem;margin-bottom:3px}
.strat-check .sc-name{font-weight:700;font-size:.82rem;margin-bottom:2px;color:var(--text-bright)}
.strat-check .sc-desc{font-size:.68rem;color:var(--muted);line-height:1.3}
.strat-check .sc-weight{margin-top:6px;display:none}
.strat-check.selected .sc-weight{display:block}
.strat-check .sc-role{margin-top:6px;display:none}
.strat-check.selected .sc-role{display:block}
.mode-weighted .strat-check.selected .sc-role{display:none}
.sc-role select{width:100%;padding:4px 6px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text);font-size:.68rem;font-weight:600}
.sc-role select:focus{border-color:var(--accent);outline:none}
.strat-check .sc-params-btn{display:none;margin-top:6px}
.strat-check.selected .sc-params-btn{display:block}
.strat-check .sc-params-btn button{width:100%;padding:5px 10px;border-radius:4px;border:1px solid var(--accent);background:rgba(59,130,246,.06);color:var(--accent);font-size:.7rem;font-weight:600;cursor:pointer;transition:all .15s}
.strat-check .sc-params-btn button:hover{background:rgba(59,130,246,.12)}
.inline-thresholds{display:flex;flex-direction:column;gap:0;margin:12px 0;padding:0;background:transparent;border:none;border-radius:4px;overflow:hidden}
.ifl-stage{padding:12px 14px;position:relative}
.ifl-stage-header{display:flex;align-items:center;gap:6px;margin-bottom:8px}
.ifl-stage-num{width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.6rem;font-weight:700;flex-shrink:0}
.ifl-stage-title{font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em}
.ifl-stage-fields{display:grid;gap:6px}
.ifl-stage.signals{background:rgba(34,197,94,.03);border:1px solid rgba(34,197,94,.12);border-radius:4px 4px 0 0}
.ifl-stage.signals .ifl-stage-num{background:rgba(34,197,94,.15);color:var(--buy)}
.ifl-stage.signals .ifl-stage-title{color:var(--buy)}
.ifl-stage.execution{background:rgba(59,130,246,.03);border:1px solid rgba(59,130,246,.12);border-top:none}
.ifl-stage.execution .ifl-stage-num{background:rgba(59,130,246,.15);color:var(--accent)}
.ifl-stage.execution .ifl-stage-title{color:var(--accent)}
.ifl-stage.risk{background:rgba(245,158,11,.03);border:1px solid rgba(245,158,11,.12);border-top:none;border-radius:0 0 4px 4px}
.ifl-stage.risk .ifl-stage-num{background:rgba(245,158,11,.15);color:var(--hold)}
.ifl-stage.risk .ifl-stage-title{color:var(--hold)}
.ifl-arrow{display:flex;justify-content:center;position:relative;z-index:1;margin:-1px 0}
.ifl-arrow-line{width:2px;height:10px}
.ifl-arrow.sig-to-exec .ifl-arrow-line{background:linear-gradient(var(--buy),var(--accent))}
.ifl-arrow.exec-to-risk .ifl-arrow-line{background:linear-gradient(var(--accent),var(--hold))}
.inline-th-group{display:flex;flex-direction:column;gap:2px}
.inline-th-group label{font-size:.6rem;color:var(--muted);text-transform:uppercase;font-weight:700;letter-spacing:.04em;margin-bottom:0}
.inline-th-group input,.inline-th-group select{width:100%;padding:6px 8px;border-radius:4px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:.8rem;text-align:center;font-family:var(--mono)}
.inline-th-group input:focus,.inline-th-group select:focus{border-color:var(--accent);outline:none;box-shadow:0 0 0 2px rgba(59,130,246,.12)}
.ifl-fixed-type{padding:5px 8px;border-radius:4px;font-weight:700;font-size:.72rem;text-align:center;font-family:var(--mono)}
.ifl-fixed-type.buy{background:rgba(34,197,94,.06);border:1px solid rgba(34,197,94,.15);color:var(--buy)}
.ifl-fixed-type.sell{background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.15);color:var(--sell)}
.btn-test-exec{width:100%;margin-top:6px;padding:6px 0;border-radius:4px;font-weight:700;font-size:.7rem;text-transform:uppercase;letter-spacing:.04em;cursor:pointer;transition:all .15s}
.btn-test-exec.buy{background:rgba(34,197,94,.08);border:1px dashed rgba(34,197,94,.3);color:var(--buy)}
.btn-test-exec.buy:hover{background:rgba(34,197,94,.15);border-style:solid}
.btn-test-exec.sell{background:rgba(239,68,68,.08);border:1px dashed rgba(239,68,68,.3);color:var(--sell)}
.btn-test-exec.sell:hover{background:rgba(239,68,68,.15);border-style:solid}
.btn-test-exec:disabled{opacity:.4;cursor:not-allowed}
.ifl-exec-cols{display:grid;grid-template-columns:1fr 1fr;gap:0;margin-top:6px}
.ifl-exec-col{padding:8px 12px;display:flex;flex-direction:column;gap:6px}
.ifl-exec-col.buy-col{background:rgba(34,197,94,.02);border:1px solid rgba(34,197,94,.1);border-radius:4px 0 0 4px;border-right:none}
.ifl-exec-col.sell-col{background:rgba(239,68,68,.02);border:1px solid rgba(239,68,68,.1);border-radius:0 4px 4px 0}
.ifl-exec-col-title{font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;margin-bottom:2px}
.ifl-exec-col.buy-col .ifl-exec-col-title{color:var(--buy)}
.ifl-exec-col.sell-col .ifl-exec-col-title{color:var(--sell)}
.ifl-balance{display:flex;gap:12px;flex-wrap:wrap;padding:8px 12px;margin-top:6px;background:rgba(245,158,11,.02);border:1px dashed rgba(245,158,11,.12);border-radius:4px}
.ifl-bal-token{flex:1;min-width:100px}
.ifl-bal-label{font-size:.58rem;font-weight:700;text-transform:uppercase;color:var(--muted);letter-spacing:.04em;margin-bottom:2px}
.ifl-bal-free{font-weight:700;font-size:.9rem;font-family:var(--mono)}
.ifl-bal-locked{font-size:.58rem;color:var(--muted);font-family:var(--mono)}
.ifl-bal-loading{font-size:.7rem;color:var(--muted);padding:4px 0}
.inline-th-save{display:flex;gap:8px;justify-content:center;margin-top:8px}
.inline-th-saved{font-size:.7rem;color:var(--buy);font-weight:600;text-align:center;padding:4px;display:none}
@media(max-width:600px){.ifl-stage-fields{grid-template-columns:1fr !important}}
/* ── Inline Recipe Params Editor ──────────────────── */
.rcp-params-panel{display:none;margin-top:10px;padding:14px;background:var(--surface);border:1px solid var(--border);border-radius:4px;animation:fadeUp .2s ease}
.rcp-params-panel.show{display:block}
.rcp-params-strat{margin-bottom:14px}
.rcp-params-strat:last-child{margin-bottom:0}
.rcp-params-strat-header{display:flex;align-items:center;gap:6px;font-size:.78rem;font-weight:700;color:var(--text-bright);margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid var(--border)}
.rcp-params-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:6px}
.rcp-params-field{display:flex;flex-direction:column;gap:2px}
.rcp-params-field label{font-size:.6rem;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.04em}
.rcp-params-field input,.rcp-params-field select{width:100%;padding:6px 8px;border-radius:4px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:.78rem;font-family:var(--mono)}
.rcp-params-field input:focus,.rcp-params-field select:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(59,130,246,.12)}
.rcp-params-field .rcp-p-hint{font-size:.56rem;color:var(--muted);line-height:1.2;margin-top:1px;opacity:.7}
.rcp-params-field .rcp-p-range{font-size:.55rem;color:var(--accent);font-family:var(--mono)}
.rcp-params-actions{display:flex;gap:8px;justify-content:center;margin-top:10px}
.rcp-params-actions button{padding:6px 18px;border-radius:4px;font-size:.75rem;font-weight:600;cursor:pointer;border:none;transition:all .15s;text-transform:uppercase;letter-spacing:.04em}
.rcp-params-save{background:var(--accent);color:#fff}
.rcp-params-save:hover{background:var(--accent-hover)}
.rcp-params-reset{background:var(--card);border:1px solid var(--border)!important;color:var(--muted)}
.rcp-params-reset:hover{color:var(--text);border-color:var(--accent)!important}
@media(max-width:600px){.rcp-params-grid{grid-template-columns:1fr}}
.weight-bar-wrap{margin:8px 0 14px;padding:8px 12px;background:var(--surface);border:1px solid var(--border);border-radius:4px}
.weight-bar-label{display:flex;justify-content:space-between;font-size:.72rem;font-weight:600;margin-bottom:4px;font-family:var(--mono)}
.weight-bar-track{height:6px;background:var(--border);border-radius:3px;overflow:hidden}
.weight-bar-fill{height:100%;border-radius:3px;transition:width .3s,background .3s}
.weight-bar-fill.ok{background:var(--buy)}.weight-bar-fill.low{background:var(--hold)}.weight-bar-fill.over{background:var(--sell)}
.sc-params-btn button{font-size:.65rem;padding:3px 8px;border-radius:3px;border:1px solid var(--accent);background:transparent;color:var(--accent);cursor:pointer;font-weight:600;transition:all .15s}
.sc-params-btn button:hover{background:rgba(59,130,246,.08)}
/* Strategy params editor */
.strat-params-editor{display:none;grid-column:1/-1;background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:14px;animation:fadeUp .2s ease}
.strat-params-editor.show{display:block}
.strat-params-editor h4{font-size:.82rem;font-weight:700;margin-bottom:10px;color:var(--text-bright)}
.spe-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:8px}
.spe-field label{font-size:.62rem;margin-bottom:2px;display:block;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.04em}
.spe-field input,.spe-field select{width:100%;padding:6px 8px;border-radius:4px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:.78rem;font-family:var(--mono)}
.spe-field input:focus,.spe-field select:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(59,130,246,.12)}
.spe-field .spe-tip{font-size:.58rem;color:var(--muted);margin-top:2px;line-height:1.3;opacity:.7}
.spe-field .spe-range{font-size:.56rem;color:var(--accent);margin-top:1px;font-family:var(--mono)}
.spe-reset{font-size:.68rem;color:var(--muted);cursor:pointer;border:none;background:none;margin-top:6px;text-decoration:underline;font-family:inherit}
.spe-reset:hover{color:var(--text)}

/* ── Params Panel ──────────────────────────────────── */
.params-toggle{display:flex;align-items:center;gap:8px;cursor:pointer;margin:14px 0 8px;font-size:.82rem;font-weight:700;color:var(--muted);user-select:none;transition:color .2s}
.params-toggle:hover{color:var(--text)}
.params-toggle .arrow{transition:transform .2s;font-size:.7rem}.params-toggle.open .arrow{transform:rotate(90deg)}
.params-panel{display:none;padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:16px}
.params-panel.show{display:block;animation:fadeUp .3s ease}
.params-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
.params-grid .form-group{margin-bottom:0}
.params-grid label{font-size:.7rem;margin-bottom:4px}
.params-grid input{padding:9px 12px;font-size:.85rem}
.params-grid .param-hint{font-size:.65rem;color:#4a5370;margin-top:3px}

/* ── Evaluations Table ─────────────────────────────── */
.eval-table{width:100%;border-collapse:collapse;font-size:.75rem}
.eval-table th{text-align:left;color:var(--muted);font-weight:600;padding:6px 8px;border-bottom:1px solid var(--border);font-size:.62rem;text-transform:uppercase;letter-spacing:.05em;background:var(--surface);position:sticky;top:0;z-index:1}
.eval-table td{padding:6px 8px;border-bottom:1px solid rgba(30,37,56,.5)}
.eval-table tbody tr:nth-child(even) td{background:rgba(255,255,255,.015)}
.eval-table tbody tr:hover td{background:rgba(59,130,246,.04)}

/* ── Approvals Table ──────────────────────────────── */
.approval-table{width:100%;border-collapse:collapse;font-size:.75rem;table-layout:auto}
.approval-table th{text-align:left;color:var(--muted);font-weight:600;padding:6px 8px;border-bottom:1px solid var(--border);font-size:.62rem;text-transform:uppercase;letter-spacing:.05em;white-space:nowrap;background:var(--surface);position:sticky;top:0;z-index:1}
.approval-table td{padding:6px 8px;border-bottom:1px solid rgba(30,37,56,.5);vertical-align:middle;font-size:.73rem}
.approval-table tbody tr:nth-child(even) td{background:rgba(255,255,255,.015)}
.approval-table tbody tr:hover td{background:rgba(59,130,246,.04)}
.approval-table .col-price{font-family:var(--mono);font-size:.7rem;white-space:nowrap}
@media(max-width:800px){.approval-table .col-hide-sm{display:none}}

/* ── Score Bar ──────────────────────────────────────── */
.score-bar{width:60px;height:6px;border-radius:2px;background:var(--surface);display:inline-block;vertical-align:middle;margin-right:6px;overflow:hidden;border:1px solid rgba(30,37,56,.6)}
.score-fill{height:100%;border-radius:2px;transition:width .3s}

/* ── Chart Analysis Panel ─────────────────────────── */
.chart-panel{margin-top:10px;padding:14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);animation:fadeUp .2s ease}
.chart-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
.chart-row-top{grid-template-columns:2fr 3fr}
.chart-section-title{font-size:.68rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--muted);margin-bottom:8px}
@media(max-width:700px){.chart-row,.chart-row-top{grid-template-columns:1fr}}

/* Signal Summary */
.chart-signal{text-align:center;padding:16px 12px;border-radius:var(--radius);background:var(--card);border:1px solid var(--border);display:flex;flex-direction:column;align-items:center;justify-content:center}
.chart-signal-icon{font-size:2.2rem;margin-bottom:2px;line-height:1}
.chart-signal-label{font-size:1.3rem;font-weight:800;letter-spacing:.03em}
.chart-signal-label.buy{color:var(--buy)}
.chart-signal-label.sell{color:var(--sell)}
.chart-signal-label.hold{color:var(--hold)}
.chart-signal-score{font-size:.78rem;color:var(--muted);margin-top:2px;font-family:var(--mono)}
.chart-signal-explain{font-size:.72rem;color:var(--muted);margin-top:10px;line-height:1.5;text-align:left;background:rgba(0,0,0,.2);padding:8px 10px;border-radius:4px;width:100%}

/* Voting */
.chart-votes{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:8px}
.chart-vote-card{padding:10px 12px 8px;border-radius:var(--radius);background:var(--card);border:1px solid var(--border);text-align:left}
.chart-vote-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}
.chart-vote-name{font-size:.72rem;font-weight:600;color:var(--text)}
.chart-vote-signal{font-weight:800;font-size:.88rem;font-family:var(--mono)}
.chart-vote-signal.buy{color:var(--buy)}
.chart-vote-signal.sell{color:var(--sell)}
.chart-vote-signal.hold{color:var(--hold)}
.chart-vote-bar{height:4px;border-radius:2px;background:var(--surface);overflow:hidden;margin:4px 0 3px}
.chart-vote-fill{height:100%;border-radius:2px;transition:width .4s ease}
.chart-vote-meta{font-size:.62rem;color:var(--muted)}
.chart-vote-score{font-size:.78rem;font-weight:700;margin:2px 0 4px;font-family:var(--mono)}
.chart-vote-metrics{display:grid;grid-template-columns:1fr 1fr;gap:1px 10px;margin:6px 0;padding:6px;background:var(--surface);border-radius:4px;font-size:.68rem}
.chart-vote-metric-row{display:flex;justify-content:space-between;padding:2px 0;border-bottom:1px solid rgba(255,255,255,.03)}
.chart-vote-metric-row:last-child{border-bottom:none}
.chart-vote-mk{color:var(--muted)}
.chart-vote-mv{color:var(--text);font-weight:600;text-align:right;font-family:var(--mono)}
.chart-vote-prices{font-size:.68rem;color:var(--muted);margin:4px 0;display:flex;gap:8px;flex-wrap:wrap;font-family:var(--mono)}
.chart-vote-prices span{white-space:nowrap}
.chart-vote-explain{font-size:.65rem;color:var(--muted);font-style:italic;margin-top:6px;line-height:1.4;padding:5px 7px;background:rgba(0,0,0,.12);border-radius:3px}

/* Price Levels */
.chart-prices{padding:14px;border-radius:4px;background:var(--card);border:1px solid var(--border)}
.chart-price-bar{position:relative;height:32px;background:var(--surface);border-radius:4px;border:1px solid var(--border);margin:10px 0 12px;overflow:visible}
.chart-price-range{position:absolute;top:0;height:100%;background:rgba(59,130,246,.08);border-radius:4px}
.chart-price-marker{position:absolute;top:0;height:100%;width:2px;border-radius:1px;transform:translateX(-50%)}
.chart-price-marker-label{position:absolute;top:-14px;font-size:.58rem;font-weight:700;transform:translateX(-50%);white-space:nowrap;font-family:var(--mono)}
.chart-price-legend{display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:.68rem;color:var(--muted)}
.chart-dot{display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:4px;vertical-align:middle}

/* OCO Chart SVG */
.oco-chart-wrap{padding:14px;border-radius:4px;background:var(--card);border:1px solid var(--border)}
.oco-chart-svg{width:100%;height:auto;display:block}
.oco-chart-svg text{font-family:Inter,system-ui,-apple-system,sans-serif}
.oco-chart-legend{display:flex;gap:12px;flex-wrap:wrap;font-size:.68rem;color:var(--muted);margin-top:8px;justify-content:center}
.oco-chart-legend-item{display:flex;align-items:center;gap:4px}
.oco-chart-legend-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.oco-closed-btn{background:rgba(59,130,246,.06);border:1px solid var(--accent);color:var(--accent);padding:5px 12px;border-radius:4px;font-size:.7rem;font-weight:600;cursor:pointer;transition:all .15s;margin-top:6px}
.oco-closed-btn:hover{background:rgba(59,130,246,.12)}
@media(max-width:480px){.oco-chart-svg text{font-size:110%}.oco-chart-legend{font-size:.65rem;gap:8px}}

/* Analysis button */
.btn-analysis{background:rgba(59,130,246,.06);border:1px solid var(--accent);color:var(--accent);padding:5px 12px;border-radius:4px;font-size:.75rem;font-weight:600;cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:.04em}
.btn-analysis:hover{background:rgba(59,130,246,.12)}

/* Auto-refresh toggle */
.chart-live-bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:4px}
.chart-live-left{display:flex;align-items:center;gap:6px;font-size:.75rem;color:var(--muted)}
.chart-live-dot{width:6px;height:6px;border-radius:50%;background:var(--muted);transition:background .3s}
.chart-live-dot.on{background:var(--buy);box-shadow:0 0 6px rgba(34,197,94,.5);animation:livePulse 1.5s infinite}
@keyframes livePulse{0%,100%{opacity:1}50%{opacity:.4}}
.chart-live-btn{padding:4px 12px;border-radius:4px;font-size:.72rem;font-weight:600;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--text);transition:all .15s;text-transform:uppercase;letter-spacing:.04em}
.chart-live-btn.active{border-color:var(--buy);color:var(--buy);background:rgba(34,197,94,.06)}
.chart-live-btn:hover{border-color:var(--accent)}
.chart-live-timer{font-size:.68rem;color:var(--muted);font-variant-numeric:tabular-nums;font-family:var(--mono)}

/* Score trend arrow */
.chart-trend{display:inline-flex;align-items:center;gap:3px;font-size:.72rem;font-weight:700;margin-top:3px;padding:2px 8px;border-radius:3px;font-family:var(--mono)}
.chart-trend.up{color:var(--buy);background:rgba(34,197,94,.08)}
.chart-trend.down{color:var(--sell);background:rgba(239,68,68,.08)}
.chart-trend.flat{color:var(--muted);background:rgba(90,100,128,.08)}

/* Eval table strategy badges */
.strat-tag{display:inline-block;padding:1px 6px;border-radius:3px;font-size:.65rem;font-weight:700;margin:1px 1px;font-family:var(--mono)}
.strat-tag.buy{color:var(--buy);background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.2)}
.strat-tag.sell{color:var(--sell);background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.2)}
.strat-tag.notrade{color:var(--muted);background:transparent;border:1px solid var(--border)}

/* Strategy catalog cards */
.strat-catalog{display:grid;grid-template-columns:repeat(auto-fill,minmax(380px,1fr));gap:10px}
@media(max-width:500px){.strat-catalog{grid-template-columns:1fr}}
.strat-catalog-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;transition:border-color .15s}
.strat-catalog-card:hover{border-color:var(--border-hover)}
.strat-catalog-header{display:flex;align-items:center;gap:10px;margin-bottom:4px}
.strat-catalog-icon{font-size:1.5rem}
.strat-catalog-name{font-weight:700;font-size:.95rem;color:var(--text-bright)}
.strat-catalog-key{display:inline-block;padding:1px 6px;border-radius:3px;font-size:.62rem;font-weight:600;background:rgba(59,130,246,.1);color:var(--accent);margin-left:4px;font-family:var(--mono)}
.strat-catalog-category{font-size:.68rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.04em;margin-bottom:8px;padding-left:44px}
.strat-catalog-desc{font-size:.82rem;color:var(--text);line-height:1.5;margin-bottom:10px}
.strat-catalog-example{font-size:.75rem;color:var(--muted);line-height:1.4;margin-bottom:10px;padding:8px 10px;background:rgba(59,130,246,.03);border-left:2px solid var(--accent);border-radius:0 4px 4px 0}
.strat-catalog-example strong{color:var(--text-bright);font-weight:700}
.strat-catalog-tags{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
.strat-catalog-tag{font-size:.68rem;padding:3px 8px;border-radius:3px;font-weight:600;line-height:1.3}
.strat-catalog-tag.works{background:rgba(34,197,94,.06);color:var(--buy);border:1px solid rgba(34,197,94,.15)}
.strat-catalog-tag.fails{background:rgba(239,68,68,.06);color:var(--sell);border:1px solid rgba(239,68,68,.15)}
.strat-catalog-params{font-size:.72rem;color:var(--muted);margin-bottom:4px}
.strat-catalog-toggle{margin-top:6px;cursor:pointer;font-size:.72rem;color:var(--accent);background:none;border:1px solid var(--accent);border-radius:4px;padding:4px 14px;font-weight:600;transition:all .15s;text-transform:uppercase;letter-spacing:.04em}
.strat-catalog-toggle:hover{background:rgba(59,130,246,.08)}
.strat-params-detail{display:none;margin-top:10px;padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:4px}
.strat-params-detail.show{display:block;animation:fadeUp .2s ease}
.strat-param-row{display:flex;justify-content:space-between;align-items:flex-start;padding:8px 0;border-bottom:1px solid rgba(30,37,56,.3);font-size:.75rem;gap:12px}
.strat-param-row:last-child{border-bottom:none}
.strat-param-name{font-weight:700;color:var(--text-bright);font-size:.78rem}
.strat-param-val{color:var(--accent);font-weight:700;white-space:nowrap;font-size:.78rem;min-width:70px;text-align:right;font-family:var(--mono)}
.strat-param-desc{font-size:.7rem;color:var(--muted);margin-top:2px;line-height:1.4}
.strat-param-tip{font-size:.65rem;color:var(--muted);margin-top:3px;line-height:1.4;padding:4px 6px;background:rgba(59,130,246,.03);border-radius:3px;opacity:.8}

/* ── Order Type Selector ────────────────────────────── */
.order-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
@media(max-width:600px){.order-grid{grid-template-columns:1fr}}
.order-card{padding:12px;border-radius:4px;border:1px solid var(--border);cursor:pointer;transition:all .15s;background:var(--surface);text-align:center}
.order-card:hover{border-color:var(--accent)}
.order-card.selected{border-color:var(--accent);background:rgba(59,130,246,.06);box-shadow:inset 0 0 0 1px var(--accent)}
.order-card .oc-icon{font-size:1.3rem;margin-bottom:4px}
.order-card .oc-name{font-weight:700;font-size:.88rem;margin-bottom:3px;color:var(--text-bright)}
.order-card .oc-desc{font-size:.68rem;color:var(--muted);line-height:1.4}

/* ── Operations Table ──────────────────────────────── */
.ops-table-active,.ops-table-history{width:100%;border-collapse:collapse;font-size:.73rem;table-layout:fixed}
.ops-table-active th,.ops-table-history th{text-align:left;color:var(--muted);font-weight:600;padding:6px 8px;border-bottom:1px solid var(--border);font-size:.6rem;text-transform:uppercase;letter-spacing:.05em;overflow:hidden;background:var(--surface);position:sticky;top:0;z-index:1}
.ops-table-active td,.ops-table-history td{padding:6px 8px;border-bottom:1px solid rgba(30,37,56,.5);vertical-align:middle;overflow:hidden;text-overflow:ellipsis}
.ops-table-active tbody tr:nth-child(even) td,.ops-table-history tbody tr:nth-child(even) td{background:rgba(255,255,255,.015)}
.ops-table-active tbody tr:hover td,.ops-table-history tbody tr:hover td{background:rgba(59,130,246,.04)}
/* Active table: 7 columns */
.ops-table-active colgroup .ca-par{width:18%}.ops-table-active colgroup .ca-tipo{width:6%}.ops-table-active colgroup .ca-entry{width:14%}.ops-table-active colgroup .ca-sl{width:13%}.ops-table-active colgroup .ca-tp{width:13%}.ops-table-active colgroup .ca-estado{width:16%}.ops-table-active colgroup .ca-acc{width:20%}
/* History table: 8 columns */
.ops-table-history colgroup .ch-fecha{width:12%}.ops-table-history colgroup .ch-par{width:12%}.ops-table-history colgroup .ch-lado{width:6%}.ops-table-history colgroup .ch-entry{width:13%}.ops-table-history colgroup .ch-exit{width:13%}.ops-table-history colgroup .ch-pnl{width:18%}.ops-table-history colgroup .ch-tipo{width:8%}.ops-table-history colgroup .ch-receta{width:18%}
.ops-section-title{font-size:.82rem;font-weight:800;color:var(--text);margin:18px 0 8px;display:flex;align-items:center;gap:8px}
.ops-section-title:first-child{margin-top:0}
.ops-section-count{font-size:.65rem;font-weight:600;color:var(--muted);background:rgba(59,130,246,.06);padding:2px 6px;border-radius:3px;font-family:var(--mono)}
.pnl-value{font-size:.82rem;font-weight:700;font-family:var(--mono)}
.pnl-value.positive{color:var(--buy)}.pnl-value.negative{color:var(--sell)}
.pnl-abs{font-size:.62rem;color:var(--muted);font-family:var(--mono);margin-top:1px}
.ops-badge{display:inline-block;padding:2px 6px;border-radius:3px;font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.03em}
.ops-badge.filled{background:rgba(34,197,94,.12);color:var(--buy)}
.ops-badge.active{background:rgba(59,130,246,.12);color:var(--accent);animation:pulse-active 2.5s infinite}
.ops-badge.active-waiting{background:rgba(245,158,11,.12);color:var(--hold);animation:pulse-active 2.5s infinite}
.ops-badge.closed-tp{background:rgba(34,197,94,.15);color:var(--buy)}
.ops-badge.closed-sl{background:rgba(239,68,68,.15);color:var(--sell)}
.ops-badge.closed-manual{background:rgba(59,130,246,.12);color:var(--accent)}
@keyframes pulse-active{0%,100%{opacity:1}50%{opacity:.65}}
.ops-badge.failed{background:rgba(239,68,68,.12);color:var(--sell)}
.ops-badge.invalid{background:rgba(249,115,22,.12);color:#f97316}
.ops-side-buy{color:var(--buy);font-weight:700;font-family:var(--mono)}.ops-side-sell{color:var(--sell);font-weight:700;font-family:var(--mono)}
.ops-table-active tbody tr.data-row,.ops-table-history tbody tr.data-row{cursor:pointer;transition:background .1s}
.ops-table-active tbody tr.data-row:hover td,.ops-table-history tbody tr.data-row:hover td{background:rgba(59,130,246,.05)}
.ops-expand-icon{display:inline-block;transition:transform .15s;margin-right:3px;font-size:.55rem;color:var(--muted)}
.ops-expand-icon.open{transform:rotate(90deg)}
.price-diff{font-size:.56rem;margin-left:2px;font-weight:600}.price-diff.positive{color:var(--buy)}.price-diff.negative{color:var(--sell)}
.detail-panel{padding:12px 10px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;background:var(--surface)}
.detail-section{padding:8px;border-radius:4px;background:rgba(59,130,246,.03);border:1px solid rgba(59,130,246,.08)}
.detail-section-title{font-size:.58rem;text-transform:uppercase;color:var(--accent);font-weight:700;margin-bottom:4px;letter-spacing:.05em}
.detail-row-item{display:flex;justify-content:space-between;margin-bottom:2px;font-size:.68rem}
.detail-row-item .dl{color:var(--muted)}.detail-row-item .dv{font-family:var(--mono);font-weight:600}
.detail-full{grid-column:1/-1}
.ops-empty{text-align:center;padding:40px;color:var(--muted)}
.ops-empty-icon{font-size:2.5rem;margin-bottom:10px;opacity:.4}
.ops-refresh{cursor:pointer;font-size:.9rem;opacity:.6;transition:opacity .2s;background:none;border:none;color:var(--text);margin-left:10px}
.ops-refresh:hover{opacity:1}

/* ── Trade Tracking ────────────────────────────────── */
.track-row td{background:var(--surface)!important;padding:0!important;border-bottom:2px solid var(--border)}
.track-panel{padding:12px 10px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
.track-header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;margin-bottom:2px}
.track-eval{display:inline-block;padding:3px 8px;border-radius:3px;font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.04em;font-family:var(--mono)}
.track-eval.ganancia{background:rgba(34,197,94,.12);color:var(--buy)}
.track-eval.perdida{background:rgba(239,68,68,.12);color:var(--sell)}
.track-eval.sl{background:rgba(239,68,68,.2);color:var(--sell)}
.track-eval.tp{background:rgba(34,197,94,.2);color:var(--buy)}
.track-eval.neutral{background:rgba(59,130,246,.1);color:var(--accent)}
.track-metric{text-align:center;padding:8px;border-radius:4px;background:rgba(59,130,246,.03);border:1px solid rgba(59,130,246,.08)}
.track-metric-label{font-size:.6rem;text-transform:uppercase;color:var(--muted);margin-bottom:3px;letter-spacing:.04em}
.track-metric-value{font-size:1rem;font-weight:700;font-family:var(--mono)}
.track-bar-wrap{grid-column:1/-1;padding:6px 0}
.track-bar-labels{display:flex;justify-content:space-between;font-size:.62rem;color:var(--muted);margin-bottom:4px;font-family:var(--mono)}
.track-bar{position:relative;height:6px;border-radius:3px;background:linear-gradient(90deg,rgba(239,68,68,.2),rgba(59,130,246,.06) 50%,rgba(34,197,94,.2))}
.track-bar-marker{position:absolute;top:-3px;width:3px;height:12px;border-radius:1px;background:var(--text-bright);transform:translateX(-50%);transition:left .3s}
.track-bar-entry{position:absolute;top:-3px;width:1px;height:12px;background:var(--accent);opacity:.5;transform:translateX(-50%)}
.track-actions{grid-column:1/-1;display:flex;gap:6px;align-items:center;justify-content:flex-end}
.track-actions button{font-size:.68rem;padding:4px 10px}
.track-elapsed{font-size:.68rem;color:var(--muted);font-family:var(--mono)}
.track-auto{font-size:.65rem;color:var(--accent);cursor:pointer;background:none;border:1px solid var(--accent);border-radius:3px;padding:3px 8px;font-weight:600;transition:all .15s}
.track-auto.active{background:var(--accent);color:#fff}
.track-btn{cursor:pointer;font-size:.78rem;opacity:.6;background:none;border:none;color:var(--accent);padding:1px 3px;transition:opacity .15s;line-height:1}
.track-btn:hover{opacity:1}

.sync-auto{font-size:.65rem;color:var(--accent);cursor:pointer;background:none;border:1px solid var(--accent);border-radius:3px;padding:3px 8px;font-weight:600;transition:all .15s}
.sync-auto.active{background:var(--accent);color:#fff}
.del-btn{cursor:pointer;font-size:.78rem;opacity:.6;background:none;border:none;color:var(--sell);padding:1px 3px;transition:opacity .15s;line-height:1}
.del-btn:hover{opacity:1}

/* ── Analytics ─────────────────────────────────────── */
.analytics-section{margin-top:16px}
.analytics-title{font-weight:700;font-size:.88rem;margin-bottom:10px;display:flex;align-items:center;gap:8px;color:var(--text-bright)}
.analytics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin-bottom:14px}
.analytics-card{text-align:center;padding:12px 8px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius)}
.analytics-card-label{font-size:.6rem;text-transform:uppercase;color:var(--muted);letter-spacing:.05em;margin-bottom:3px}
.analytics-card-value{font-size:1.15rem;font-weight:800;font-family:var(--mono)}
.analytics-card.highlight{border-color:var(--accent);background:rgba(59,130,246,.04)}
.analytics-tabs{display:flex;gap:0;margin-bottom:10px;border-bottom:1px solid var(--border)}
.analytics-tab{padding:6px 14px;font-size:.72rem;font-weight:600;cursor:pointer;border:none;background:none;color:var(--muted);border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .15s;text-transform:uppercase;letter-spacing:.04em}
.analytics-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.analytics-table{width:100%;border-collapse:collapse;font-size:.75rem}
.analytics-table th{text-align:left;color:var(--muted);font-weight:600;padding:6px 8px;border-bottom:1px solid var(--border);font-size:.6rem;text-transform:uppercase;letter-spacing:.05em;background:var(--surface)}
.analytics-table td{padding:6px 8px;border-bottom:1px solid rgba(30,37,56,.5);font-family:var(--mono)}
.analytics-table tbody tr:nth-child(even) td{background:rgba(255,255,255,.015)}
.analytics-table .pnl-pos{color:var(--buy);font-weight:700}
.analytics-table .pnl-neg{color:var(--sell);font-weight:700}

/* ── Misc ───────────────────────────────────────────── */
.hidden{display:none!important}.mt-2{margin-top:14px}.mb-2{margin-bottom:14px}.text-center{text-align:center}
.loader{display:none;text-align:center;padding:30px}.loader.show{display:block}
.spinner{width:28px;height:28px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;margin:0 auto 10px}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
.skeleton{background:linear-gradient(90deg,var(--surface) 25%,var(--card) 50%,var(--surface) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:3px;height:12px;margin:4px 0}
.loader-text{color:var(--muted);font-size:.78rem}
.toast{position:fixed;top:16px;right:16px;max-width:380px;padding:10px 16px;border-radius:4px;font-weight:600;font-size:.78rem;z-index:999;transform:translateX(120%);opacity:0;transition:all .25s;line-height:1.4;box-shadow:0 4px 16px rgba(0,0,0,.4);border-left:3px solid}
.toast.show{transform:translateX(0);opacity:1}.toast.error{background:var(--card);color:var(--sell);border-left-color:var(--sell)}.toast.success{background:var(--card);color:var(--buy);border-left-color:var(--buy)}.toast.warn{background:var(--card);color:var(--hold);border-left-color:var(--hold)}

/* ── Flow Diagrams ─────────────────────────────────── */
.flow-selector{margin-bottom:16px}
.flow-selector select{width:100%;max-width:400px;padding:8px 12px;font-size:.85rem;border-radius:4px;background:var(--card);color:var(--text);border:1px solid var(--border)}
.flow-diagram{display:flex;flex-direction:column;align-items:center;gap:0;max-width:680px;margin:0 auto;padding-bottom:24px}
.flow-header{text-align:center;margin-bottom:16px}
.flow-header-icon{font-size:1.6rem;margin-bottom:3px}
.flow-header-name{font-size:1.05rem;font-weight:700;color:var(--text-bright)}
.flow-header-cat{font-size:.68rem;color:var(--accent);font-weight:600;text-transform:uppercase;letter-spacing:.05em;margin-top:2px}
.flow-step{width:100%;max-width:560px;border-radius:4px;padding:12px 14px;border:1px solid var(--border);position:relative;transition:border-color .15s}
.flow-step:hover{border-color:var(--accent)}
.flow-step-label{font-size:.58rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;margin-bottom:3px;display:flex;align-items:center;gap:5px}
.flow-step-label .step-num{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;font-size:.5rem;font-weight:700}
.flow-step-title{font-size:.82rem;font-weight:700;color:var(--text-bright);margin-bottom:3px}
.flow-step-body{font-size:.72rem;color:var(--muted);line-height:1.4}
.flow-step-formula{font-family:var(--mono);background:rgba(255,255,255,.03);padding:4px 8px;border-radius:3px;font-size:.68rem;color:var(--accent);margin-top:4px;display:inline-block;border:1px solid rgba(59,130,246,.12)}
.flow-step.input{background:rgba(30,144,255,.04);border-color:rgba(30,144,255,.2)}
.flow-step.input .flow-step-label{color:var(--flow-input)}
.flow-step.input .step-num{background:var(--flow-input);color:var(--btn-primary-text)}
.flow-step.calc{background:rgba(59,130,246,.03);border-color:rgba(59,130,246,.15)}
.flow-step.calc .flow-step-label{color:var(--accent)}
.flow-step.calc .step-num{background:var(--accent);color:#fff}
.flow-step.norm{background:rgba(34,197,94,.03);border-color:rgba(34,197,94,.15)}
.flow-step.norm .flow-step-label{color:var(--buy)}
.flow-step.norm .step-num{background:var(--buy);color:var(--bg)}
.flow-step.decision{background:rgba(245,158,11,.04);border-color:rgba(245,158,11,.2)}
.flow-step.decision .flow-step-label{color:var(--hold)}
.flow-step.decision .step-num{background:var(--hold);color:var(--bg)}
.flow-step.output{background:rgba(239,68,68,.03);border-color:rgba(239,68,68,.15)}
.flow-step.output .flow-step-label{color:var(--sell)}
.flow-step.output .step-num{background:var(--sell);color:#fff}
.flow-step.risk{background:rgba(139,92,246,.03);border-color:rgba(139,92,246,.15)}
.flow-step.risk .flow-step-label{color:var(--flow-risk)}
.flow-step.risk .step-num{background:var(--flow-risk);color:var(--btn-primary-text)}
.flow-arrow{display:flex;flex-direction:column;align-items:center;color:var(--border);font-size:.8rem;line-height:1;padding:3px 0}
.flow-arrow::before{content:'';display:block;width:1px;height:8px;background:var(--border)}
.flow-arrow::after{content:'';display:block;width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:6px solid var(--border)}
.flow-decision-branches{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;width:100%;max-width:560px;margin-top:0}
.flow-branch{padding:8px 10px;border-radius:4px;text-align:center;font-size:.7rem;font-weight:700;border:1px solid var(--border)}
.flow-branch.buy{background:rgba(34,197,94,.06);border-color:rgba(34,197,94,.2);color:var(--buy)}
.flow-branch.sell{background:rgba(239,68,68,.06);border-color:rgba(239,68,68,.2);color:var(--sell)}
.flow-branch.hold{background:rgba(90,100,128,.06);border-color:rgba(90,100,128,.2);color:var(--muted)}
.flow-branch-cond{font-size:.6rem;font-weight:400;color:var(--muted);margin-top:2px;display:block}
.flow-branch.active-branch{box-shadow:0 0 0 1px currentColor}
.flow-live-values{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px}
.flow-live-pill{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:3px;font-size:.65rem;font-weight:600;background:rgba(59,130,246,.06);border:1px solid rgba(59,130,246,.12);color:var(--accent);font-family:var(--mono)}
.flow-live-pill .flk{color:var(--muted);font-weight:400}
.flow-live-pill .flv{color:var(--text-bright);font-weight:700}
.flow-live-result{margin-top:6px;padding:6px 10px;border-radius:4px;font-size:.72rem;font-weight:700;text-align:center;font-family:var(--mono)}
.flow-live-result.buy{background:rgba(34,197,94,.08);border:1px solid rgba(34,197,94,.2);color:var(--buy)}
.flow-live-result.sell{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);color:var(--sell)}
.flow-live-result.hold{background:rgba(90,100,128,.08);border:1px solid rgba(90,100,128,.2);color:var(--muted)}
.flow-controls{display:flex;flex-wrap:wrap;gap:8px;align-items:end;margin-bottom:16px;padding:12px;background:var(--card);border-radius:4px;border:1px solid var(--border)}
.flow-control-group{display:flex;flex-direction:column;gap:2px}
.flow-control-group label{font-size:.6rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.05em}
.flow-control-group input,.flow-control-group select{padding:6px 10px;font-size:.8rem;border-radius:4px;background:var(--bg);color:var(--text);border:1px solid var(--border);min-width:110px;font-family:var(--mono)}
.flow-run-btn{padding:6px 20px;font-size:.78rem;font-weight:600;border-radius:4px;background:var(--accent);color:#fff;border:none;cursor:pointer;transition:all .15s;align-self:end;text-transform:uppercase;letter-spacing:.04em}
.flow-run-btn:hover{background:var(--accent-hover)}
.flow-run-btn:disabled{opacity:.35;cursor:not-allowed}
.flow-strat-card{background:var(--card);border:1px solid var(--border);border-radius:4px;padding:10px 12px;margin-bottom:6px;transition:border-color .15s}
.flow-strat-header{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.flow-strat-icon{font-size:.95rem}
.flow-strat-name{font-weight:700;font-size:.78rem;color:var(--text-bright)}
.flow-strat-role{font-size:.55rem;font-weight:700;text-transform:uppercase;padding:1px 5px;border-radius:3px;letter-spacing:.04em}
.flow-strat-role.direction{background:rgba(59,130,246,.08);color:var(--accent)}
.flow-strat-role.strength{background:rgba(245,158,11,.08);color:var(--hold)}
.flow-strat-weight{font-size:.62rem;color:var(--muted);margin-left:auto;font-family:var(--mono)}
.flow-strat-metrics{display:flex;flex-wrap:wrap;gap:3px;margin-top:4px}
.flow-strat-pill{font-size:.6rem;padding:1px 5px;border-radius:3px;background:rgba(90,100,128,.06);color:var(--muted);font-family:var(--mono)}
.flow-strat-pill .fsk{opacity:.6}.flow-strat-pill .fsv{font-weight:700;color:var(--text)}
.flow-strat-bar{height:3px;border-radius:1px;background:rgba(90,100,128,.06);position:relative;margin-top:6px;overflow:visible}
.flow-strat-bar-fill{position:absolute;top:0;height:100%;border-radius:1px;opacity:.4}
.flow-strat-bar-dot{position:absolute;top:50%;width:5px;height:5px;border-radius:50%;transform:translate(-50%,-50%);border:1px solid var(--card);box-shadow:0 0 2px rgba(0,0,0,.3)}
.flow-strat-explain{font-size:.65rem;color:var(--muted);font-style:italic;margin-top:4px;line-height:1.3}
.flow-combine-box{background:var(--card);border:1px solid var(--accent);border-radius:4px;padding:12px;margin-top:4px}
.flow-combine-title{font-size:.68rem;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px}
.flow-combine-row{display:flex;align-items:center;gap:6px;margin-bottom:4px;font-size:.72rem}
.flow-combine-label{color:var(--muted);min-width:90px;font-size:.62rem;text-transform:uppercase;letter-spacing:.04em}
.flow-combine-value{font-weight:700;font-size:.82rem;font-family:var(--mono)}
.flow-combine-formula{font-family:var(--mono);font-size:.68rem;color:var(--accent);padding:4px 8px;border-radius:3px;background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.1);margin-top:6px;text-align:center}
.flow-threshold-bar{height:4px;border-radius:2px;background:rgba(90,100,128,.06);position:relative;margin:10px 0 4px;overflow:visible}
.flow-threshold-marker{position:absolute;top:-3px;width:1px;height:10px}
.flow-threshold-label{position:absolute;bottom:-11px;transform:translateX(-50%);font-size:.48rem;font-weight:700;white-space:nowrap;font-family:var(--mono)}
.flow-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin-bottom:16px;padding:12px;background:var(--card);border-radius:4px;border:1px solid var(--border)}
.flow-summary-item{text-align:center}
.flow-summary-label{font-size:.58rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.05em}
.flow-summary-value{font-size:.95rem;font-weight:700;margin-top:2px;font-family:var(--mono)}

/* ── DEBUG ID OVERLAY ─────────────────────────────── */
.id-toggle{cursor:pointer;font-size:.65rem;font-weight:600;padding:2px 6px;border-radius:3px;border:1px solid rgba(57,255,20,.25);background:rgba(57,255,20,.04);color:var(--ticker-text);letter-spacing:.04em;user-select:none;transition:all .15s;font-family:var(--mono)}
.id-toggle:hover{background:rgba(57,255,20,.1);border-color:var(--ticker-text)}
.id-toggle.active{background:rgba(57,255,20,.15);border-color:var(--ticker-text);box-shadow:0 0 4px rgba(57,255,20,.2)}
.dbg-label{display:none;position:absolute;top:2px;right:2px;font-size:.5rem;font-weight:700;font-family:var(--mono);color:var(--bg);background:var(--ticker-text);padding:1px 4px;border-radius:2px;z-index:9999;pointer-events:none;line-height:1.2;letter-spacing:.03em;white-space:nowrap}
body.show-ids .dbg-label{display:block}
body.show-ids [data-dbg]{outline:1px dashed rgba(57,255,20,.3) !important;outline-offset:-1px}
/* ── Marketplace ──────────────────────────────────── */
.mkt-recipe-list{display:flex;flex-direction:column;gap:3px;margin-bottom:14px}
.mkt-recipe-item{display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:4px;cursor:pointer;transition:all .15s;user-select:none}
.mkt-recipe-item:hover{border-color:var(--accent);background:rgba(59,130,246,.02)}
.mkt-recipe-item.selected{border-color:var(--accent2);background:rgba(16,185,129,.04)}
.mkt-recipe-item input[type=checkbox]{accent-color:var(--accent2);width:14px;height:14px;cursor:pointer;flex-shrink:0}
.mkt-recipe-info{flex:1;min-width:0}
.mkt-recipe-name{font-weight:700;font-size:.82rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text-bright)}
.mkt-recipe-meta{font-size:.65rem;color:var(--muted);margin-top:1px;font-family:var(--mono)}
.mkt-results{margin-top:14px}
.mkt-results-table{width:100%;border-collapse:collapse;font-size:.73rem}
.mkt-results-table th{padding:6px 8px;text-align:right;font-weight:600;color:var(--muted);font-size:.6rem;text-transform:uppercase;letter-spacing:.04em;border-bottom:1px solid var(--border);white-space:nowrap;background:var(--surface)}
.mkt-results-table th:first-child{text-align:left}
.mkt-results-table td{padding:6px 8px;text-align:right;border-bottom:1px solid rgba(30,37,56,.5);white-space:nowrap;font-family:var(--mono)}
.mkt-results-table td:first-child{text-align:left;font-weight:700;font-family:inherit}
.mkt-results-table .mkt-best{color:var(--buy);font-weight:700}
.mkt-results-table .mkt-worst{color:var(--sell)}
.mkt-results-table tr:hover td{background:rgba(59,130,246,.03)}
.mkt-trades-section{margin-top:16px}
.mkt-trades-toggle{display:flex;align-items:center;gap:6px;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:4px;cursor:pointer;font-weight:600;font-size:.78rem;transition:all .15s;user-select:none;width:100%}
.mkt-trades-toggle:hover{border-color:var(--accent)}
.mkt-trades-toggle .arrow{transition:transform .15s;font-size:.65rem}
.mkt-trades-toggle.open .arrow{transform:rotate(90deg)}
.mkt-trades-body{max-height:280px;overflow-y:auto;margin-top:3px}
.mkt-trades-body table{width:100%;font-size:.68rem;border-collapse:collapse}
.mkt-trades-body th,.mkt-trades-body td{padding:4px 6px;text-align:right;border-bottom:1px solid rgba(30,37,56,.5)}
.mkt-trades-body th{font-weight:600;color:var(--muted);text-transform:uppercase;font-size:.55rem;position:sticky;top:0;background:var(--card);letter-spacing:.04em}
.mkt-trades-body th:first-child,.mkt-trades-body td:first-child{text-align:left}
.mkt-trades-body td{font-family:var(--mono)}
.mkt-note{font-size:.68rem;color:var(--hold);background:rgba(245,158,11,.04);border:1px solid rgba(245,158,11,.12);border-radius:4px;padding:8px 12px;margin-top:14px;line-height:1.4}

/* ── Theme Selector ─────────────────────────────────── */
.theme-select{width:auto;min-width:74px;padding:3px 22px 3px 8px;font-size:.65rem;font-weight:600;border-radius:3px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;font-family:inherit;appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='5'%3E%3Cpath d='M0 0l4 4 4-4' stroke='%235a6480' stroke-width='1.2' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 6px center;transition:border-color .15s}
.theme-select:hover{border-color:var(--border-hover)}
.theme-select:focus{outline:none;border-color:var(--accent)}

/* ── Mobile Bottom Navigation ───────────────────────── */
.mobile-bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;height:58px;background:var(--surface);border-top:1px solid var(--border);z-index:80;box-shadow:0 -2px 12px rgba(0,0,0,.15)}
.mobile-bottom-nav-inner{display:flex;justify-content:space-around;align-items:center;height:100%;max-width:520px;margin:0 auto;padding:0 4px}
.mob-nav-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;padding:4px 2px;background:none;border:none;color:var(--muted);font-size:.55rem;font-weight:600;cursor:pointer;min-width:48px;min-height:48px;transition:color .15s;font-family:inherit;-webkit-tap-highlight-color:transparent}
.mob-nav-btn .mob-nav-icon{font-size:1.25rem;line-height:1}
.mob-nav-btn.active{color:var(--accent)}
.mob-nav-btn:active{transform:scale(.92)}

/* ── Mobile More Drawer ─────────────────────────────── */
.mob-more-overlay{display:none;position:fixed;inset:0;background:var(--overlay-bg);z-index:85;-webkit-tap-highlight-color:transparent}
.mob-more-overlay.show{display:block}
.mob-more-drawer{position:fixed;bottom:0;left:0;right:0;background:var(--card);border-top:1px solid var(--border);border-radius:14px 14px 0 0;padding:18px 16px calc(env(safe-area-inset-bottom,0px) + 16px);z-index:86;transform:translateY(100%);transition:transform .28s cubic-bezier(.4,0,.2,1);max-height:80vh;overflow-y:auto}
.mob-more-drawer.show{transform:translateY(0)}
.mob-more-handle{width:36px;height:4px;border-radius:2px;background:var(--border-hover);margin:0 auto 14px}
.mob-more-title{font-size:.85rem;font-weight:800;color:var(--text-bright);margin-bottom:10px;letter-spacing:.01em}
.mob-more-item{display:flex;align-items:center;gap:10px;width:100%;padding:13px 10px;font-size:.85rem;font-weight:600;background:none;border:none;color:var(--text);cursor:pointer;border-radius:6px;transition:background .15s;font-family:inherit;text-align:left;-webkit-tap-highlight-color:transparent}
.mob-more-item:hover,.mob-more-item:active{background:var(--surface)}
.mob-more-item .mob-more-icon{font-size:1.15rem;width:24px;text-align:center}
.mob-more-divider{height:1px;background:var(--border);margin:8px 0}

/* ── Responsive: Desktop hidden elements ────────────── */
@media(min-width:769px){
.mobile-bottom-nav,.mob-more-overlay,.mob-more-drawer{display:none!important}
}

/* ── Responsive: Tablet & Mobile (≤768px) ───────────── */
@media(max-width:768px){
.main-tabs{display:none!important}
.mobile-bottom-nav{display:block}
.container{padding-bottom:72px!important}
.header{height:auto;min-height:42px;flex-wrap:wrap;padding:6px 12px;gap:4px}
.header-title{font-size:.78rem}
.gauss-ticker-wrap{display:none}
.header-right{font-size:.7rem;gap:6px}
.header-right .theme-select{min-width:60px;font-size:.6rem;padding:2px 18px 2px 5px}
.btn{min-height:44px;padding:10px 18px}
.btn-sm{min-height:40px;padding:8px 14px}
input,select,textarea{min-height:44px;font-size:16px!important}
.recipe-actions button{min-height:44px;min-width:44px;padding:8px 12px}
.track-btn,.del-btn{min-width:44px;min-height:44px;font-size:1rem}
.setup-toggle-btn{min-height:44px}
.analytics-tab{min-height:44px;padding:8px 14px}
.login-card{max-width:100%;margin:12px}
}

/* ── Responsive: Phone (≤600px) ─────────────────────── */
@media(max-width:600px){
.container{padding:10px 8px 72px!important;max-width:100%}
.panel-title{font-size:1rem}
.recipe-header{flex-direction:column;align-items:flex-start;gap:6px}
.detail-panel{grid-template-columns:1fr!important}
.track-panel{grid-template-columns:1fr!important}
.chart-votes{grid-template-columns:1fr!important}
.analytics-grid{grid-template-columns:repeat(2,1fr)!important}
.flow-decision-branches{grid-template-columns:1fr!important}
.flow-controls{flex-direction:column}
.flow-controls select,.flow-controls button{width:100%}
.perm-grid{grid-template-columns:repeat(2,1fr)!important}
.ifl-exec-cols{grid-template-columns:1fr!important}
.modal{width:100%!important;max-width:100%!important;height:100vh;max-height:100vh;border-radius:0!important;overflow-y:auto;border:none!important;margin:0}
.modal-overlay{align-items:stretch}
/* Tables to cards */
.approval-table,.ops-table-active,.ops-table-history,.eval-table,.analytics-table,.mkt-results-table,.mkt-trades-body{display:block!important}
.approval-table thead,.ops-table-active thead,.ops-table-history thead,.eval-table thead,.analytics-table thead,.mkt-results-table thead,.mkt-trades-body thead{display:none!important}
.approval-table tbody,.ops-table-active tbody,.ops-table-history tbody,.eval-table tbody,.analytics-table tbody,.mkt-results-table tbody,.mkt-trades-body tbody{display:block}
.approval-table colgroup,.ops-table-active colgroup,.ops-table-history colgroup,.eval-table colgroup{display:none}
.approval-table tr,.ops-table-active tr,.ops-table-history tr,.eval-table tr,.analytics-table tr,.mkt-results-table tr,.mkt-trades-body tr{display:block;padding:10px;margin-bottom:6px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius)}
.approval-table td,.ops-table-active td,.ops-table-history td,.eval-table td,.analytics-table td,.mkt-results-table td,.mkt-trades-body td{display:block;text-align:left!important;padding:3px 0;border:none!important}
.approval-table td::before,.ops-table-active td::before,.ops-table-history td::before,.eval-table td::before{content:attr(data-label);font-size:.55rem;font-weight:700;color:var(--muted);text-transform:uppercase;display:block;margin-bottom:1px;letter-spacing:.04em}
.col-hide-sm{display:block!important}
/* Card spacing */
.card{padding:12px!important}
.flow-step{padding:10px}
}

/* ── Responsive: Small phone (≤480px) ───────────────── */
@media(max-width:480px){
body{font-size:13px}
.header-title{font-size:.72rem}
.mob-nav-btn{font-size:.5rem;min-width:44px}
.mob-nav-btn .mob-nav-icon{font-size:1.15rem}
.analytics-grid{grid-template-columns:1fr!important}
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-title">CARL FRIEDRICH GAUSS</div>
  <div class="gauss-ticker-wrap" id="gaussTicker"><div class="gauss-ticker-inner" id="gaussTickerInner"></div></div>
  <div class="header-right" id="headerUser" style="display:none">
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:1px">
      <div style="display:flex;align-items:center;gap:8px">
        <span id="headerUsername"></span>
        <span class="badge badge-pending" id="headerRole"></span>
        <span class="badge badge-keys hidden" id="headerKeys">API</span>
        <span class="gear" onclick="openSettings()" title="Configurar Binance">&#9881;</span>
        <select class="theme-select" id="themeSelect" onchange="setTheme(this.value)" title="Tema visual">
          <option value="dark">&#127761; Dark</option>
          <option value="medium">&#127764; Twilight</option>
          <option value="light">&#9728;&#65039; Light</option>
        </select>
        <span class="id-toggle" id="idToggleBtn" onclick="toggleIdOverlay()" title="Mostrar/ocultar IDs de elementos">IDs</span>
        <span class="logout" onclick="logout()">Salir</span>
      </div>
      <div id="headerClock" style="font-size:.68rem;color:var(--muted);font-family:monospace;letter-spacing:.3px"></div>
    </div>
  </div>
</div>

<!-- MAIN TAB BAR (hidden until login) -->
<div class="main-tabs" id="mainTabs" style="display:none">
  <button class="main-tab active" onclick="showTab('recipes',this)">Recetas</button>
  <button class="main-tab" onclick="showTab('strategies',this)">Estrategias</button>
  <button class="main-tab" onclick="showTab('approvals',this)">Aprobaciones</button>
  <button class="main-tab" onclick="showTab('operations',this)">Operaciones</button>
  <button class="main-tab" onclick="showTab('setup',this)">Setup</button>
  <button class="main-tab" onclick="showTab('flowcharts',this)">Flujo de Calculo</button>
  <button class="main-tab" onclick="showTab('marketplace',this)">Analizador</button>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <button class="modal-close" onclick="closeSettings()">&times;</button>
    <div class="modal-title">Configuraci&oacute;n de Binance</div>
    <div class="modal-sub">Guard&aacute; tus API keys para poder ejecutar &oacute;rdenes reales. Se encriptan en la base de datos y nunca se muestran en texto plano.<br><br><strong>Importante:</strong> cre&aacute; keys con permisos de <strong>solo lectura + spot trading</strong>. No habilites retiros.</div>
    <div id="settingsStatus" style="margin-bottom:14px"></div>
    <div class="server-ip-box" id="serverIpBox" style="display:none">
      <span class="ip-label">IP del servidor:</span>
      <span class="ip-value" id="serverIpValue">...</span>
      <button class="ip-copy" id="serverIpCopy" onclick="copyServerIp()">Copiar</button>
    </div>
    <div class="form-group">
      <label>API Key<span class="hint">La key p&uacute;blica de tu cuenta de Binance.</span></label>
      <input type="text" id="cfgApiKey" placeholder="vmPUZE6mv9SD5V...">
    </div>
    <div class="form-group">
      <label>API Secret<span class="hint">El secret privado. Solo se muestra al crearlo en Binance.</span></label>
      <input type="password" id="cfgApiSecret" placeholder="NhqPtmdSJYdKjV...">
    </div>
    <div class="btn-row">
      <button class="btn btn-primary btn-sm" onclick="saveBinanceKeys()">Guardar</button>
      <button class="btn btn-outline btn-sm" onclick="deleteBinanceKeys()" style="border-color:var(--sell);color:var(--sell)">Eliminar keys</button>
      <button class="btn btn-outline btn-sm" id="btnPerms" onclick="loadPermissions()" style="display:none">Ver permisos</button>
    </div>
    <div id="permissionsSection"></div>
  </div>
</div>

<div class="container">

<!-- LOGIN -->
<div class="panel visible" id="loginPanel">
  <div class="panel-title">Bienvenido al Asistente</div>
  <div class="panel-sub">Inici&aacute; sesi&oacute;n o cre&aacute; una cuenta para empezar a operar en Binance.</div>
  <div class="card" id="loginCard">
    <h3 style="margin-bottom:14px;font-size:1.05rem">Iniciar sesi&oacute;n</h3>
    <div class="form-group"><label>Usuario</label><input type="text" id="loginUser" placeholder="tu_usuario" autocomplete="username"></div>
    <div class="form-group"><label>Contrase&ntilde;a</label><input type="password" id="loginPass" placeholder="tu contrase&ntilde;a" autocomplete="current-password"></div>
    <div class="btn-row"><button class="btn btn-primary" onclick="doLogin()">Entrar</button><button class="btn btn-outline" onclick="showRegister()">Crear cuenta</button></div>
  </div>
  <div class="card hidden" id="registerCard">
    <h3 style="margin-bottom:14px;font-size:1.05rem">Crear cuenta nueva</h3>
    <div class="form-group"><label>Usuario<span class="hint">Entre 3 y 50 caracteres.</span></label><input type="text" id="regUser" placeholder="ej: juan_trader"></div>
    <div class="form-group"><label>Contrase&ntilde;a<span class="hint">M&iacute;nimo 6 caracteres.</span></label><input type="password" id="regPass" placeholder="m&iacute;nimo 6 caracteres"></div>
    <div class="form-group"><label>Rol<span class="hint">'admin' puede aprobar y ejecutar trades reales.</span></label>
      <select id="regRole"><option value="user">Usuario</option><option value="admin">Administrador</option></select></div>
    <div class="btn-row"><button class="btn btn-primary" onclick="doRegister()">Registrarme</button><button class="btn btn-outline" onclick="showLogin()">Ya tengo cuenta</button></div>
  </div>
</div>

<!-- TAB: RECETAS -->
<div class="panel" id="tabRecipes">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
    <div class="panel-title">Mis Recetas</div>
    <div style="display:flex;align-items:center;gap:8px">
      <button class="setup-toggle-btn" id="btnAutoOnly" onclick="toggleAutoOnly()" style="font-size:.75rem;padding:5px 12px">Solo Autom&aacute;ticas: OFF</button>
      <button class="btn btn-primary btn-sm" id="btnNewRecipe" onclick="showRecipeForm()">+ Nueva receta</button>
    </div>
  </div>
  <div class="panel-sub">Configur&aacute; estrategias automatizadas. Cuando el score cruza los umbrales, se genera una recomendaci&oacute;n para aprobar.</div>

  <!-- Recipe creation form (hidden by default) -->
  <div class="card hidden" id="recipeForm">
    <h3 style="margin-bottom:14px;font-size:1rem" id="recipeFormTitle">Nueva receta</h3>
    <div class="form-group"><label>Nombre<span class="hint">Nombre descriptivo para esta receta.</span></label>
      <input type="text" id="rcpName" placeholder="Ej: BTC Tendencia 1h"></div>
    <div class="form-row-3">
      <div class="form-group">
        <label>Moneda base</label>
        <select id="rcpBase">
          <option value="BTC">BTC</option><option value="ETH">ETH</option><option value="BNB">BNB</option>
          <option value="SOL">SOL</option><option value="XRP">XRP</option><option value="DOGE">DOGE</option>
          <option value="ADA">ADA</option><option value="AVAX">AVAX</option><option value="DOT">DOT</option>
          <option value="LINK">LINK</option><option value="PEPE">PEPE</option><option value="WIF">WIF</option>
          <option value="ARB">ARB</option><option value="OP">OP</option>
          <option value="_custom">Otra...</option>
        </select>
      </div>
      <div class="form-group">
        <label>Cotizaci&oacute;n</label>
        <select id="rcpQuote"><option value="USDT">USDT</option><option value="FDUSD">FDUSD</option></select>
      </div>
    </div>
    <div class="form-group hidden" id="rcpCustomBaseGroup">
      <label>Moneda personalizada</label>
      <input type="text" id="rcpCustomBase" placeholder="SUI" style="text-transform:uppercase">
    </div>

    <label style="margin-bottom:10px">Modo de evaluaci&oacute;n<span class="hint">Define c&oacute;mo se combinan los indicadores.</span></label>
    <div class="mode-selector" id="rcpModeSelector">
      <div class="mode-card" data-mode="weighted" onclick="selectMode(this)">
        <div class="mode-icon">&#9878;</div>
        <div class="mode-name">Ponderado</div>
        <div class="mode-desc">Todos los indicadores generan un score, se ponderan por peso y se suman. La orden se ejecuta cuando el score total supera el umbral.</div>
      </div>
      <div class="mode-card" data-mode="roles" onclick="selectMode(this)">
        <div class="mode-icon">&#9881;</div>
        <div class="mode-name">Roles independientes</div>
        <div class="mode-desc">Cada indicador cumple un rol (direcci&oacute;n o fuerza). Direcci&oacute;n decide BUY/SELL, fuerza valida. Ambos deben disparar simult&aacute;neamente.</div>
      </div>
    </div>

    <label style="margin-bottom:10px">Estrategias<span class="hint">Seleccion&aacute; hasta 5 estrategias. Los pesos deben sumar 100%.</span></label>
    <div class="strat-check-grid" id="rcpStratGrid">
      <!-- Populated dynamically by loadStrategyGrid() -->
    </div>
    <div class="weight-bar-wrap" id="weightBarWrap" style="display:none">
      <div class="weight-bar-label"><span id="weightBarText">0% de 100%</span><span id="weightBarCount">0 de 5 estrategias</span></div>
      <div class="weight-bar-track"><div class="weight-bar-fill low" id="weightBarFill" style="width:0%"></div></div>
    </div>

    <div class="rcp-param-group signals">
      <div class="rpg-title">&#9899; Se&ntilde;ales (aprobaci&oacute;n)</div>
      <div class="form-row" style="grid-template-columns:1fr 1fr 1fr 1fr 1fr">
        <div class="form-group"><label><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#22c55e;margin-right:4px;vertical-align:middle"></span>Compra %<span class="hint">Score direcci&oacute;n &ge; este % dispara BUY. Color verde en barras.</span></label>
          <input type="number" id="rcpBuyTh" value="50" min="10" max="100" step="5" style="border-color:rgba(34,197,94,.3)"></div>
        <div class="form-group"><label><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#ef4444;margin-right:4px;vertical-align:middle"></span>Venta %<span class="hint">Score direcci&oacute;n &le; -este % dispara SELL. Color rojo en barras.</span></label>
          <input type="number" id="rcpSellTh" value="50" min="10" max="100" step="5" style="border-color:rgba(239,68,68,.3)"></div>
        <div class="form-group"><label><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#f59e0b;margin-right:4px;vertical-align:middle"></span>Fuerza %<span class="hint">Gate ADX para aprobaci&oacute;n. 0 = sin gate. Color naranja en barras.</span></label>
          <input type="number" id="rcpStrengthTh" value="0" min="0" max="100" step="5" style="border-color:rgba(245,158,11,.3)"></div>
        <div class="form-group"><label>Confirm (min)<span class="hint">Legacy. Usar segundos.</span></label>
          <input type="number" id="rcpConfirmMin" value="0" min="0" max="1440" step="1"></div>
        <div class="form-group"><label>Confirm (seg)<span class="hint">Segundos que la se&ntilde;al debe sostenerse. 0 = inmediato.</span></label>
          <input type="number" id="rcpConfirmSec" value="0" min="0" max="86400" step="1"></div>
      </div>
    </div>

    <div class="rcp-param-group execution">
      <div class="rpg-title">&#9889; Auto-ejecuci&oacute;n <span style="font-size:.6rem;color:var(--accent);font-weight:600">(morado en barras)</span></div>
      <!-- Umbrales auto: EMA (direccion) y ADX (fuerza) lado a lado con colores -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:0;margin-bottom:10px">
        <div style="background:rgba(59,130,246,.03);border:1px solid rgba(59,130,246,.12);border-radius:4px 0 0 8px;padding:12px">
          <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px">
            <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#3b82f6"></span>
            <span style="font-weight:800;font-size:.72rem;text-transform:uppercase;color:var(--accent)">EMA &mdash; Direcci&oacute;n</span>
          </div>
          <div class="form-group" style="margin-bottom:6px"><label>Auto direcci&oacute;n %<span class="hint">Score &ge; este % → auto. 0 = off.</span></label>
            <input type="number" id="rcpAutoTh" value="0" min="0" max="100" step="5" style="border-color:rgba(59,130,246,.4)"></div>
          <div style="font-size:.58rem;color:var(--muted);line-height:1.3;margin-top:4px">Si el score de direcci&oacute;n supera este umbral → se auto-aprueba. Marcador <span style="color:var(--accent);font-weight:700">morado</span> en la barra de direcci&oacute;n.</div>
        </div>
        <div style="background:rgba(59,130,246,.03);border:1px solid rgba(59,130,246,.12);border-radius:0 8px 8px 0;padding:12px">
          <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px">
            <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#3b82f6"></span>
            <span style="font-weight:800;font-size:.72rem;text-transform:uppercase;color:var(--accent)">ADX &mdash; Fuerza</span>
          </div>
          <div class="form-group" style="margin-bottom:6px"><label>Auto fuerza %<span class="hint">Fuerza &ge; este % + auto dir → auto. 0 = off.</span></label>
            <input type="number" id="rcpAutoStrTh" value="0" min="0" max="100" step="5" style="border-color:rgba(59,130,246,.4)"></div>
          <div style="font-size:.58rem;color:var(--muted);line-height:1.3;margin-top:4px">Fuerza ADX debe superar este umbral junto con auto direcci&oacute;n. Marcador <span style="color:var(--accent);font-weight:700">morado</span> en la barra de fuerza.</div>
        </div>
      </div>
      <!-- Cantidades y tipo de orden: Compra / Venta -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:0">
        <div style="background:rgba(34,197,94,.03);border:1px solid rgba(34,197,94,.12);border-radius:4px 0 0 8px;padding:12px">
          <div style="font-weight:800;font-size:.72rem;text-transform:uppercase;color:var(--buy);margin-bottom:8px">&#128994; Compra (BUY)</div>
          <div class="form-group" style="margin-bottom:8px"><label>Cantidad compra<span class="hint">Cantidad en quote (USDT). 0 = solo aprueba.</span></label>
            <input type="number" id="rcpBuyQty" value="0" min="0" step="any"></div>
          <div style="padding:6px 10px;background:rgba(34,197,94,.08);border:1px solid rgba(34,197,94,.2);border-radius:6px;font-weight:700;font-size:.78rem;color:var(--buy);text-align:center">OCO</div>
        </div>
        <div style="background:rgba(239,68,68,.03);border:1px solid rgba(239,68,68,.12);border-radius:0 8px 8px 0;padding:12px">
          <div style="font-weight:800;font-size:.72rem;text-transform:uppercase;color:var(--sell);margin-bottom:8px">&#128308; Venta (SELL)</div>
          <div class="form-group" style="margin-bottom:8px"><label>Cantidad venta<span class="hint">Cantidad en moneda base. 0 = solo aprueba.</span></label>
            <input type="number" id="rcpSellQty" value="0" min="0" step="any"></div>
          <div style="padding:6px 10px;background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);border-radius:6px;font-weight:700;font-size:.78rem;color:var(--sell);text-align:center">OCO</div>
        </div>
      </div>
    </div>

    <div class="rcp-param-group risk">
      <div class="rpg-title">&#128737; Gesti&oacute;n de riesgo</div>
      <div class="form-row" style="grid-template-columns:1fr 1fr 1fr">
        <div class="form-group"><label>Max orden %<span class="hint">% m&aacute;ximo del balance.</span></label>
          <input type="number" id="rcpMaxPct" value="5" min="0.1" max="100" step="0.1"></div>
        <div class="form-group"><label>Stop-Loss %<span class="hint">Distancia SL desde entrada.</span></label>
          <input type="number" id="rcpSlPct" value="2" min="0.1" max="50" step="0.1"></div>
        <div class="form-group"><label>Take-Profit %<span class="hint">Distancia TP desde entrada.</span></label>
          <input type="number" id="rcpTpPct" value="4" min="0.1" max="100" step="0.1"></div>
      </div>
    </div>

    <div class="rcp-param-group eval-grp">
      <div class="rpg-title">&#128200; Evaluaci&oacute;n</div>
      <div class="form-row" style="grid-template-columns:1fr 1fr 1fr">
        <div class="form-group"><label>Intervalo<span class="hint">Cada cu&aacute;nto se ejecutan las estrategias.</span></label>
          <select id="rcpInterval"><option value="1m">1 min</option><option value="5m">5 min</option><option value="15m">15 min</option><option value="1h" selected>1 hora</option><option value="4h">4 horas</option><option value="1d">1 d&iacute;a</option></select></div>
        <div class="form-group"><label>Per&iacute;odo hist&oacute;rico<span class="hint">D&iacute;as de datos a analizar.</span></label>
          <select id="rcpLookback"><option value="1">1 d&iacute;a</option><option value="3">3 d&iacute;as</option><option value="7" selected>7 d&iacute;as</option><option value="14">14 d&iacute;as</option><option value="30">30 d&iacute;as</option></select></div>
        <div class="form-group"><label>Turbo %<span class="hint">Si |score| &ge; este %, eval&uacute;a cada 15s. 0 = off.</span></label>
          <input type="number" id="rcpTurboTh" value="0" min="0" max="100" step="5"></div>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-primary" id="recipeFormSaveBtn" onclick="saveRecipe()">Guardar receta</button>
      <button class="btn btn-outline" onclick="hideRecipeForm()">Cancelar</button>
    </div>
  </div>

  <div class="loader" id="recipesLoader"><div class="spinner"></div><div class="loader-text">Cargando recetas...</div></div>
  <div id="recipesContent"></div>
</div>

<!-- TAB: ESTRATEGIAS -->
<div class="panel" id="tabStrategies">
  <div class="panel-title">Estrategias disponibles</div>
  <div class="panel-sub">Todas las estrategias de an&aacute;lisis que pod&eacute;s usar en tus recetas. Cada una analiza el mercado de forma diferente.</div>
  <div class="loader" id="strategiesLoader"><div class="spinner"></div><div class="loader-text">Cargando estrategias...</div></div>
  <div id="strategiesContent" class="strat-catalog"></div>
</div>

<!-- TAB: APROBACIONES -->
<div class="panel" id="tabApprovals">
  <div class="panel-title">Aprobaciones</div>
  <div class="panel-sub">Recomendaciones generadas autom&aacute;ticamente por las recetas activas. Aprob&aacute; o rechaz&aacute; antes de ejecutar.</div>
  <div class="analytics-tabs" id="approvalTabs">
    <button class="analytics-tab active" onclick="showApprovalTab('pending',this)">Pendientes</button>
    <button class="analytics-tab" onclick="showApprovalTab('history',this)">Historial</button>
  </div>
  <div id="approvalPendingTab">
    <div class="loader" id="approvalsLoader"><div class="spinner"></div><div class="loader-text">Cargando aprobaciones...</div></div>
    <div id="approvalsContent"></div>
  </div>
  <div id="approvalHistoryTab" style="display:none">
    <div class="loader" id="historyLoader"><div class="spinner"></div><div class="loader-text">Cargando historial...</div></div>
    <div id="historyContent"></div>
  </div>
  <!-- Execution panel (appears after approving) -->
  <div class="card hidden" id="execPanel">
    <h3 style="margin-bottom:12px;font-size:1rem">Ejecutar orden</h3>
    <div id="execNoKeysWarn" class="hidden" style="padding:12px;background:rgba(239,68,68,.08);border:1px solid var(--sell);border-radius:4px;margin-bottom:14px;text-align:center">
      <div style="font-weight:700;color:var(--sell);margin-bottom:4px">API Keys no configuradas</div>
      <button class="btn btn-primary btn-sm" onclick="openSettings()">Configurar</button>
    </div>
    <label style="margin-bottom:10px">Tipo de orden</label>
    <div class="order-grid">
      <div class="order-card selected" data-otype="market" onclick="selectExecOrderType('market',this)">
        <div class="oc-icon">&#128177;</div><div class="oc-name">Mercado</div>
        <div class="oc-desc">Compra/venta al precio actual.</div>
      </div>
      <div class="order-card" data-otype="oco" onclick="selectExecOrderType('oco',this)">
        <div class="oc-icon">&#128737;&#65039;</div><div class="oc-name">OCO</div>
        <div class="oc-desc">Mercado + TP/SL autom&aacute;ticos.</div>
      </div>
      <div class="order-card" data-otype="limit" onclick="selectExecOrderType('limit',this)">
        <div class="oc-icon">&#128203;</div><div class="oc-name">Limit</div>
        <div class="oc-desc">Orden l&iacute;mite al precio de entrada.</div>
      </div>
    </div>
    <div id="execBalanceBox" class="hidden" style="padding:12px;background:var(--surface);border-radius:4px;margin-bottom:14px">
      <div style="font-size:.7rem;color:var(--muted);text-transform:uppercase;font-weight:700;margin-bottom:6px">Saldo disponible en Binance</div>
      <div id="execBalanceContent" style="display:flex;gap:16px;flex-wrap:wrap"></div>
    </div>
    <div class="form-group"><label>Cantidad<span class="hint" id="execQtyHint">En la moneda base.</span></label>
      <input type="number" id="execQty" step="any" min="0.00001" value="0.01"></div>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="doExecFromApprovals()">Ejecutar orden</button>
      <button class="btn btn-outline" onclick="hideExecPanel()">Cancelar</button>
    </div>
    <div class="loader" id="execLoader"><div class="spinner"></div><div class="loader-text">Enviando a Binance...</div></div>
  </div>
</div>

<!-- TAB: OPERACIONES -->
<div class="panel" id="tabOperations">
  <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px">
    <div class="panel-title">Mis operaciones</div>
    <button class="ops-refresh" onclick="loadOperations()" title="Refrescar">&#8635;</button>
    <button class="ops-refresh" onclick="syncOperations()" title="Sincronizar con Binance" id="syncBtn" style="font-size:.72rem;padding:2px 8px;border:1px solid var(--accent);border-radius:4px;color:var(--accent)">&#8645; Sync</button>
    <select id="syncInterval" style="width:auto;padding:2px 6px;font-size:.7rem;border-radius:4px;border:1px solid var(--border);background:var(--card);color:var(--text)" title="Intervalo de auto-sync">
      <option value="0">Manual</option><option value="15000">15s</option><option value="30000" selected>30s</option><option value="60000">1m</option><option value="300000">5m</option><option value="600000">10m</option>
    </select>
    <button class="sync-auto" id="syncAutoBtn" onclick="toggleAutoSync()" title="Activar/desactivar auto-sync">Auto</button>
    <span id="syncStatus" style="font-size:.65rem;color:var(--muted)"></span>
  </div>
  <div class="analytics-tabs" id="opsTabs">
    <button class="analytics-tab active" onclick="showOpsTab('operations',this)">Operaciones</button>
    <button class="analytics-tab" onclick="showOpsTab('analytics',this)">Analiticas</button>
  </div>
  <div id="opsTabContent">
    <div class="panel-sub">Historial de operaciones ejecutadas en tu cuenta de Binance.</div>
    <div class="loader" id="opsLoader"><div class="spinner"></div><div class="loader-text">Cargando operaciones...</div></div>
    <div id="opsContent"></div>
  </div>
  <div id="analyticsTabContent" style="display:none">
    <div class="panel-sub">Resumen de ganancias y perdidas de tus operaciones cerradas.</div>
    <div class="loader" id="analyticsLoader"><div class="spinner"></div><div class="loader-text">Calculando analiticas...</div></div>
    <div id="analyticsPanel"></div>
  </div>
</div>

<!-- TAB: SETUP -->
<div class="panel" id="tabSetup">
  <div class="panel-title">Setup de Estrategias</div>
  <div class="panel-sub">Habilit&aacute; las estrategias verificadas para que est&eacute;n disponibles en las recetas. Solo un administrador puede cambiar el estado.</div>
  <div class="loader" id="setupLoader"><div class="spinner"></div><div class="loader-text">Cargando configuraci&oacute;n...</div></div>
  <div id="setupContent" class="setup-grid"></div>
</div>

<!-- TAB: FLUJO DE CALCULO -->
<div class="panel" id="tabFlowcharts">
  <div class="panel-title">Flujo de c&aacute;lculo</div>
  <div class="panel-sub">Visualiz&aacute; paso a paso c&oacute;mo se combinan las estrategias de cada receta. Seleccion&aacute; una receta y ejecut&aacute; en vivo.</div>
  <div class="flow-controls">
    <div class="flow-control-group">
      <label>Receta</label>
      <select id="flowRecipeSelect" style="min-width:220px">
        <option value="">-- Cargando recetas --</option>
      </select>
    </div>
    <div class="flow-control-group">
      <label>Estrategia individual (opcional)</label>
      <select id="flowStratSelect" onchange="_flowLiveData=null;document.getElementById('flowSummaryContainer').innerHTML='';renderFlowDiagram(this.value)" style="min-width:200px">
        <option value="">-- Ver receta completa --</option>
      </select>
    </div>
    <button class="flow-run-btn" id="flowRunBtn" onclick="runFlowLive()">&#9654; Ejecutar en vivo</button>
  </div>
  <div id="flowSummaryContainer"></div>
  <div id="flowDiagramContainer"></div>
</div>

</div>
<!-- TAB: ANALIZADOR DE RECETAS -->
<div class="panel" id="tabMarketplace">
  <div style="max-width:900px;margin:0 auto">
    <div class="panel-title">Analizador de Recetas</div>
    <div class="panel-sub">Seleccion&aacute; las recetas que quer&eacute;s comparar y ve&aacute; cu&aacute;l fue m&aacute;s eficiente en operaciones reales.</div>
    <div style="max-width:720px;margin:0 auto">
      <div class="loader" id="mktLoader"><div class="spinner"></div><div class="loader-text">Cargando recetas...</div></div>
      <div id="mktRecipeList" class="mkt-recipe-list"></div>
      <button class="btn btn-primary btn-sm" id="btnMktCompare" onclick="runMktCompare()" style="margin-top:8px" disabled>Comparar seleccionadas</button>
    </div>
    <div id="mktResults" class="mkt-results"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ── THEME SYSTEM ──────────────────────────────────── */
function setTheme(t){document.documentElement.setAttribute('data-theme',t);try{localStorage.setItem('gauss-theme',t)}catch(e){}var s=document.getElementById('themeSelect');if(s)s.value=t;var m=document.getElementById('mobThemeSelect');if(m)m.value=t}
function loadSavedTheme(){var t='dark';try{t=localStorage.getItem('gauss-theme')||'dark'}catch(e){}setTheme(t)}
loadSavedTheme();

/* ── MOBILE NAVIGATION ─────────────────────────────── */
var _moreDrawerOpen=false;
function mobNavTo(tab){showTab(tab);toggleMoreDrawer(false)}
function updateMobileNav(){var btns=document.querySelectorAll('.mob-nav-btn');var moreTabs=['strategies','flowcharts','marketplace'];btns.forEach(function(b){var t=b.getAttribute('data-tab');if(t==='more'){b.classList.toggle('active',moreTabs.indexOf(currentTab)>=0)}else{b.classList.toggle('active',t===currentTab)}})}
function toggleMoreDrawer(forceClose){if(forceClose===false||_moreDrawerOpen){_moreDrawerOpen=false;document.getElementById('mobMoreOverlay').classList.remove('show');document.getElementById('mobMoreDrawer').classList.remove('show')}else{_moreDrawerOpen=true;document.getElementById('mobMoreOverlay').classList.add('show');document.getElementById('mobMoreDrawer').classList.add('show')}}

let TOKEN=null,USER=null,currentTab='recipes';
let _strategyCache=null;
const STRATEGY_LABELS={A:{name:'Prediccion (AR)',icon:'\ud83d\udcc8',color:'#2196f3'},B:{name:'Tendencia (Kalman)',icon:'\ud83d\udd2c',color:'#00bcd4'},C:{name:'Reversion (OU)',icon:'\ud83d\udd04',color:'#9c27b0'},D:{name:'EMA Crossover',icon:'\u2702\ufe0f',color:'#1e90ff'},E:{name:'RSI (Fuerza)',icon:'\ud83d\udcca',color:'#e91e63'},F:{name:'MACD (Momentum)',icon:'\ud83d\udcc9',color:'#ff5722'},G:{name:'Bollinger Bands',icon:'\ud83c\udf0a',color:'#00e5ff'},H:{name:'Breakout (Canal)',icon:'\ud83d\ude80',color:'#ff6d00'},I:{name:'ATR Trailing Stop',icon:'\ud83d\udee1\ufe0f',color:'#76ff03'},J:{name:'ADX (Tendencia)',icon:'\ud83d\udcaa',color:'#ff9800'},K:{name:'Fear & Greed',icon:'\ud83d\ude28',color:'#ffd600'},L:{name:'Pendiente EMA',icon:'\ud83d\udcd0',color:'#4caf50'},M:{name:'Claude AI',icon:'\ud83e\udde0',color:'#a78bfa'}};

/* ── DEBUG ID OVERLAY ────────────────────────────────── */
let _idsVisible=false;
function toggleIdOverlay(){
  _idsVisible=!_idsVisible;
  document.body.classList.toggle('show-ids',_idsVisible);
  document.getElementById('idToggleBtn').classList.toggle('active',_idsVisible);
  if(_idsVisible)injectDbgLabels();
  else document.querySelectorAll('.dbg-label').forEach(function(el){el.remove()});
}
function injectDbgLabels(){
  document.querySelectorAll('.dbg-label').forEach(function(el){el.remove()});
  document.querySelectorAll('[data-dbg]').forEach(function(el){el.removeAttribute('data-dbg')});
  var selectors=[
    '.header','.main-tabs','.main-tab','.panel','.panel-title','.panel-sub',
    '.recipe-card','.recipe-header','.recipe-name','.recipe-badge','.recipe-strats',
    '.recipe-score-wrap','.recipe-config','.rc-chip','.recipe-form','.rcp-param-group',
    '.rpg-title','.form-group','.form-row','.strat-slot','.strat-check',
    '.weight-bar-track','.weight-bar-fill','.btn-row',
    '.inline-thresholds','.inline-th-group','.inline-th-save',
    '.chart-panel','.chart-signal-wrap','.chart-signal-badge','.chart-signal-label',
    '.chart-signal-explain','.chart-votes','.chart-vote-row','.chart-vote-card',
    '.chart-vote-header','.chart-vote-name','.chart-vote-signal','.chart-vote-bar',
    '.chart-vote-meta','.chart-vote-score','.chart-vote-prices','.chart-vote-explain',
    '.chart-prices-grid','.chart-trend','.chart-section-title',
    '.modal-overlay','.modal','.modal-title',
    '.card','.approval-card','.setup-card','.setup-card-badge','.setup-toggle-btn',
    '.strat-catalog-card','.strat-catalog',
    '.ops-table-active','.ops-table-history','.analytics-table',
    '.flow-section','.flow-summary','.flow-summary-item',
    '.loader','.btn','.badge',
    '#headerUsername','#headerRole','#headerKeys','#headerClock',
    '#idToggleBtn','.gear','.logout','.toast',
    'input[type="number"]','input[type="text"]','input[type="password"]',
    'select','textarea',
  ];
  var n=100;
  selectors.forEach(function(sel){
    document.querySelectorAll(sel).forEach(function(el){
      if(el.getAttribute('data-dbg'))return;
      var id=String(n);
      n++;
      el.setAttribute('data-dbg',id);
      var isVoid=el.tagName==='INPUT'||el.tagName==='SELECT'||el.tagName==='TEXTAREA';
      var host=isVoid?el.parentElement:el;
      if(host&&getComputedStyle(host).position==='static')host.style.position='relative';
      var tag=document.createElement('span');
      tag.className='dbg-label';
      tag.textContent=id;
      if(host)host.appendChild(tag);
    });
  });
}

/* ── TAB NAVIGATION ──────────────────────────────────── */
function showTab(tab,btn){
  if(currentTab==='operations'){stopAllTracking();stopAutoSync()}
  currentTab=tab;
  document.querySelectorAll('.main-tab').forEach(t=>t.classList.remove('active'));
  if(btn)btn.classList.add('active');
  else document.querySelector('.main-tab[onclick*="\''+tab+'\'"]').classList.add('active');
  document.getElementById('tabRecipes').classList.toggle('visible',tab==='recipes');
  document.getElementById('tabStrategies').classList.toggle('visible',tab==='strategies');
  document.getElementById('tabApprovals').classList.toggle('visible',tab==='approvals');
  document.getElementById('tabOperations').classList.toggle('visible',tab==='operations');
  document.getElementById('tabSetup').classList.toggle('visible',tab==='setup');
  document.getElementById('tabFlowcharts').classList.toggle('visible',tab==='flowcharts');
  document.getElementById('tabMarketplace').classList.toggle('visible',tab==='marketplace');
  if(tab==='recipes'){loadAutoOnlyState();loadRecipes();}
  if(tab==='strategies')loadStrategies();
  if(tab==='approvals')loadPendingApprovals();
  if(tab==='operations')loadOperations();
  if(tab==='setup')loadSetup();
  if(tab==='flowcharts')initFlowTab();
  if(tab==='marketplace')loadMarketplace();
  updateMobileNav();
}

/* ── AUTH ─────────────────────────────────────────────── */
function showRegister(){document.getElementById('loginCard').classList.add('hidden');document.getElementById('registerCard').classList.remove('hidden')}
function showLogin(){document.getElementById('registerCard').classList.add('hidden');document.getElementById('loginCard').classList.remove('hidden')}
async function doLogin(){
  var u=document.getElementById('loginUser').value.trim(),p=document.getElementById('loginPass').value;
  if(!u||!p)return toast('Completa usuario y contrasena','error');
  try{var r=await api('POST','/auth/login',{username:u,password:p},false);TOKEN=r.access_token;
    var payload=JSON.parse(atob(TOKEN.split('.')[1]));USER={id:payload.user_id,username:u,role:payload.role};
    await loadBinanceStatus();onAuth();
  }catch(e){toast('Error de login: '+e.message,'error')}
}
async function doRegister(){
  var u=document.getElementById('regUser').value.trim(),p=document.getElementById('regPass').value,role=document.getElementById('regRole').value;
  if(!u||!p)return toast('Completa todos los campos','error');
  try{await api('POST','/auth/register',{username:u,password:p,role},false);toast('Cuenta creada correctamente','success');
    var r=await api('POST','/auth/login',{username:u,password:p},false);TOKEN=r.access_token;
    var payload=JSON.parse(atob(TOKEN.split('.')[1]));USER={id:payload.user_id,username:u,role:payload.role};
    USER.hasKeys=false;onAuth();
  }catch(e){toast('Error de registro: '+e.message,'error')}
}
function onAuth(){
  document.getElementById('headerUser').style.display='flex';
  document.getElementById('headerUsername').textContent=USER.username;
  const rb=document.getElementById('headerRole');rb.textContent=USER.role==='admin'?'ADMIN':'USUARIO';
  rb.className='badge '+(USER.role==='admin'?'badge-approved':'badge-pending');
  const kb=document.getElementById('headerKeys');if(USER.hasKeys){kb.classList.remove('hidden');kb.textContent='API \u2713'}else{kb.classList.add('hidden')}
  document.getElementById('loginPanel').classList.remove('visible');
  document.getElementById('mainTabs').style.display='flex';
  toast('Sesi\u00f3n iniciada como '+USER.username,'success');
  _startClock();
  startNotifPoller();
  showTab('recipes');
}
function logout(){
  TOKEN=null;USER=null;stopAllTracking();stopAutoSync();stopNotifPoller();_stopClock();
  document.getElementById('headerUser').style.display='none';
  document.getElementById('mainTabs').style.display='none';
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('visible'));
  document.getElementById('loginPanel').classList.add('visible');
}

/* ── BINANCE CONFIG ──────────────────────────────────── */
async function loadBinanceStatus(){
  try{const r=await api('GET','/settings/binance');USER.hasKeys=r.configured;
    document.getElementById('settingsStatus').innerHTML=r.configured
      ?'<span class="badge badge-keys">Configurado: '+r.api_key_hint+'</span>'
      :'<span style="color:var(--muted);font-size:.82rem">Sin API keys configuradas</span>';
    document.getElementById('btnPerms').style.display=r.configured?'inline-flex':'none';
    if(!r.configured)document.getElementById('permissionsSection').innerHTML='';
  }catch(e){USER.hasKeys=false}
}
function openSettings(){document.getElementById('settingsModal').classList.add('show');loadBinanceStatus();loadServerIp()}
function closeSettings(){document.getElementById('settingsModal').classList.remove('show')}
async function loadServerIp(){
  try{const r=await api('GET','/settings/server-ip');
    document.getElementById('serverIpValue').textContent=r.server_ip;
    document.getElementById('serverIpBox').style.display='flex';
  }catch(e){document.getElementById('serverIpBox').style.display='none'}
}
function copyServerIp(){
  const ip=document.getElementById('serverIpValue').textContent;
  navigator.clipboard.writeText(ip).then(()=>{
    const btn=document.getElementById('serverIpCopy');btn.textContent='\u2713 Copiado';btn.classList.add('copied');
    setTimeout(()=>{btn.textContent='Copiar';btn.classList.remove('copied')},2000);
  });
}
async function saveBinanceKeys(){
  const k=document.getElementById('cfgApiKey').value.trim(),s=document.getElementById('cfgApiSecret').value.trim();
  if(!k||!s)return toast('Completa API Key y Secret','error');
  try{await api('POST','/settings/binance',{api_key:k,api_secret:s});USER.hasKeys=true;
    document.getElementById('cfgApiKey').value='';document.getElementById('cfgApiSecret').value='';
    var kb=document.getElementById('headerKeys');kb.classList.remove('hidden');kb.textContent='API \u2713';
    await loadBinanceStatus();toast('API keys guardadas correctamente','success');
  }catch(e){toast('Error guardando keys: '+e.message,'error')}
}
async function deleteBinanceKeys(){
  try{await api('DELETE','/settings/binance');USER.hasKeys=false;
    document.getElementById('headerKeys').classList.add('hidden');
    await loadBinanceStatus();toast('API keys eliminadas','success');
  }catch(e){toast('Error eliminando keys: '+e.message,'error')}
}
async function loadPermissions(){
  const sec=document.getElementById('permissionsSection');
  sec.innerHTML='<div class="perm-loader"><div class="spinner" style="width:24px;height:24px;border-width:3px;margin-bottom:6px"></div>Consultando permisos...</div>';
  try{
    const p=await api('GET','/settings/binance/permissions');
    const defs=[{key:'enableReading',name:'Lectura',icon:'\ud83d\udcd6',warn:false},{key:'enableSpotAndMarginTrading',name:'Spot Trading',icon:'\ud83d\udcb1',warn:false},{key:'enableMargin',name:'Margin',icon:'\ud83d\udcc8',warn:false},{key:'enableFutures',name:'Futuros',icon:'\ud83d\udd2e',warn:false},{key:'enableWithdrawals',name:'Retiros',icon:'\u26a0\ufe0f',warn:true},{key:'enableInternalTransfer',name:'Transferencias',icon:'\ud83d\udd04',warn:false},{key:'enableVanillaOptions',name:'Opciones',icon:'\ud83c\udfaf',warn:false},{key:'ipRestrict',name:'Restricci\u00f3n IP',icon:'\ud83d\udd12',secure:true}];
    let html='<div class="perm-grid">';
    for(const d of defs){const val=p[d.key];if(val===undefined)continue;const on=!!val;let cls='perm-card ';
      if(d.secure){cls+=on?'perm-secure':'perm-off'}else if(d.warn&&on){cls+='perm-warn'}else{cls+=on?'perm-on':'perm-off'}
      html+='<div class="'+cls+'"><div class="perm-icon">'+d.icon+'</div><div class="perm-info"><div class="perm-name">'+d.name+'</div><div class="perm-status">'+(on?'Habilitado':'Deshabilitado')+'</div></div></div>'}
    html+='</div>';
    if(p.createTime){const dt=new Date(p.createTime);html+='<div class="perm-created">Key creada: '+dt.toLocaleDateString('es-AR')+'</div>'}
    sec.innerHTML=html;
  }catch(e){sec.innerHTML='<div style="color:var(--sell);font-size:.82rem;margin-top:12px">Error: '+e.message+'</div>'}
}

/* ── STRATEGIES TAB ──────────────────────────────────── */
async function loadStrategies(){
  var loader=document.getElementById('strategiesLoader');
  var content=document.getElementById('strategiesContent');
  loader.classList.add('show');content.innerHTML='';
  try{
    var strats=await api('GET','/strategies/');
    _strategyCache=null; /* invalidate so recipe grid re-fetches enabled-only */
    loader.classList.remove('show');
    if(!strats.length){content.innerHTML='<div style="text-align:center;color:var(--muted);padding:30px">No hay estrategias disponibles</div>';return}
    var html='';
    for(var s of strats){
      html+='<div class="strat-catalog-card" id="strat-card-'+s.key+'">'
        +'<div class="strat-catalog-header">'
        +'<div class="strat-catalog-icon">'+s.icon+'</div>'
        +'<div><span class="strat-catalog-name">'+s.name+'</span><span class="strat-catalog-key">'+s.key+'</span></div>'
        +'</div>'
        +(s.category?'<div class="strat-catalog-category">'+s.category+'</div>':'')
        +'<div class="strat-catalog-desc">'+s.short_desc+'</div>'
        +(s.example?'<div class="strat-catalog-example"><strong>Ejemplo:</strong> '+s.example+'</div>':'')
        +'<div class="strat-catalog-tags">'
        +'<span class="strat-catalog-tag works">&#9989; '+s.when_works+'</span>'
        +'<span class="strat-catalog-tag fails">&#9888;&#65039; '+s.when_fails+'</span>'
        +'</div>'
        +'<div class="strat-catalog-params">'+s.param_count+' par\u00e1metros configurables</div>'
        +'<button class="strat-catalog-toggle" onclick="toggleStratDetail(\''+s.key+'\')">Ver par\u00e1metros y consejos</button>'
        +'<div class="strat-params-detail" id="strat-detail-'+s.key+'"></div>'
        +'</div>';
    }
    content.innerHTML=html;
  }catch(e){loader.classList.remove('show');toast('Error cargando estrategias: '+e.message,'error')}
}

/* ── SETUP TAB ─────────────────────────────────────── */
async function loadSetup(){
  var loader=document.getElementById('setupLoader');
  var content=document.getElementById('setupContent');
  loader.classList.add('show');content.innerHTML='';
  try{
    var configs=await api('GET','/setup/strategies');
    loader.classList.remove('show');
    if(!configs.length){content.innerHTML='<div style="text-align:center;color:var(--muted);padding:30px">No hay estrategias configuradas</div>';return}
    var isAdmin=USER&&USER.role==='admin';
    var html='';
    for(var s of configs){
      var stateClass=s.enabled?'enabled':'disabled';
      var badgeClass=s.enabled?'on':'off';
      var badgeText=s.enabled?'HABILITADA':'DESHABILITADA';
      html+='<div class="setup-card '+stateClass+'" id="setup-'+s.key+'">'
        +'<div class="setup-card-header">'
        +'<div class="setup-card-icon">'+s.icon+'</div>'
        +'<div><span class="setup-card-name">'+s.name+'</span>'
        +'<span class="setup-card-key">'+s.key+'</span></div>'
        +'</div>'
        +(s.category?'<div class="setup-card-category">'+s.category+'</div>':'')
        +'<div class="setup-card-desc">'+s.short_desc+'</div>'
        +'<div class="setup-card-status">'
        +'<span class="setup-card-badge '+badgeClass+'">'+badgeText+'</span>';
      if(isAdmin){
        html+='<button class="setup-toggle-btn" onclick="toggleSetupStrategy(\''+s.key+'\')">'
          +(s.enabled?'Deshabilitar':'Habilitar')+'</button>';
      }
      html+='</div></div>';
    }
    content.innerHTML=html;
  }catch(e){loader.classList.remove('show');toast('Error cargando setup: '+e.message,'error')}
}

async function toggleSetupStrategy(key){
  try{
    var result=await api('POST','/setup/strategies/'+key+'/toggle');
    toast('Estrategia '+key+': '+(result.enabled?'habilitada':'deshabilitada'),'success');
    _strategyCache=null;
    loadSetup();
  }catch(e){toast('Error: '+e.message,'error')}
}

async function toggleStratDetail(key){
  var div=document.getElementById('strat-detail-'+key);
  if(!div)return;
  if(div.classList.contains('show')){div.classList.remove('show');return}
  if(!div.innerHTML){
    try{
      var detail=await api('GET','/strategies/'+key);
      var h='<div style="padding:12px;background:var(--card);border-radius:4px;font-size:.82rem;line-height:1.6;color:var(--muted);margin-bottom:14px">'
        +'<strong style="color:var(--text)">Como funciona:</strong><br>'+detail.long_desc+'</div>';
      for(var pkey in detail.default_params){
        var p=detail.default_params[pkey];
        var valStr=p.options?p.options.join(' | '):String(p.value);
        var rangeStr='';
        if(p.min!==undefined&&p.max!==undefined)rangeStr=' ('+p.min+' \u2013 '+p.max+')';
        h+='<div class="strat-param-row"><div style="flex:1">'
          +'<div class="strat-param-name">'+pkey+'</div>'
          +'<div class="strat-param-desc">'+p.desc+'</div>'
          +(p.tip?'<div class="strat-param-tip">&#128161; '+p.tip+'</div>':'')
          +'</div><div class="strat-param-val">'+valStr+rangeStr+'</div></div>';
      }
      div.innerHTML=h;
    }catch(e){div.innerHTML='<div style="color:var(--sell);font-size:.82rem">'+e.message+'</div>'}
  }
  div.classList.add('show');
}

var _strategyDetailCache={};
async function loadStrategyGrid(){
  var grid=document.getElementById('rcpStratGrid');
  if(!grid)return;
  try{
    var strats=_strategyCache||await api('GET','/strategies/');
    _strategyCache=strats;
    var h='';
    for(var s of strats){
      h+='<div class="strat-check" data-strat="'+s.key+'" onclick="toggleStrat(this)">'
        +'<div class="sc-icon">'+s.icon+'</div><div class="sc-name">'+s.name+'</div>'
        +'<div class="sc-desc">'+s.short_desc.substring(0,60)+'</div>'
        +'<div class="sc-weight"><label style="font-size:.65rem">Peso %</label><input type="number" class="strat-weight" value="0" min="0" max="100" step="1" onclick="event.stopPropagation()" oninput="updateWeightBar()"></div>'
        +'<div class="sc-role"><label style="font-size:.65rem">Rol</label><select class="strat-role" onclick="event.stopPropagation()"><option value="direction">Direcci\u00f3n (compra/venta)</option><option value="strength">Fuerza (amplifica/aten\u00faa)</option></select></div>'
        +'<div class="sc-params-btn"><button onclick="event.stopPropagation();openParamsEditor(\''+s.key+'\')">&#9881; Editar par\u00e1metros</button></div>'
        +'</div>';
    }
    grid.innerHTML=h;
    document.getElementById('weightBarWrap').style.display='none';
  }catch(e){console.error('loadStrategyGrid error:',e);grid.innerHTML='<div style="color:var(--sell);font-size:.78rem">Error cargando estrategias: '+e.message+'</div>'}
}

async function openParamsEditor(key){
  var existing=document.getElementById('spe-'+key);
  if(existing){
    existing.classList.toggle('show');
    return;
  }
  try{
    if(!_strategyDetailCache[key]){
      _strategyDetailCache[key]=await api('GET','/strategies/'+key);
    }
    var detail=_strategyDetailCache[key];
    var h='<h4>'+detail.icon+' '+detail.name+' \u2014 Par\u00e1metros</h4><div class="spe-grid">';
    for(var pkey in detail.default_params){
      var p=detail.default_params[pkey];
      h+='<div class="spe-field">';
      h+='<label>'+pkey+'</label>';
      if(p.options){
        h+='<select data-param="'+pkey+'">';
        for(var opt of p.options){
          h+='<option value="'+opt+'"'+(opt===p.value?' selected':'')+'>'+opt+'</option>';
        }
        h+='</select>';
      }else if(typeof p.value==='boolean'){
        h+='<select data-param="'+pkey+'">'
          +'<option value="false"'+(!p.value?' selected':'')+'>No</option>'
          +'<option value="true"'+(p.value?' selected':'')+'>Si</option>'
          +'</select>';
      }else{
        h+='<input type="number" data-param="'+pkey+'" value="'+p.value+'"'
          +(p.min!==undefined?' min="'+p.min+'"':'')
          +(p.max!==undefined?' max="'+p.max+'"':'')
          +(p.step!==undefined?' step="'+p.step+'"':' step="any"')+'>';
        if(p.min!==undefined&&p.max!==undefined) h+='<div class="spe-range">Rango: '+p.min+' \u2013 '+p.max+'</div>';
      }
      h+='<div class="spe-tip">'+p.desc+'</div>';
      h+='</div>';
    }
    h+='</div><button class="spe-reset" onclick="resetParams(\''+key+'\')">Restaurar valores por defecto</button>';
    var card=document.querySelector('.strat-check[data-strat="'+key+'"]');
    var editor=document.createElement('div');
    editor.className='strat-params-editor show';
    editor.id='spe-'+key;
    editor.innerHTML=h;
    card.parentNode.insertBefore(editor,card.nextSibling);
  }catch(e){toast('Error cargando par\u00e1metros: '+e.message,'error')}
}

function resetParams(key){
  var detail=_strategyDetailCache[key];
  if(!detail)return;
  var editor=document.getElementById('spe-'+key);
  if(!editor)return;
  for(var pkey in detail.default_params){
    var p=detail.default_params[pkey];
    var input=editor.querySelector('[data-param="'+pkey+'"]');
    if(input)input.value=typeof p.value==='boolean'?String(p.value):p.value;
  }
  toast('Par\u00e1metros restaurados','success');
}

function collectStrategyParams(){
  var params={};
  /* When editing, start from existing recipe params so we don't lose them */
  if(_editingRecipeId&&_editingRecipeParams){
    for(var k in _editingRecipeParams)params[k]=Object.assign({},_editingRecipeParams[k]);
  }
  var editors=document.querySelectorAll('.strat-params-editor.show');
  editors.forEach(function(editor){
    var key=editor.id.replace('spe-','');
    var detail=_strategyDetailCache[key];
    if(!detail)return;
    var changed={};
    var hasChanges=false;
    editor.querySelectorAll('[data-param]').forEach(function(input){
      var pkey=input.dataset.param;
      var p=detail.default_params[pkey];
      if(!p)return;
      var val;
      if(p.options){
        val=input.value;
      }else if(typeof p.value==='boolean'){
        val=input.value==='true';
      }else{
        val=parseFloat(input.value);
      }
      if(val!==p.value){
        changed[pkey]=val;
        hasChanges=true;
      }
    });
    if(hasChanges)params[key]=changed;
    else delete params[key]; /* Remove if reset to defaults */
  });
  return Object.keys(params).length?params:null;
}

/* ── RECIPES TAB ─────────────────────────────────────── */
var _editingRecipeId=null;
var _editingRecipeParams=null;
var _selectedMode=null;

function selectMode(el){
  document.querySelectorAll('.mode-card').forEach(function(c){c.classList.remove('selected')});
  el.classList.add('selected');
  _selectedMode=el.dataset.mode;
  applyModeUI(_selectedMode);
}
function applyModeUI(mode){
  /* In weighted mode: hide role selectors and strength threshold */
  var form=document.getElementById('recipeForm');
  if(!form)return;
  if(mode==='weighted'){form.classList.add('mode-weighted')}
  else{form.classList.remove('mode-weighted')}
  var strThField=document.getElementById('rcpStrengthTh');
  if(strThField){
    var strThGroup=strThField.closest('.form-group');
    if(strThGroup){strThGroup.style.display=mode==='weighted'?'none':''}
    if(mode==='weighted')strThField.value='0';
  }
  var autoStrThField=document.getElementById('rcpAutoStrTh');
  if(autoStrThField){
    var autoStrThGroup=autoStrThField.closest('.form-group');
    if(autoStrThGroup){autoStrThGroup.style.display=mode==='weighted'?'none':''}
    if(mode==='weighted')autoStrThField.value='0';
  }
}

function showRecipeForm(){
  _editingRecipeId=null;
  _editingRecipeParams=null;
  _selectedMode=null;
  document.querySelectorAll('.mode-card').forEach(function(c){c.classList.remove('selected')});
  document.getElementById('recipeForm').classList.remove('mode-weighted');
  var strThG=document.getElementById('rcpStrengthTh');
  if(strThG){var g=strThG.closest('.form-group');if(g)g.style.display=''}
  document.getElementById('recipeFormTitle').textContent='Nueva receta';
  document.getElementById('recipeFormSaveBtn').textContent='Guardar receta';
  document.getElementById('recipeForm').classList.remove('hidden');
  document.getElementById('btnNewRecipe').classList.add('hidden');
  loadStrategyGrid();
}
function hideRecipeForm(){
  _editingRecipeId=null;
  _editingRecipeParams=null;
  _selectedMode=null;
  document.getElementById('recipeForm').classList.add('hidden');
  document.getElementById('recipeForm').classList.remove('mode-weighted');
  document.getElementById('btnNewRecipe').classList.remove('hidden');
  document.querySelectorAll('.strat-params-editor').forEach(function(e){e.remove()});
  document.querySelectorAll('.mode-card').forEach(function(c){c.classList.remove('selected')});
  document.getElementById('weightBarWrap').style.display='none';
}
async function editRecipe(id){
  /* Fetch recipe list to get data */
  var recipes=await api('GET','/recipe/');
  var r=recipes.find(function(x){return x.id===id});
  if(!r){toast('Receta no encontrada','error');return}
  _editingRecipeId=id;
  _editingRecipeParams=r.strategy_params||null;
  document.getElementById('recipeFormTitle').textContent='Editar receta';
  document.getElementById('recipeFormSaveBtn').textContent='Guardar cambios';
  document.getElementById('recipeForm').classList.remove('hidden');
  document.getElementById('btnNewRecipe').classList.add('hidden');
  await loadStrategyGrid();
  /* Fill mode */
  _selectedMode=r.mode||null;
  document.querySelectorAll('.mode-card').forEach(function(c){c.classList.remove('selected')});
  if(r.mode){
    var modeCard=document.querySelector('.mode-card[data-mode="'+r.mode+'"]');
    if(modeCard){modeCard.classList.add('selected')}
    applyModeUI(r.mode);
  }
  /* Fill form fields */
  document.getElementById('rcpName').value=r.name;
  /* Parse symbol into base + quote */
  var quote='USDT';
  var base=r.symbol;
  if(r.symbol.endsWith('FDUSD')){quote='FDUSD';base=r.symbol.replace(/FDUSD$/,'');}
  else if(r.symbol.endsWith('USDT')){quote='USDT';base=r.symbol.replace(/USDT$/,'');}
  var baseSel=document.getElementById('rcpBase');
  var found=false;
  for(var i=0;i<baseSel.options.length;i++){
    if(baseSel.options[i].value===base){baseSel.value=base;found=true;break}
  }
  if(!found){baseSel.value='_custom';document.getElementById('rcpCustomBaseGroup').classList.remove('hidden');document.getElementById('rcpCustomBase').value=base;}
  else{document.getElementById('rcpCustomBaseGroup').classList.add('hidden')}
  document.getElementById('rcpQuote').value=quote;
  document.getElementById('rcpInterval').value=r.interval;
  document.getElementById('rcpLookback').value=String(r.lookback_days);
  /* Select strategies and set weights */
  document.querySelectorAll('.strat-check').forEach(function(el){el.classList.remove('selected');el.querySelector('.strat-weight').value=0});
  r.strategies.forEach(function(s){
    var el=document.querySelector('.strat-check[data-strat="'+s.strategy+'"]');
    if(el){
      el.classList.add('selected');
      el.querySelector('.strat-weight').value=Math.round(s.weight*100);
      el.querySelector('.strat-role').value=s.role||'direction';
    }
  });
  updateWeightBar();
  /* Thresholds */
  document.getElementById('rcpBuyTh').value=Math.round(r.buy_threshold*100);
  document.getElementById('rcpSellTh').value=Math.round(r.sell_threshold*100);
  document.getElementById('rcpStrengthTh').value=Math.round((r.strength_threshold||0)*100);
  document.getElementById('rcpAutoTh').value=Math.round((r.auto_threshold||0)*100);
  document.getElementById('rcpAutoStrTh').value=Math.round((r.auto_strength_threshold||0)*100);
  document.getElementById('rcpBuyQty').value=r.buy_quantity||0;
  document.getElementById('rcpSellQty').value=r.sell_quantity||0;
  document.getElementById('rcpTurboTh').value=Math.round((r.turbo_threshold||0)*100);
  document.getElementById('rcpConfirmMin').value=r.confirmation_minutes||0;
  document.getElementById('rcpConfirmSec').value=r.confirmation_seconds||0;
  document.getElementById('rcpMaxPct').value=r.max_order_pct;
  document.getElementById('rcpSlPct').value=r.stop_loss_pct;
  document.getElementById('rcpTpPct').value=r.take_profit_pct;
  /* Open param editors for ALL selected strategies */
  for(var si=0;si<r.strategies.length;si++){
    var sk=r.strategies[si].strategy;
    await openParamsEditor(sk);
    /* Pre-fill with custom values if they exist */
    if(r.strategy_params&&r.strategy_params[sk]){
      var editor=document.getElementById('spe-'+sk);
      if(editor){
        var customVals=r.strategy_params[sk];
        for(var pk in customVals){
          var input=editor.querySelector('[data-param="'+pk+'"]');
          if(input)input.value=typeof customVals[pk]==='boolean'?String(customVals[pk]):customVals[pk];
        }
      }
    }
  }
  /* Scroll to form */
  document.getElementById('recipeForm').scrollIntoView({behavior:'smooth',block:'start'});
}
function toggleStrat(el){
  var selected=document.querySelectorAll('.strat-check.selected');
  if(!el.classList.contains('selected')){
    if(selected.length>=5){toast('Maximo 5 estrategias por receta','warn');return}
    el.classList.add('selected');
    /* Auto-distribute weights evenly */
    var newCount=selected.length+1;
    var each=Math.floor(100/newCount);
    var remainder=100-each*newCount;
    document.querySelectorAll('.strat-check.selected').forEach(function(card,i){
      card.querySelector('.strat-weight').value=(i===0?each+remainder:each);
    });
    el.querySelector('.strat-weight').value=each;
  }else{
    el.classList.remove('selected');
    el.querySelector('.strat-weight').value=0;
    /* Redistribute among remaining */
    var remaining=document.querySelectorAll('.strat-check.selected');
    if(remaining.length>0){
      var each2=Math.floor(100/remaining.length);
      var rem2=100-each2*remaining.length;
      remaining.forEach(function(card,i){
        card.querySelector('.strat-weight').value=(i===0?each2+rem2:each2);
      });
    }
  }
  updateWeightBar();
}
function updateWeightBar(){
  var selected=document.querySelectorAll('.strat-check.selected');
  var wrap=document.getElementById('weightBarWrap');
  if(!selected.length){wrap.style.display='none';return}
  wrap.style.display='block';
  var total=0;
  selected.forEach(function(card){total+=parseInt(card.querySelector('.strat-weight').value)||0});
  var pct=Math.min(total,100);
  var fill=document.getElementById('weightBarFill');
  fill.style.width=pct+'%';
  fill.className='weight-bar-fill '+(total===100?'ok':total>100?'over':'low');
  document.getElementById('weightBarText').textContent=total+'% de 100%';
  document.getElementById('weightBarCount').textContent=selected.length+' de 5 estrategias';
}
document.getElementById('rcpBase').addEventListener('change',function(){document.getElementById('rcpCustomBaseGroup').classList.toggle('hidden',this.value!=='_custom')});

async function saveRecipe(){
  var base=document.getElementById('rcpBase').value;
  if(base==='_custom')base=document.getElementById('rcpCustomBase').value.trim().toUpperCase();
  var quote=document.getElementById('rcpQuote').value;
  if(!base)return toast('Selecciona una moneda base','error');
  var symbol=base+quote;
  var name=document.getElementById('rcpName').value.trim();
  if(!name)return toast('Ingresa un nombre para la receta','error');
  var selected=document.querySelectorAll('.strat-check.selected');
  if(!selected.length)return toast('Selecciona al menos una estrategia de la grilla','error');
  if(selected.length>5)return toast('Maximo 5 estrategias por receta','error');
  var strategies=[];
  var weightSum=0;
  selected.forEach(function(el){
    var w=parseInt(el.querySelector('.strat-weight').value)||0;
    var role=el.querySelector('.strat-role').value||'direction';
    weightSum+=w;
    strategies.push({strategy:el.dataset.strat,weight:w,role:role});
  });
  if(Math.abs(weightSum-100)>1)return toast('Los pesos deben sumar 100%. Actualmente suman '+weightSum+'%','error');
  var buyThPct=parseFloat(document.getElementById('rcpBuyTh').value);
  var sellThPct=parseFloat(document.getElementById('rcpSellTh').value);
  var autoThPct=parseFloat(document.getElementById('rcpAutoTh').value);
  var buyQty=parseFloat(document.getElementById('rcpBuyQty').value)||0;
  var sellQty=parseFloat(document.getElementById('rcpSellQty').value)||0;
  var strengthThPct=parseFloat(document.getElementById('rcpStrengthTh').value)||0;
  var autoStrThPct=parseFloat(document.getElementById('rcpAutoStrTh').value)||0;
  var turboThPct=parseFloat(document.getElementById('rcpTurboTh').value)||0;
  var confirmMin=parseFloat(document.getElementById('rcpConfirmMin').value)||0;
  var confirmSec=parseInt(document.getElementById('rcpConfirmSec').value)||0;
  var maxPct=parseFloat(document.getElementById('rcpMaxPct').value);
  var slPct=parseFloat(document.getElementById('rcpSlPct').value);
  var tpPct=parseFloat(document.getElementById('rcpTpPct').value);
  if(isNaN(buyThPct)||buyThPct<10||buyThPct>100)return toast('Umbral de compra debe estar entre 10% y 100%','error');
  if(isNaN(sellThPct)||sellThPct<10||sellThPct>100)return toast('Umbral de venta debe estar entre 10% y 100%','error');
  if(isNaN(strengthThPct)||strengthThPct<0||strengthThPct>100)return toast('Umbral de fuerza debe estar entre 0% y 100%','error');
  if(isNaN(autoThPct)||autoThPct<0||autoThPct>100)return toast('Umbral de auto-aprobacion debe estar entre 0% y 100%','error');
  if(isNaN(confirmMin)||confirmMin<0||confirmMin>1440)return toast('Confirmación debe estar entre 0 y 1440 minutos','error');
  if(autoThPct>0&&(autoThPct<buyThPct||autoThPct<sellThPct))return toast('El umbral de auto-aprobacion debe ser >= que los umbrales de compra y venta','error');
  if((_selectedMode||'roles')==='roles'){
    var hasStrength=strategies.some(function(s){return s.role==='strength'});
    if((strengthThPct>0||autoStrThPct>0)&&!hasStrength)return toast('Configuraste umbrales de fuerza pero ninguna estrategia tiene rol "Fuerza". Cambiá el rol de al menos una (ej: ADX) a "Fuerza"','error');
  }
  if(isNaN(maxPct)||maxPct<0.1||maxPct>100)return toast('Max orden % debe estar entre 0.1 y 100','error');
  if(isNaN(slPct)||slPct<0.1||slPct>50)return toast('Stop-Loss % debe estar entre 0.1 y 50','error');
  if(isNaN(tpPct)||tpPct<0.1||tpPct>100)return toast('Take-Profit % debe estar entre 0.1 y 100','error');
  var stratParams=collectStrategyParams();
  var payload={
    name:name,symbol:symbol,strategies:strategies,
    interval:document.getElementById('rcpInterval').value,
    lookback_days:parseInt(document.getElementById('rcpLookback').value),
    buy_threshold:buyThPct/100,
    sell_threshold:sellThPct/100,
    auto_threshold:autoThPct/100,
    buy_quantity:buyQty>0?buyQty:null,
    sell_quantity:sellQty>0?sellQty:null,
    buy_order_type:'oco',
    sell_order_type:'oco',
    strength_threshold:strengthThPct/100,
    auto_strength_threshold:autoStrThPct/100,
    turbo_threshold:turboThPct/100,
    confirmation_minutes:confirmMin,
    confirmation_seconds:confirmSec,
    max_order_pct:maxPct,
    stop_loss_pct:slPct,
    take_profit_pct:tpPct,
    mode:_selectedMode||null
  };
  if(stratParams)payload.strategy_params=stratParams;
  else if(_editingRecipeId)payload.strategy_params=null;
  try{
    if(_editingRecipeId){
      await api('PATCH','/recipe/'+_editingRecipeId,payload);
      toast('Receta "'+name+'" actualizada','success');
    }else{
      await api('POST','/recipe/',payload);
      toast('Receta "'+name+'" creada correctamente','success');
    }
    hideRecipeForm();loadRecipes();
  }catch(e){
    toast(e.message,'error');
  }
}

// ── Auto-only mode ─────────────────────────────────────────────────
let _autoOnly = false;
async function loadAutoOnlyState(){
  try{
    const r = await api('GET','/settings/auto-only');
    _autoOnly = r.auto_only;
    _updateAutoOnlyBtn();
  }catch(e){}
}
function _updateAutoOnlyBtn(){
  const btn = document.getElementById('btnAutoOnly');
  if(!btn) return;
  if(_autoOnly){
    btn.textContent = 'Solo Autom\u00e1ticas: ON';
    btn.style.background = 'rgba(59,130,246,.18)';
    btn.style.borderColor = 'var(--accent)';
    btn.style.color = 'var(--accent)';
  } else {
    btn.textContent = 'Solo Autom\u00e1ticas: OFF';
    btn.style.background = 'var(--surface)';
    btn.style.borderColor = 'var(--border)';
    btn.style.color = 'var(--text)';
  }
}
async function toggleAutoOnly(){
  try{
    const r = await api('POST','/settings/auto-only',{auto_only:!_autoOnly});
    _autoOnly = r.auto_only;
    _updateAutoOnlyBtn();
    toast(_autoOnly ? 'Solo Autom\u00e1ticas activado' : 'Solo Autom\u00e1ticas desactivado','success');
    loadRecipes();
  }catch(e){toast('Error: '+e.message,'error')}
}

async function loadRecipes(){
  const loader=document.getElementById('recipesLoader');
  const content=document.getElementById('recipesContent');
  const _scrollY=window.scrollY;
  loader.classList.add('show');
  try{
    const recipes=await api('GET','/recipe/');
    loader.classList.remove('show');
    if(!recipes.length){
      content.innerHTML='<div class="ops-empty"><div class="ops-empty-icon">&#128203;</div>'
        +'<div style="font-weight:700;margin-bottom:4px">No ten\u00e9s recetas</div>'
        +'<div style="font-size:.82rem;color:var(--muted)">Cre\u00e1 una receta para empezar a analizar autom\u00e1ticamente.</div></div>';
      return;
    }
    let html='';
    for(const r of recipes){
      const statusCls=r.status==='active'?'active':'inactive';
      const statusText=r.status==='active'?'ACTIVA':'INACTIVA';
      const stratBadges=r.strategies.map(s=>{
        const lb=STRATEGY_LABELS[s.strategy]||{name:s.strategy,icon:''};
        const hasCustom=r.strategy_params&&r.strategy_params[s.strategy];
        const roleTag=r.mode!=='weighted'&&s.role==='strength'?' <span style="font-size:.55rem;opacity:.7;text-transform:uppercase">fuerza</span>':'';
        return '<span class="recipe-strat-badge"'+(hasCustom?' title="Par\u00e1metros personalizados" style="border:1px solid var(--accent)"':'')+'>'+lb.icon+' '+lb.name+' ('+Math.round(s.weight*100)+'%)'+roleTag+(hasCustom?' \u2699':'')+'</span>';
      }).join('');
      const lastEval=r.last_evaluated_at?_localDt(r.last_evaluated_at):'Nunca';
      // Per-strategy bars + combined final bar
      var scorePct=r.last_score!=null?Math.round(r.last_score*100):null;
      var buyTh=Math.round(r.buy_threshold*100);
      var sellTh=Math.round(r.sell_threshold*100);
      var autoTh=r.auto_threshold>0?Math.round(r.auto_threshold*100):0;
      var strTh=r.strength_threshold>0?Math.round(r.strength_threshold*100):0;
      var scoreBar='';
      var confReq=r.confirmation_required_secs||0;
      var confElapsed=r.confirmation_elapsed_secs||0;
      var dirSt=r.last_direction_status||'HOLD';
      var strSt=r.last_strength_status||'';
      var wasTriggered=r.last_triggered||false;
      var sigActive=r.last_signal==='BUY'||r.last_signal==='SELL';
      var confPct=confReq>0?Math.min(Math.round(confElapsed/confReq*100),100):0;
      var confFull=confReq>0&&confElapsed>=confReq;
      var autoStrTh=r.auto_strength_threshold>0?Math.round(r.auto_strength_threshold*100):0;
      /*
       * Codigo de colores:
       *   Verde  (#22c55e / --buy)   = umbral compra / aprobado
       *   Rojo   (#ef4444 / --sell)  = umbral venta
       *   Naranja(#f59e0b / --hold)  = fuerza gate (aprobacion)
       *   Morado (#3b82f6 / --accent)= auto-ejecucion
       */
      // ── Per-strategy bars ──
      if(r.last_strategy_results&&r.last_strategy_results.length){
        scoreBar+='<div style="margin:8px 0 4px">';
        for(var si=0;si<r.last_strategy_results.length;si++){
          var sr=r.last_strategy_results[si];
          var slb=STRATEGY_LABELS[sr.strategy]||{name:sr.strategy,icon:'',color:'var(--muted)'};
          var stColor=slb.color||'var(--muted)';
          if(sr.force!=null){
            /* ══════ FUERZA bar: 0 → 100 ══════ */
            var fPct=Math.round((sr.force||0)*100);
            var gateOk=strTh>0&&fPct>=strTh;
            var autoOk=autoStrTh>0&&fPct>=autoStrTh;
            scoreBar+='<div style="margin-bottom:8px;padding:8px 10px 10px;border-radius:4px;background:rgba(90,100,128,.03);border:1px solid rgba(90,100,128,.08)">';
            /* Header: nombre + valor actual */
            scoreBar+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">'
              +'<span style="font-size:.65rem;font-weight:800;color:'+stColor+';text-transform:uppercase">'+slb.icon+' '+slb.name+' <span style="font-size:.55rem;font-weight:600;opacity:.7">FUERZA</span></span>'
              +'<span style="font-size:.7rem;font-weight:900;color:'+stColor+'">'+fPct+'%</span>'
              +'</div>';
            /* Bar track */
            scoreBar+='<div class="recipe-score-track" style="height:6px">';
            /* Marcador naranja: gate aprobacion */
            if(strTh>0){
              scoreBar+='<div class="recipe-score-marker" style="left:'+strTh+'%;background:var(--hold);height:14px;top:-4px;width:2px"></div>'
                +'<div class="recipe-score-marker-label" style="left:'+strTh+'%;color:var(--hold)">Aprob. '+strTh+'%</div>';
            }
            /* Marcador morado: gate auto ejecucion */
            if(autoStrTh>0){
              scoreBar+='<div class="recipe-score-marker" style="left:'+autoStrTh+'%;background:var(--accent);height:14px;top:-4px;width:2px"></div>'
                +'<div class="recipe-score-marker-label" style="left:'+autoStrTh+'%;color:var(--accent);top:-16px">Auto '+autoStrTh+'%</div>';
            }else if(autoTh>0){
              /* Auto direccion configurado pero sin auto fuerza → mostrar aviso */
              scoreBar+='<div class="recipe-score-marker" style="left:50%;background:var(--accent);height:14px;top:-4px;width:1px;opacity:.3"></div>'
                +'<div class="recipe-score-marker-label" style="left:50%;color:var(--accent);top:-16px;opacity:.5">Auto: sin config</div>';
            }
            /* Fill + dot */
            scoreBar+='<div style="position:absolute;top:0;left:0;height:100%;width:'+fPct+'%;background:'+stColor+';opacity:.3;border-radius:3px"></div>'
              +'<div class="recipe-score-dot" style="left:'+fPct+'%;background:'+stColor+';width:9px;height:9px"></div>'
              +'</div>';
            scoreBar+='<div class="recipe-score-labels"><span>0</span><span>50</span><span>100</span></div>';
            /* Leyenda de umbrales */
            scoreBar+='<div style="display:flex;gap:10px;margin-top:4px;flex-wrap:wrap">';
            if(strTh>0){
              scoreBar+='<span style="font-size:.55rem;color:var(--hold);font-weight:700">'
                +'<span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--hold);margin-right:3px;vertical-align:middle"></span>'
                +'Aprobaci\u00f3n \u2265'+strTh+'% '+(gateOk?'\u2705':'\u274c')+'</span>';
            }
            if(autoStrTh>0){
              scoreBar+='<span style="font-size:.55rem;color:var(--accent);font-weight:700">'
                +'<span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--accent);margin-right:3px;vertical-align:middle"></span>'
                +'Auto \u2265'+autoStrTh+'% '+(autoOk?'\u26a1':'\u274c')+'</span>';
            }else if(autoTh>0){
              scoreBar+='<span style="font-size:.55rem;color:var(--accent);font-weight:600;opacity:.5">'
                +'<span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--accent);margin-right:3px;vertical-align:middle;opacity:.4"></span>'
                +'Auto fuerza: no configurado</span>';
            }
            if(!strTh&&!autoStrTh){
              scoreBar+='<span style="font-size:.55rem;color:var(--muted);font-weight:600">Sin gate de fuerza configurado</span>';
            }
            scoreBar+='</div>';
            /* Timer confirmacion */
            if(confReq>0&&sigActive){
              var strConfOk=strSt==='PASS';
              scoreBar+='<div style="display:flex;align-items:center;gap:6px;margin-top:4px;font-size:.55rem">'
                +'<span style="color:var(--muted)">&#9202; '+Math.round(confElapsed)+'s / '+confReq+'s</span>'
                +'<span style="color:'+(strConfOk?'var(--buy)':'var(--sell)')+';font-weight:700">'+(strConfOk?'CUMPLE \u2705':'INSUF. \u274c')+'</span>'
                +'</div>';
            }
            scoreBar+='</div>';
          }else{
            /* ══════ DIRECCI\u00d3N bar: -100 → +100 ══════ */
            var sPct=Math.round(sr.score*100);
            var sPos=50+sPct/2;
            var sFillL=sPct>=0?50:sPos;
            var sFillW=Math.abs(sPct)/2;
            var sColor=sPct>0?'var(--buy)':sPct<0?'var(--sell)':'var(--muted)';
            var sLabel=sr.recommendation==='BUY'?'COMPRA':sr.recommendation==='SELL'?'VENTA':'ESPERAR';
            var dirBuyOk=sPct>=buyTh;
            var dirSellOk=sPct<=-sellTh;
            var dirAutoBuyOk=autoTh>0&&sPct>=autoTh;
            var dirAutoSellOk=autoTh>0&&sPct<=-autoTh;
            scoreBar+='<div style="margin-bottom:8px;padding:8px 10px 10px;border-radius:4px;background:rgba(90,100,128,.03);border:1px solid rgba(90,100,128,.08)">';
            /* Header */
            scoreBar+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">'
              +'<span style="font-size:.65rem;font-weight:800;color:'+stColor+';text-transform:uppercase">'+slb.icon+' '+slb.name+' <span style="font-size:.55rem;font-weight:600;opacity:.7">DIRECCI\u00d3N</span></span>'
              +'<span style="font-size:.7rem;font-weight:900;color:'+sColor+'">'+(sPct>0?'+':'')+sPct+'% '+sLabel+'</span>'
              +'</div>';
            /* Bar track */
            scoreBar+='<div class="recipe-score-track" style="height:6px">'
              +'<div class="recipe-score-center" style="height:8px;top:-1px"></div>';
            /* Marcadores verdes: compra (aprobacion) */
            var bMk=50+buyTh/2;
            var sMk=50-sellTh/2;
            scoreBar+='<div class="recipe-score-marker" style="left:'+bMk+'%;background:var(--buy);height:14px;top:-4px;width:2px"></div>'
              +'<div class="recipe-score-marker-label" style="left:'+bMk+'%;color:var(--buy)">Compra '+buyTh+'%</div>';
            /* Marcadores rojos: venta (aprobacion) */
            scoreBar+='<div class="recipe-score-marker" style="left:'+sMk+'%;background:var(--sell);height:14px;top:-4px;width:2px"></div>'
              +'<div class="recipe-score-marker-label" style="left:'+sMk+'%;color:var(--sell)">Venta '+sellTh+'%</div>';
            /* Marcadores morados: auto compra y auto venta */
            if(autoTh>0){
              var abMk=50+autoTh/2;
              var asMk=50-autoTh/2;
              scoreBar+='<div class="recipe-score-marker" style="left:'+abMk+'%;background:var(--accent);height:14px;top:-4px;width:2px"></div>'
                +'<div class="recipe-score-marker-label" style="left:'+abMk+'%;color:var(--accent);top:-16px">Auto C '+autoTh+'%</div>'
                +'<div class="recipe-score-marker" style="left:'+asMk+'%;background:var(--accent);height:14px;top:-4px;width:2px"></div>'
                +'<div class="recipe-score-marker-label" style="left:'+asMk+'%;color:var(--accent);top:-16px">Auto V '+autoTh+'%</div>';
            }
            /* Fill + dot */
            scoreBar+='<div class="recipe-score-fill" style="left:'+sFillL+'%;width:'+sFillW+'%;background:'+stColor+';opacity:.3"></div>'
              +'<div class="recipe-score-dot" style="left:'+sPos+'%;background:'+sColor+';width:9px;height:9px"></div>'
              +'</div>';
            scoreBar+='<div class="recipe-score-labels"><span>-100</span><span>0</span><span>+100</span></div>';
            /* Leyenda de umbrales */
            scoreBar+='<div style="display:flex;gap:8px;margin-top:4px;flex-wrap:wrap">'
              +'<span style="font-size:.55rem;color:var(--buy);font-weight:700">'
              +'<span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--buy);margin-right:3px;vertical-align:middle"></span>'
              +'Compra \u2265'+buyTh+'% '+(dirBuyOk?'\u2705':'')+'</span>'
              +'<span style="font-size:.55rem;color:var(--sell);font-weight:700">'
              +'<span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--sell);margin-right:3px;vertical-align:middle"></span>'
              +'Venta \u2265'+sellTh+'% '+(dirSellOk?'\u2705':'')+'</span>';
            if(autoTh>0){
              scoreBar+='<span style="font-size:.55rem;color:var(--accent);font-weight:700">'
                +'<span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--accent);margin-right:3px;vertical-align:middle"></span>'
                +'Auto C \u2265'+autoTh+'% '+(dirAutoBuyOk?'\u26a1':'')+'</span>'
                +'<span style="font-size:.55rem;color:var(--accent);font-weight:700">'
                +'<span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--accent);margin-right:3px;vertical-align:middle"></span>'
                +'Auto V \u2265'+autoTh+'% '+(dirAutoSellOk?'\u26a1':'')+'</span>';
            }
            scoreBar+='</div>';
            /* Timer confirmacion */
            if(confReq>0&&sigActive){
              var dirConfOk=dirSt!=='HOLD';
              scoreBar+='<div style="display:flex;align-items:center;gap:6px;margin-top:4px;font-size:.55rem">'
                +'<span style="color:var(--muted)">&#9202; '+Math.round(confElapsed)+'s / '+confReq+'s</span>'
                +'<span style="color:'+(dirConfOk?'var(--buy)':'var(--sell)')+';font-weight:700">'+(dirSt==='BUY'?'COMPRA \u2705':dirSt==='SELL'?'VENTA \u2705':'ESPERAR \u274c')+'</span>'
                +(confFull?'<span style="font-size:.55rem;font-weight:800;color:var(--buy)">\u2705 CONFIRMADO</span>':'')
                +'</div>';
            }
            scoreBar+='</div>';
          }
        }
        scoreBar+='</div>';
      }
      // ── Trigger indicator ──
      if(wasTriggered){
        var trigSig=r.last_signal;
        var trigColor=trigSig==='BUY'?'var(--buy)':'var(--sell)';
        var trigLabel=trigSig==='BUY'?'COMPRA':'VENTA';
        var isAuto=autoTh>0&&scorePct!==null&&Math.abs(scorePct)>=autoTh;
        var trigType=isAuto?'AUTO-EJECUTADO':'PENDIENTE APROBACI\u00d3N';
        var trigIcon=isAuto?'\u26a1':'\u23f3';
        scoreBar+='<div style="margin:8px 0;padding:6px 10px;border-radius:6px;background:'+(trigSig==='BUY'?'rgba(34,197,94,.08)':'rgba(239,68,68,.08)')+';border:1px solid '+(trigSig==='BUY'?'rgba(34,197,94,.2)':'rgba(239,68,68,.2)')+';display:flex;align-items:center;justify-content:space-between">'
          +'<span style="font-size:.7rem;font-weight:800;color:'+trigColor+'">'+trigIcon+' DISPARO: '+trigLabel+'</span>'
          +'<span style="font-size:.58rem;font-weight:700;padding:2px 6px;border-radius:4px;background:'+(isAuto?'rgba(59,130,246,.15)':'rgba(255,152,0,.15)')+';color:'+(isAuto?'var(--accent)':'#ff9800')+'">'+trigType+'</span>'
          +'</div>';
      }
      // Compact config chips
      var configChips='<div class="recipe-config">'
        +'<span class="rc-chip">'+r.symbol+'</span>'
        +'<span class="rc-chip">'+r.interval+'</span>'
        +'<span class="rc-chip">'+r.lookback_days+'d</span>'
        +'<span class="rc-chip buy">BUY \u2265'+buyTh+'% OCO</span>'
        +'<span class="rc-chip sell">SELL \u2265'+sellTh+'% OCO</span>'
        +(r.mode!=='weighted'&&r.strength_threshold>0?'<span class="rc-chip strength">FUERZA \u2265'+Math.round(r.strength_threshold*100)+'%</span>':'')
        +(r.mode!=='weighted'&&r.auto_strength_threshold>0?'<span class="rc-chip" style="color:var(--accent);background:rgba(59,130,246,.08)">AUTO FUERZA \u2265'+Math.round(r.auto_strength_threshold*100)+'%</span>':'')
        +(autoTh>0?'<span class="rc-chip auto">AUTO \u2265'+autoTh+'%'+(r.buy_quantity>0?' B:'+r.buy_quantity:'')+(r.sell_quantity>0?' S:'+r.sell_quantity:'')+'</span>':'')
        +(r.turbo_threshold>0?'<span class="rc-chip turbo">TURBO \u2265'+Math.round(r.turbo_threshold*100)+'%</span>':'')
        +(r.confirmation_seconds>0?'<span class="rc-chip confirm">CONFIRM '+r.confirmation_seconds+'s</span>':r.confirmation_minutes>0?'<span class="rc-chip confirm">CONFIRM '+r.confirmation_minutes+'m</span>':'')
        +'<span class="rc-chip">SL:'+r.stop_loss_pct+'%</span>'
        +'<span class="rc-chip">TP:'+r.take_profit_pct+'%</span>'
        +'<span class="rc-chip">\u23f1 '+lastEval+'</span>'
        +'</div>';
      var modeChip='';
      if(r.mode==='weighted') modeChip='<span class="mode-chip weighted">PONDERADO</span>';
      else if(r.mode==='roles') modeChip='<span class="mode-chip roles">ROLES</span>';
      else modeChip='<span class="mode-chip nomode">SIN MODO</span>';
      let autoOnlyWarn = '';
      if(_autoOnly && (!r.auto_threshold || r.auto_threshold <= 0)){
        autoOnlyWarn='<span style="font-size:.65rem;color:var(--sell);background:rgba(239,68,68,.12);padding:2px 8px;border-radius:5px;font-weight:700">\u26A0 Sin umbral auto</span>';
      }
      html+='<div class="recipe-card" id="recipe-'+r.id+'">'
        +'<div class="recipe-header"><div class="recipe-name">'+r.name+'</div>'
        +'<div style="display:flex;align-items:center;gap:6px">'+autoOnlyWarn+modeChip+'<span class="recipe-badge '+statusCls+'">'+statusText+'</span></div></div>'
        +'<div class="recipe-strats">'+stratBadges+'</div>'
        +configChips
        +scoreBar
        +'<div class="recipe-actions">'
        +'<button onclick="editRecipe('+r.id+')">Editar</button>'
        +'<button onclick="toggleRecipe('+r.id+')">'+(r.status==='active'?'Desactivar':'Activar')+'</button>'
        +'<button onclick="showEvaluations('+r.id+')">Evaluaciones</button>'
        +(r.status==='active'?'<button class="btn-analysis" onclick="showChartPanel('+r.id+')">&#128202; An\u00e1lisis</button>':'')
        +'<button style="border-color:var(--accent);color:var(--accent)" onclick="toggleRecipeParams('+r.id+')">&#9881; Par\u00e1metros</button>'
        +'<button class="btn-danger" onclick="deleteRecipe('+r.id+')">Eliminar</button>'
        +'</div>'
        +'<div style="display:flex;align-items:center;gap:8px;margin-top:8px;padding:8px 10px;background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.08);border-radius:4px;font-size:.72rem">'
        +'<span style="color:var(--muted);white-space:nowrap">L\u00edmite ops:</span>'
        +'<input type="number" min="0" max="1000" value="'+(r.max_ops_count||0)+'" style="width:50px;padding:4px 6px;font-size:.72rem;border-radius:4px;border:1px solid var(--border);background:var(--card);color:var(--text);text-align:center" id="ops-count-'+r.id+'">'
        +'<span style="color:var(--muted)">en</span>'
        +'<select style="padding:4px 6px;font-size:.72rem;border-radius:4px;border:1px solid var(--border);background:var(--card);color:var(--text)" id="ops-hours-'+r.id+'">'
        +'<option value="1"'+(r.max_ops_hours==1?' selected':'')+'>1h</option>'
        +'<option value="4"'+(r.max_ops_hours==4?' selected':'')+'>4h</option>'
        +'<option value="8"'+(r.max_ops_hours==8?' selected':'')+'>8h</option>'
        +'<option value="12"'+(r.max_ops_hours==12?' selected':'')+'>12h</option>'
        +'<option value="24"'+(!r.max_ops_hours||r.max_ops_hours==24?' selected':'')+'>24h</option>'
        +'<option value="48"'+(r.max_ops_hours==48?' selected':'')+'>48h</option>'
        +'<option value="168"'+(r.max_ops_hours==168?' selected':'')+'>7d</option>'
        +'</select>'
        +'<button style="padding:4px 10px;font-size:.68rem;border-radius:4px;border:1px solid var(--accent);color:var(--accent);background:none;cursor:pointer;font-weight:700" onclick="saveOpsLimit('+r.id+')">Guardar</button>'
        +'<span style="color:var(--muted);font-size:.65rem">'+(r.max_ops_count>0?'('+r.ops_used+'/'+r.max_ops_count+' en '+r.max_ops_hours+'h)':'(sin l\u00edmite)')+'</span>'
        +'</div>'
        +(r.max_ops_count>0&&r.ops_used>=r.max_ops_count?'<div style="margin-top:6px;padding:8px 12px;border-radius:4px;background:rgba(255,152,0,.12);border:1px solid rgba(255,152,0,.25);font-size:.72rem;color:#f59e0b;font-weight:700;display:flex;align-items:center;gap:6px"><span style="font-size:1rem">&#9888;</span> L\u00edmite alcanzado: '+r.ops_used+'/'+r.max_ops_count+' operaciones en las \u00faltimas '+r.max_ops_hours+'h. Nuevas se\u00f1ales bloqueadas hasta que expire el l\u00edmite.</div>':'')
        +'<div id="rcp-params-'+r.id+'" class="rcp-params-panel"></div>'
        +'<div id="evals-'+r.id+'" style="display:none;margin-top:12px"></div>'
        +'<div id="chart-panel-'+r.id+'" style="display:none"></div>'
        +'</div>';
    }
    content.innerHTML=html;
    requestAnimationFrame(function(){window.scrollTo(0,_scrollY)});
  }catch(e){loader.classList.remove('show');toast('Error cargando recetas: '+e.message,'error')}
}

async function toggleRecipe(id){
  try{await api('POST','/recipe/'+id+'/toggle');toast('Estado actualizado','success');loadRecipes();
  }catch(e){toast('Error cambiando estado: '+e.message,'error')}
}
async function deleteRecipe(id){
  if(!confirm('Eliminar esta receta y todo su historial?'))return;
  try{await api('DELETE','/recipe/'+id);toast('Receta eliminada','success');loadRecipes();
  }catch(e){toast('Error eliminando receta: '+e.message,'error')}
}
async function saveOpsLimit(id){
  var count=parseInt(document.getElementById('ops-count-'+id).value)||0;
  var hours=parseFloat(document.getElementById('ops-hours-'+id).value)||24;
  try{
    await api('PATCH','/recipe/'+id,{max_ops_count:count,max_ops_hours:hours});
    toast(count>0?'L\u00edmite: m\u00e1x '+count+' ops cada '+hours+'h':'L\u00edmite de ops desactivado','success');
    loadRecipes();
  }catch(e){toast('Error guardando l\u00edmite: '+e.message,'error')}
}

/* ── Inline Recipe Params Editor ──────────────────── */
var _rcpParamsRecipeCache={};

async function toggleRecipeParams(recipeId){
  var panel=document.getElementById('rcp-params-'+recipeId);
  if(!panel)return;
  if(panel.classList.contains('show')){panel.classList.remove('show');return}

  /* Fetch recipe data */
  var recipes=null;
  try{recipes=await api('GET','/recipe/')}catch(e){toast('Error: '+e.message,'error');return}
  var recipe=recipes.find(function(r){return r.id===recipeId});
  if(!recipe){toast('Receta no encontrada','error');return}
  _rcpParamsRecipeCache[recipeId]=recipe;

  /* Load strategy details for each strategy */
  var html='';
  for(var i=0;i<recipe.strategies.length;i++){
    var strat=recipe.strategies[i];
    var sk=strat.strategy;
    var lb=STRATEGY_LABELS[sk]||{name:sk,icon:''};
    try{
      if(!_strategyDetailCache[sk])_strategyDetailCache[sk]=await api('GET','/strategies/'+sk);
    }catch(e){continue}
    var detail=_strategyDetailCache[sk];
    var customVals=(recipe.strategy_params&&recipe.strategy_params[sk])||{};

    html+='<div class="rcp-params-strat">'
      +'<div class="rcp-params-strat-header">'+lb.icon+' '+lb.name+' ('+Math.round(strat.weight*100)+'%)</div>'
      +'<div class="rcp-params-grid">';
    for(var pkey in detail.default_params){
      var p=detail.default_params[pkey];
      var curVal=(pkey in customVals)?customVals[pkey]:p.value;
      html+='<div class="rcp-params-field">';
      html+='<label>'+pkey+'</label>';
      if(p.options){
        html+='<select data-strat="'+sk+'" data-param="'+pkey+'">';
        for(var oi=0;oi<p.options.length;oi++){
          var opt=p.options[oi];
          html+='<option value="'+opt+'"'+(String(opt)===String(curVal)?' selected':'')+'>'+opt+'</option>';
        }
        html+='</select>';
      }else if(typeof p.value==='boolean'){
        html+='<select data-strat="'+sk+'" data-param="'+pkey+'">'
          +'<option value="false"'+(!curVal?' selected':'')+'>No</option>'
          +'<option value="true"'+(curVal?' selected':'')+'>Si</option>'
          +'</select>';
      }else{
        html+='<input type="number" data-strat="'+sk+'" data-param="'+pkey+'" value="'+curVal+'"'
          +(p.min!==undefined?' min="'+p.min+'"':'')
          +(p.max!==undefined?' max="'+p.max+'"':'')
          +(p.step!==undefined?' step="'+p.step+'"':' step="any"')+'>';
        if(p.min!==undefined&&p.max!==undefined) html+='<div class="rcp-p-range">'+p.min+' \u2013 '+p.max+'</div>';
      }
      html+='<div class="rcp-p-hint">'+p.desc+'</div>';
      html+='</div>';
    }
    html+='</div></div>';
  }
  html+='<div class="rcp-params-actions">'
    +'<button class="rcp-params-reset" onclick="resetRecipeParams('+recipeId+')">Restaurar defecto</button>'
    +'<button class="rcp-params-save" onclick="saveRecipeParams('+recipeId+')">Guardar par\u00e1metros</button>'
    +'</div>';
  panel.innerHTML=html;
  panel.classList.add('show');
}

async function saveRecipeParams(recipeId){
  var panel=document.getElementById('rcp-params-'+recipeId);
  if(!panel)return;
  var params={};
  var inputs=panel.querySelectorAll('[data-strat][data-param]');
  inputs.forEach(function(input){
    var sk=input.dataset.strat;
    var pkey=input.dataset.param;
    var detail=_strategyDetailCache[sk];
    if(!detail)return;
    var p=detail.default_params[pkey];
    if(!p)return;
    var val;
    if(p.options){val=input.value}
    else if(typeof p.value==='boolean'){val=input.value==='true'}
    else{val=parseFloat(input.value)}
    /* Only include if different from default */
    if(val!==p.value){
      if(!params[sk])params[sk]={};
      params[sk][pkey]=val;
    }
  });
  var payload={strategy_params:Object.keys(params).length?params:null};
  try{
    await api('PATCH','/recipe/'+recipeId,payload);
    toast('Par\u00e1metros guardados','success');
    loadRecipes();
  }catch(e){toast('Error guardando: '+e.message,'error')}
}

function resetRecipeParams(recipeId){
  var panel=document.getElementById('rcp-params-'+recipeId);
  if(!panel)return;
  panel.querySelectorAll('[data-strat][data-param]').forEach(function(input){
    var sk=input.dataset.strat;
    var pkey=input.dataset.param;
    var detail=_strategyDetailCache[sk];
    if(!detail)return;
    var p=detail.default_params[pkey];
    if(!p)return;
    input.value=typeof p.value==='boolean'?String(p.value):p.value;
  });
  toast('Valores restaurados a defecto','success');
}
async function showEvaluations(id){
  const div=document.getElementById('evals-'+id);
  if(div.style.display!=='none'){div.style.display='none';return}
  div.innerHTML='<div style="padding:12px;text-align:center"><div class="spinner" style="margin:0 auto"></div></div>';
  div.style.display='block';
  try{
    const evals=await api('GET','/recipe/'+id+'/evaluations');
    if(!evals.length){div.innerHTML='<div style="padding:12px;color:var(--muted);font-size:.82rem;text-align:center">Sin evaluaciones todav\u00eda</div>';return}
    let h='<table class="eval-table"><thead><tr><th>Fecha</th><th>Score</th><th>Se\u00f1al</th><th>Estrategias</th><th>Disparada</th></tr></thead><tbody>';
    for(const ev of evals.slice(0,20)){
      const dt=_localDt(ev.evaluated_at);
      const scoreColor=ev.final_score>0?'var(--buy)':ev.final_score<0?'var(--sell)':'var(--muted)';
      const scorePct=Math.round((Math.abs(ev.final_score))*100);
      const barColor=ev.final_score>0?'var(--buy)':'var(--sell)';
      const sigColor=ev.signal==='BUY'?'var(--buy)':ev.signal==='SELL'?'var(--sell)':'var(--muted)';
      const stratTags=ev.strategy_results.map(function(r){
        const lb=STRATEGY_LABELS[r.strategy]||{name:r.strategy,icon:''};
        if(r.force!=null){
          var fPct=Math.round(r.force*100);
          var fCls=fPct>=25?'buy':'notrade';
          return '<span class="strat-tag '+fCls+'" style="color:var(--strength-color)">'+lb.icon+' '+lb.name.split(' ')[0]+': '+fPct+'%</span>';
        }
        const cls=r.recommendation==='BUY'?'buy':r.recommendation==='SELL'?'sell':'notrade';
        const label=r.recommendation==='BUY'?'COMPRA':r.recommendation==='SELL'?'VENTA':'—';
        return '<span class="strat-tag '+cls+'">'+lb.icon+' '+lb.name.split(' ')[0]+': '+label+'</span>';
      }).join('');
      const triggered=ev.triggered?'<span class="badge badge-approved">SI</span>':'<span style="color:var(--muted);font-size:.68rem">no</span>';
      h+='<tr><td data-label="Fecha" style="white-space:nowrap;font-size:.75rem">'+dt+'</td>'
        +'<td data-label="Score"><div class="score-bar"><div class="score-fill" style="width:'+scorePct+'%;background:'+barColor+'"></div></div>'
        +'<span style="color:'+scoreColor+';font-weight:700;font-size:.82rem">'+(ev.final_score>=0?'+':'')+Math.round(ev.final_score*100)+'%</span></td>'
        +'<td data-label="Señal" style="color:'+sigColor+';font-weight:700">'+ev.signal+'</td>'
        +'<td data-label="Estrategias">'+stratTags+'</td>'
        +'<td data-label="Disparada">'+triggered+'</td></tr>';
    }
    h+='</tbody></table>';
    div.innerHTML=h;
  }catch(e){div.innerHTML='<div style="padding:12px;color:var(--sell);font-size:.82rem">'+e.message+'</div>'}
}

/* ── CHART ANALYSIS PANEL ───────────────────────────── */
const _chartTimers={};
const _chartCountdowns={};

async function showChartPanel(recipeId){
  const panel=document.getElementById('chart-panel-'+recipeId);
  if(!panel)return;
  if(panel.style.display!=='none'){
    panel.style.display='none';
    stopChartAutoRefresh(recipeId);
    return;
  }
  panel.style.display='block';
  await refreshChartPanel(recipeId,true);
}

async function refreshChartPanel(recipeId,showLoader){
  const panel=document.getElementById('chart-panel-'+recipeId);
  if(!panel)return;
  const _scrollY=window.scrollY;
  if(showLoader){
    panel.innerHTML='<div class="chart-panel" style="text-align:center;padding:30px"><div class="spinner" style="margin:0 auto"></div><div style="color:var(--muted);font-size:.82rem;margin-top:10px">Cargando an\u00e1lisis...</div></div>';
  }
  try{
    const [evals,recipes]=await Promise.all([
      api('GET','/recipe/'+recipeId+'/evaluations'),
      api('GET','/recipe/')
    ]);
    const recipe=recipes.find(function(r){return r.id===recipeId});
    if(!recipe){panel.innerHTML='<div class="chart-panel" style="padding:20px;color:var(--sell)">Receta no encontrada</div>';return}
    if(!evals.length){
      panel.innerHTML='<div class="chart-panel" style="text-align:center;padding:30px"><div style="font-size:2rem;margin-bottom:8px">&#9203;</div><div style="color:var(--muted);font-size:.85rem">Esperando primera evaluaci\u00f3n...<br>El sistema eval\u00faa cada 30 segundos.</div></div>';
      return;
    }
    let currentPrice=null;
    let closePrices=[];
    try{
      const [tk,cpArr]=await Promise.all([
        fetch('https://api.binance.com/api/v3/ticker/price?symbol='+recipe.symbol).then(function(r){return r.json()}),
        fetchMiniPriceHistory(recipe.symbol,recipe.interval,30)
      ]);
      currentPrice=parseFloat(tk.price);
      closePrices=cpArr;
    }catch(e){}
    const latest=evals[0];
    const history=evals.slice(0,30).reverse();
    const isLive=!!_chartTimers[recipeId];
    _chartDataCache[recipeId]={stratResults:latest.strategy_results,currentPrice:currentPrice,closePrices:closePrices};
    panel.innerHTML=buildChartHTML(recipe,latest,history,currentPrice,recipeId,isLive,closePrices);
    /* Attach SL/TP input listeners for reactive OCO chart update */
    var _slIn=document.getElementById('inlineSlPct-'+recipeId);
    var _tpIn=document.getElementById('inlineTpPct-'+recipeId);
    if(_slIn)_slIn.addEventListener('input',function(){updateOCOChartFromInputs(recipeId)});
    if(_tpIn)_tpIn.addEventListener('input',function(){updateOCOChartFromInputs(recipeId)});
    loadInlineBalance(recipeId,recipe.symbol);
    loadBinanceLimits(recipeId,recipe.symbol);
    showRefreshInterval(recipeId,recipe.interval,recipe.turbo_threshold);
    if(isLive)startCountdown(recipeId);
    if(!showLoader)requestAnimationFrame(function(){window.scrollTo(0,_scrollY)});
  }catch(e){
    panel.innerHTML='<div class="chart-panel" style="padding:20px;color:var(--sell)">'+e.message+'</div>';
  }
}

function toggleChartAutoRefresh(recipeId){
  if(_chartTimers[recipeId]){
    stopChartAutoRefresh(recipeId);
    var btn=document.getElementById('liveBtn-'+recipeId);
    if(btn){btn.classList.remove('active');btn.textContent='ACTIVAR'}
    var dot=document.getElementById('liveDot-'+recipeId);
    if(dot)dot.classList.remove('on');
    var timer=document.getElementById('liveTimer-'+recipeId);
    if(timer)timer.textContent='';
  }else{
    _chartTimers[recipeId]=setInterval(function(){refreshChartPanel(recipeId,false)},30000);
    var btn=document.getElementById('liveBtn-'+recipeId);
    if(btn){btn.classList.add('active');btn.textContent='DETENER'}
    var dot=document.getElementById('liveDot-'+recipeId);
    if(dot)dot.classList.add('on');
    startCountdown(recipeId);
  }
}

function startCountdown(recipeId){
  if(_chartCountdowns[recipeId])clearInterval(_chartCountdowns[recipeId]);
  var seconds=30;
  var timer=document.getElementById('liveTimer-'+recipeId);
  if(timer)timer.textContent='Actualiza en '+seconds+'s';
  _chartCountdowns[recipeId]=setInterval(function(){
    seconds--;
    var timer=document.getElementById('liveTimer-'+recipeId);
    if(timer&&seconds>0)timer.textContent='Actualiza en '+seconds+'s';
    else if(timer)timer.textContent='Actualizando...';
    if(seconds<=0)clearInterval(_chartCountdowns[recipeId]);
  },1000);
}

function stopChartAutoRefresh(recipeId){
  if(_chartTimers[recipeId]){clearInterval(_chartTimers[recipeId]);delete _chartTimers[recipeId]}
  if(_chartCountdowns[recipeId]){clearInterval(_chartCountdowns[recipeId]);delete _chartCountdowns[recipeId]}
  delete _chartDataCache[recipeId];
}

function buildChartHTML(recipe,latest,history,currentPrice,recipeId,isLive,closePrices){
  const sig=latest.signal;
  const score=latest.final_score;
  const sigLabel=sig==='BUY'?'COMPRAR':sig==='SELL'?'VENDER':'ESPERAR';
  const sigCls=sig==='BUY'?'buy':sig==='SELL'?'sell':'hold';
  const sigIcon=sig==='BUY'?'&#128994;':sig==='SELL'?'&#128308;':'&#128992;';
  const explanation=getSignalExplanation(sig,score,latest.strategy_results);
  const votesHTML=renderVoteCards(latest.strategy_results);
  const pricesHTML=renderOCOChart(latest.strategy_results,currentPrice,recipeId,{
    slPct:recipe.stop_loss_pct,tpPct:recipe.take_profit_pct,closePrices:closePrices||[]
  });
  var trendHTML=getTrendHTML(history);
  var liveOnCls=isLive?' active':'';
  var liveDotCls=isLive?' on':'';
  var liveBtnText=isLive?'DETENER':'ACTIVAR';
  return '<div class="chart-panel">'
    +'<div class="chart-live-bar">'
    +'<div class="chart-live-left">'
    +'<div id="liveDot-'+recipeId+'" class="chart-live-dot'+liveDotCls+'"></div>'
    +'<span>Actualizaci\u00f3n en vivo</span>'
    +'<span id="liveTimer-'+recipeId+'" class="chart-live-timer">'+(isLive?'Actualiza en 30s':'')+'</span>'
    +'</div>'
    +'<button id="liveBtn-'+recipeId+'" class="chart-live-btn'+liveOnCls+'" onclick="toggleChartAutoRefresh('+recipeId+')">'+liveBtnText+'</button>'
    +'</div>'
    +'<div class="inline-thresholds" id="inlineTh-'+recipeId+'">'

    +'<div class="ifl-stage signals">'
    +'<div class="ifl-stage-header"><div class="ifl-stage-num">1</div><div class="ifl-stage-title">Se\u00f1ales de entrada (aprobaci\u00f3n)</div></div>'
    +'<div class="ifl-stage-fields" style="grid-template-columns:1fr 1fr 1fr 1fr 1fr">'
    +'<div class="inline-th-group"><label><span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:#22c55e;margin-right:3px;vertical-align:middle"></span>Compra %</label>'
    +'<input type="number" id="inlineBuyTh-'+recipeId+'" value="'+Math.round(recipe.buy_threshold*100)+'" min="10" max="100" step="5" style="border-color:rgba(34,197,94,.3)"></div>'
    +'<div class="inline-th-group"><label><span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:#ef4444;margin-right:3px;vertical-align:middle"></span>Venta %</label>'
    +'<input type="number" id="inlineSellTh-'+recipeId+'" value="'+Math.round(recipe.sell_threshold*100)+'" min="10" max="100" step="5" style="border-color:rgba(239,68,68,.3)"></div>'
    +'<div class="inline-th-group"><label><span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:#f59e0b;margin-right:3px;vertical-align:middle"></span>Fuerza %</label>'
    +'<input type="number" id="inlineStrengthTh-'+recipeId+'" value="'+Math.round((recipe.strength_threshold||0)*100)+'" min="0" max="100" step="5" style="border-color:rgba(245,158,11,.3)"></div>'
    +'<div class="inline-th-group"><label>Confirm (min)</label>'
    +'<input type="number" id="inlineConfirmMin-'+recipeId+'" value="'+(recipe.confirmation_minutes||0)+'" min="0" max="1440" step="1"></div>'
    +'<div class="inline-th-group"><label>Confirm (seg)</label>'
    +'<input type="number" id="inlineConfirmSec-'+recipeId+'" value="'+(recipe.confirmation_seconds||0)+'" min="0" max="86400" step="1"></div>'
    +'</div></div>'

    +'<div class="ifl-arrow sig-to-exec"><div class="ifl-arrow-line"></div></div>'

    +'<div class="ifl-stage execution">'
    +'<div class="ifl-stage-header"><div class="ifl-stage-num">2</div><div class="ifl-stage-title">Ejecuci\u00f3n autom\u00e1tica <span style="font-size:.6rem;color:var(--accent);font-weight:600">(morado en barras)</span></div></div>'
    +'<div class="ifl-stage-fields" style="grid-template-columns:1fr 1fr">'
    +'<div class="inline-th-group" style="border-left:3px solid var(--accent);padding-left:8px"><label><span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:#3b82f6;margin-right:3px;vertical-align:middle"></span>Auto EMA (dir.) %</label>'
    +'<input type="number" id="inlineAutoTh-'+recipeId+'" value="'+Math.round((recipe.auto_threshold||0)*100)+'" min="0" max="100" step="5" style="border-color:rgba(59,130,246,.4)"></div>'
    +'<div class="inline-th-group" style="border-left:3px solid var(--accent);padding-left:8px"><label><span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:#3b82f6;margin-right:3px;vertical-align:middle"></span>Auto ADX (fza.) %</label>'
    +'<input type="number" id="inlineAutoStrTh-'+recipeId+'" value="'+Math.round((recipe.auto_strength_threshold||0)*100)+'" min="0" max="100" step="5" style="border-color:rgba(59,130,246,.4)"></div>'
    +'</div>'
    +'<div id="iflBinanceLimits-'+recipeId+'" style="font-size:.58rem;color:var(--muted);margin:4px 0 6px;text-align:center">Cargando l\u00edmites...</div>'
    +'<div class="ifl-exec-cols">'
    +'<div class="ifl-exec-col buy-col">'
    +'<div class="ifl-exec-col-title">&#128994; Compra (BUY)</div>'
    +'<div class="ifl-bal-token" id="iflBalQuote-'+recipeId+'"><div class="ifl-bal-loading" style="font-size:.65rem">Cargando saldo...</div></div>'
    +'<div class="inline-th-group" style="margin:6px 0"><label>Cantidad compra</label>'
    +'<input type="number" id="inlineBuyQty-'+recipeId+'" value="'+(recipe.buy_quantity||0)+'" min="0" step="any"></div>'
    +'<div class="ifl-fixed-type buy">OCO (SL '+recipe.stop_loss_pct+'% / TP '+recipe.take_profit_pct+'%)</div>'
    +'<button class="btn-test-exec buy" onclick="testExecute('+recipeId+',\'BUY\')" id="btnTestBuy-'+recipeId+'">TEST BUY</button>'
    +'</div>'
    +'<div class="ifl-exec-col sell-col">'
    +'<div class="ifl-exec-col-title">&#128308; Venta (SELL)</div>'
    +'<div class="ifl-bal-token" id="iflBalBase-'+recipeId+'"><div class="ifl-bal-loading" style="font-size:.65rem">Cargando saldo...</div></div>'
    +'<div class="inline-th-group" style="margin:6px 0"><label>Cantidad venta</label>'
    +'<input type="number" id="inlineSellQty-'+recipeId+'" value="'+(recipe.sell_quantity||0)+'" min="0" step="any"></div>'
    +'<div class="ifl-fixed-type sell">OCO (SL '+recipe.stop_loss_pct+'% / TP '+recipe.take_profit_pct+'%)</div>'
    +'<button class="btn-test-exec sell" onclick="testExecute('+recipeId+',\'SELL\')" id="btnTestSell-'+recipeId+'">TEST SELL</button>'
    +'</div>'
    +'</div>'
    +'</div>'

    +'<div class="ifl-arrow exec-to-risk"><div class="ifl-arrow-line"></div></div>'

    +'<div class="ifl-stage risk">'
    +'<div class="ifl-stage-header"><div class="ifl-stage-num">3</div><div class="ifl-stage-title">Gesti\u00f3n de riesgo</div></div>'
    +'<div class="ifl-stage-fields" style="grid-template-columns:1fr 1fr 1fr 1fr">'
    +'<div class="inline-th-group"><label>Stop-Loss %</label>'
    +'<input type="number" id="inlineSlPct-'+recipeId+'" value="'+recipe.stop_loss_pct+'" min="0.1" max="50" step="0.1"></div>'
    +'<div class="inline-th-group"><label>Take-Profit %</label>'
    +'<input type="number" id="inlineTpPct-'+recipeId+'" value="'+recipe.take_profit_pct+'" min="0.1" max="100" step="0.1"></div>'
    +'<div class="inline-th-group"><label>Max orden %</label>'
    +'<input type="number" id="inlineMaxPct-'+recipeId+'" value="'+recipe.max_order_pct+'" min="0.1" max="100" step="0.1"></div>'
    +'<div class="inline-th-group"><label>Actualiza cada</label>'
    +'<div id="iflRefreshInfo-'+recipeId+'" style="padding:7px 10px;border-radius:4px;border:1px solid var(--border);background:var(--surface);text-align:center;font-weight:800;font-size:.85rem;color:var(--accent2)"></div></div>'
    +'</div></div>'

    +'<div class="inline-th-save">'
    +'<button class="btn btn-primary btn-sm" onclick="saveInlineThresholds('+recipeId+')">Guardar cambios</button>'
    +'</div>'
    +'<div class="inline-th-saved" id="inlineThSaved-'+recipeId+'">Umbrales actualizados</div>'
    +'</div>'
    +'<div class="chart-section-title" style="margin-top:4px">C\u00f3mo votaron las estrategias</div>'
    +'<div class="chart-votes" style="margin-bottom:16px">'+votesHTML+'</div>'
    +pricesHTML
    +'</div>';
}

function showRefreshInterval(recipeId,interval,turboTh){
  var box=document.getElementById('iflRefreshInfo-'+recipeId);
  if(!box)return;
  var map={'1m':60,'5m':300,'15m':900,'1h':3600,'4h':14400,'1d':86400};
  var secs=map[interval]||3600;
  var turbo=((turboTh||0)>0);
  var fmt=function(s){
    if(s>=3600)return (s/3600)+'h';
    if(s>=60)return (s/60)+'m';
    return s+'s';
  };
  if(turbo){
    box.innerHTML=fmt(secs)+' <span style="font-size:.65rem;color:var(--hold);font-weight:600">/ 15s turbo</span>';
  }else{
    box.textContent=fmt(secs);
  }
}

function loadBinanceLimits(recipeId,symbol){
  var box=document.getElementById('iflBinanceLimits-'+recipeId);
  if(!box)return;
  fetch('https://api.binance.com/api/v3/exchangeInfo?symbol='+symbol).then(function(r){return r.json()}).then(function(d){
    var sym=d.symbols&&d.symbols[0];
    if(!sym){box.textContent='Sin datos de filtros';return}
    var minQty='?',maxQty='?',stepSize='?',minNotional='?';
    (sym.filters||[]).forEach(function(f){
      if(f.filterType==='LOT_SIZE'){minQty=f.minQty;maxQty=f.maxQty;stepSize=f.stepSize}
      if(f.filterType==='NOTIONAL'||f.filterType==='MIN_NOTIONAL'){minNotional=f.minNotional||'0'}
    });
    var clean=function(v){return parseFloat(v)>0?v.replace(/\.?0+$/,''):v};
    box.innerHTML='<span style="color:var(--buy)">Min: '+clean(minQty)+'</span>'
      +' &middot; <span style="color:var(--sell)">Max: '+clean(maxQty)+'</span>'
      +' &middot; Step: '+clean(stepSize)
      +' &middot; <span style="color:var(--hold)">Notional: $'+clean(minNotional)+'</span>';
  }).catch(function(e){
    box.textContent='Error: '+e.message;
  });
}

function loadInlineBalance(recipeId,symbol){
  var quoteBox=document.getElementById('iflBalQuote-'+recipeId);
  var baseBox=document.getElementById('iflBalBase-'+recipeId);
  if(!quoteBox&&!baseBox)return;
  var noKeys='<div class="ifl-bal-loading" style="color:var(--hold);font-size:.6rem">Sin API Keys</div>';
  if(!USER||!USER.hasKeys){
    if(quoteBox)quoteBox.innerHTML=noKeys;
    if(baseBox)baseBox.innerHTML=noKeys;
    return;
  }
  api('GET','/trade/balance/'+symbol).then(function(d){
    var bals=d.balances||{};
    var baseB=bals[d.base]||{free:0,locked:0};
    var quoteB=bals[d.quote]||{free:0,locked:0};
    var fmt=function(v){return v<1?v.toFixed(8).replace(/0+$/,'').replace(/\.$/,'.0'):v.toFixed(4).replace(/0+$/,'').replace(/\.$/,'.0')};
    if(quoteBox)quoteBox.innerHTML=
      '<div class="ifl-bal-label">'+d.quote+' disponible</div>'
      +'<div class="ifl-bal-free" style="color:'+(quoteB.free>0?'var(--buy)':'var(--sell)')+'">'+fmt(quoteB.free)+'</div>'
      +(quoteB.locked>0?'<div class="ifl-bal-locked">Bloqueado: '+fmt(quoteB.locked)+'</div>':'');
    if(baseBox)baseBox.innerHTML=
      '<div class="ifl-bal-label">'+d.base+' disponible</div>'
      +'<div class="ifl-bal-free" style="color:'+(baseB.free>0?'var(--buy)':'var(--sell)')+'">'+fmt(baseB.free)+'</div>'
      +(baseB.locked>0?'<div class="ifl-bal-locked">Bloqueado: '+fmt(baseB.locked)+'</div>':'');
  }).catch(function(e){
    var err='<div class="ifl-bal-loading" style="color:var(--sell);font-size:.6rem">'+e.message+'</div>';
    if(quoteBox)quoteBox.innerHTML=err;
    if(baseBox)baseBox.innerHTML=err;
  });
}

function getTrendHTML(history){
  if(history.length<2)return '<div class="chart-trend flat">&#8594; Sin tendencia a\u00fan</div>';
  var recent=history.slice(-5);
  var first=recent[0].final_score;
  var last=recent[recent.length-1].final_score;
  var diff=last-first;
  var absDiff=Math.abs(diff);
  if(absDiff<0.02)return '<div class="chart-trend flat">&#8594; Estable</div>';
  if(diff>0){
    var label=last>0?'Yendo hacia compra':'Subiendo (menos negativo)';
    return '<div class="chart-trend up">&#8599; '+label+' (+'+Math.round(absDiff*100)+'%)</div>';
  }
  var label=last<0?'Yendo hacia venta':'Bajando (menos positivo)';
  return '<div class="chart-trend down">&#8600; '+label+' (-'+Math.round(absDiff*100)+'%)</div>';
}

function getSignalExplanation(signal,score,stratResults){
  const dirResults=stratResults.filter(r=>r.force==null);
  const strResults=stratResults.filter(r=>r.force!=null);
  const total=dirResults.length;
  const buying=dirResults.filter(r=>r.recommendation==='BUY').length;
  const selling=dirResults.filter(r=>r.recommendation==='SELL').length;
  const holding=dirResults.filter(r=>r.recommendation==='NO-TRADE').length;
  const maxConf=Math.max(...stratResults.map(r=>r.confidence));
  if(signal==='BUY'){
    return buying===total
      ?'Todas las estrategias coinciden en que es buen momento para comprar. La confianza m\u00e1xima es de '+maxConf+'%.'
      :buying+' de '+total+' estrategias sugieren comprar. El score combinado de +'+(Math.round(score*100))+'% super\u00f3 el umbral de compra.';
  }
  if(signal==='SELL'){
    return selling===total
      ?'Todas las estrategias coinciden en que conviene vender. La confianza m\u00e1xima es de '+maxConf+'%.'
      :selling+' de '+total+' estrategias sugieren vender. El score de '+(Math.round(score*100))+'% super\u00f3 el umbral de venta.';
  }
  if(buying>0&&selling>0){
    return 'Las estrategias est\u00e1n divididas ('+buying+' comprar, '+selling+' vender). No hay consenso claro, conviene esperar.';
  }
  return 'No se detecta una se\u00f1al clara. El score de '+(score>=0?'+':'')+Math.round(score*100)+'% est\u00e1 en zona neutral. Conviene esperar.';
}

var _METRIC_KEYS_SKIP={'sl_multiplier':1,'tp_multiplier':1,'threshold':1,'fear_threshold':1,'greed_threshold':1,'force':1};
var _METRIC_KEY_LABELS={
  predicted_return:'Retorno predicho',forecast_horizon:'Horizonte',ar_order:'Orden AR',
  rsi:'RSI',overbought:'Sobrecompra',oversold:'Sobreventa',
  macd_line:'MACD',signal_line:'Senal',histogram:'Histograma',trigger_mode:'Modo',
  upper_band:'Banda sup',lower_band:'Banda inf',middle_band:'Banda media',pct_b:'%B',bandwidth:'Ancho banda',
  upper_channel:'Canal sup',lower_channel:'Canal inf',buffer_pct:'Buffer %',volume_filter:'Filtro vol',
  atr:'ATR',trailing_stop:'Trailing Stop',trend:'Tendencia',direction:'Direccion',
  adx:'ADX',plus_di:'+DI',minus_di:'-DI',di_diff:'DI diff',rising:'ADX subiendo',adx_rising:'ADX subiendo',adx_prev:'ADX previo',
  fng_value:'Fear & Greed',fng_classification:'Clasif. FNG',fng_avg:'Promedio FNG',fng_trend:'Tend. FNG',
  ma_type:'Tipo MA',fast_ma:'MA rapida',slow_ma:'MA lenta',cross_type:'Cruce',
  kalman_trend:'Tend. Kalman',kalman_slope:'Pendiente',volatility:'Volatilidad',vol_regime:'Regimen vol',
  z_score:'Z-Score',mean_price:'Precio medio',half_life:'Vida media',mean_rev_speed:'Vel. reversion',
  ema_fast:'EMA rapida',ema_slow:'EMA lenta',diff:'Diff EMAs',norm:'Normalizado',scaled_pct:'Score escalado',
  k:'Sensibilidad (k)',deadzone:'Zona muerta',ema_fast_period:'Periodo EMA rapida',ema_slow_period:'Periodo EMA lenta'
};
var _METRIC_HINTS={
  predicted_return:'Retorno futuro estimado por el modelo',
  forecast_horizon:'Cuantas velas hacia adelante predice',
  ar_order:'Cantidad de velas pasadas que usa el modelo',
  rsi:'Indice de fuerza relativa (0-100)',
  macd_line:'Diferencia entre EMAs rapida y lenta',
  signal_line:'EMA suavizada del MACD',
  histogram:'MACD menos su senal (impulso)',
  adx:'Fuerza de la tendencia actual (0-100)',
  adx_prev:'Valor ADX en la vela anterior',
  adx_rising:'Si el ADX esta aumentando',
  plus_di:'Fuerza del movimiento alcista',
  minus_di:'Fuerza del movimiento bajista',
  trend:'Direccion de la tendencia detectada',
  atr:'Rango promedio real (volatilidad)',
  ema_fast:'Valor actual de la EMA rapida',
  ema_slow:'Valor actual de la EMA lenta',
  diff:'Diferencia entre EMA rapida y lenta',
  norm:'Diferencia normalizada por precio',
  scaled_pct:'Score final escalado (-100 a +100)',
  z_score:'Desviacion del precio vs media (en sigmas)',
  mean_price:'Precio medio estimado',
  volatility:'Volatilidad actual del activo',
  pct_b:'Posicion del precio dentro de Bollinger (0-1)',
  bandwidth:'Ancho de las bandas de Bollinger',
  kalman_slope:'Pendiente del filtro Kalman',
  fng_value:'Indice miedo y codicia del mercado (0-100)',
  force:'Fuerza de tendencia normalizada (0-1)'
};
function formatMetricKey(k){
  if(_METRIC_KEY_LABELS[k])return _METRIC_KEY_LABELS[k];
  return k.replace(/_/g,' ').replace(/^\w/,function(c){return c.toUpperCase()});
}
function formatMetricValue(k,v){
  if(v===null||v===undefined)return '\u2014';
  if(typeof v==='boolean')return v?'Si':'No';
  if(typeof v==='string')return v;
  if(typeof v!=='number')return String(v);
  if(k==='scaled_pct')return(v>=0?'+':'')+v.toFixed(1)+'%';
  if(/pct|return|change|drift|bandwidth/.test(k))return v.toFixed(2)+'%';
  if(/^(rsi|adx|fng_value|overbought|oversold|fear_threshold|greed_threshold|forecast_horizon|ar_order)$/.test(k))return Math.round(v).toString();
  if(/price|band|channel|stop|entry|close|trailing|mean_price/.test(k)){
    return v>=1000?'$'+v.toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2}):'$'+v.toFixed(4);
  }
  if(Number.isInteger(v))return v.toString();
  return Math.abs(v)<0.01?v.toExponential(2):v.toFixed(4);
}
function _fmtPrice(v){
  if(!v&&v!==0)return null;
  return v>=1000?'$'+v.toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2}):'$'+v.toFixed(4);
}

function renderVoteCards(stratResults){
  return stratResults.map(function(sr){
    const lb=STRATEGY_LABELS[sr.strategy]||{name:sr.strategy,icon:'',color:'var(--muted)'};
    const stColor=lb.color||'var(--muted)';
    const isStrength=sr.force!=null;
    const rec=sr.recommendation;
    const weightPct=Math.round(sr.weight*100);

    // ── Header badge ──
    var typeBadge,mainValue,mainLabel,mainBarPct,sigColor;
    if(isStrength){
      var fPct=Math.round(sr.force*100);
      typeBadge='<span style="font-size:.55rem;padding:2px 6px;border-radius:4px;background:rgba(255,152,0,.15);color:var(--strength-color);font-weight:700;text-transform:uppercase">FUERZA</span>';
      mainValue=fPct+'%';
      mainLabel=fPct>=25?'FUERTE':'DÉBIL';
      mainBarPct=fPct;
      sigColor=stColor;
    }else{
      var sPct=Math.round((sr.score||0)*100);
      typeBadge='<span style="font-size:.55rem;padding:2px 6px;border-radius:4px;background:rgba(30,144,255,.15);color:var(--direction-color);font-weight:700;text-transform:uppercase">DIRECCIÓN</span>';
      mainValue=(sPct>=0?'+':'')+sPct+'%';
      mainLabel=rec==='BUY'?'COMPRA':rec==='SELL'?'VENTA':'ESPERAR';
      mainBarPct=Math.min(Math.abs(sPct),100);
      sigColor=rec==='BUY'?'var(--buy)':rec==='SELL'?'var(--sell)':'var(--muted)';
    }

    // ── Metrics with hints ──
    var metricsHTML='';
    if(sr.metrics&&typeof sr.metrics==='object'){
      var keys=Object.keys(sr.metrics).filter(function(k){return !_METRIC_KEYS_SKIP[k]});
      if(keys.length){
        metricsHTML='<div class="chart-vote-metrics" style="border-left:2px solid '+stColor+'">';
        keys.forEach(function(k){
          var hint=_METRIC_HINTS[k]||'';
          var hintAttr=hint?' title="'+hint+'"':'';
          metricsHTML+='<div class="chart-vote-metric-row"'+hintAttr+'>'
            +'<span class="chart-vote-mk">'+formatMetricKey(k)+'</span>'
            +'<span class="chart-vote-mv">'+formatMetricValue(k,sr.metrics[k])+'</span>'
            +'</div>';
        });
        if(keys.some(function(k){return _METRIC_HINTS[k]})){
          metricsHTML+='<div style="font-size:.55rem;color:var(--muted);text-align:center;margin-top:4px;opacity:.6">Pasar el mouse sobre cada m&eacute;trica para ver descripci&oacute;n</div>';
        }
        metricsHTML+='</div>';
      }
    }

    // ── Prices ──
    var pricesHTML='';
    var pe=_fmtPrice(sr.entry),psl=_fmtPrice(sr.stop_loss),ptp=_fmtPrice(sr.take_profit);
    if(pe||psl||ptp){
      pricesHTML='<div class="chart-vote-prices">';
      if(pe)pricesHTML+='<span>Entrada: <b>'+pe+'</b></span>';
      if(psl)pricesHTML+='<span style="color:var(--sell)">SL: '+psl+'</span>';
      if(ptp)pricesHTML+='<span style="color:var(--buy)">TP: '+ptp+'</span>';
      pricesHTML+='</div>';
    }

    // ── Explanation ──
    var explainHTML='';
    if(sr.explanation){
      var txt=sr.explanation.length>160?sr.explanation.substring(0,157)+'...':sr.explanation;
      explainHTML='<div class="chart-vote-explain" style="border-left:2px solid '+stColor+'">'+txt+'</div>';
    }

    return '<div class="chart-vote-card" style="border-left:3px solid '+stColor+';border-top:1px solid '+stColor+'33">'
      // Header: icon + name + type badge + weight
      +'<div class="chart-vote-header" style="margin-bottom:8px">'
      +'<div style="display:flex;align-items:center;gap:6px">'
      +'<span style="font-size:1.1rem">'+lb.icon+'</span>'
      +'<span style="font-size:.82rem;font-weight:800;color:'+stColor+'">'+lb.name+'</span>'
      +typeBadge
      +'</div>'
      +'<span style="font-size:.6rem;color:var(--muted);font-weight:600">Peso: '+weightPct+'%</span>'
      +'</div>'
      // Main signal area
      +'<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">'
      +'<div style="font-size:1.4rem;font-weight:900;color:'+sigColor+';min-width:60px">'+mainValue+'</div>'
      +'<div style="flex:1">'
      +'<div style="font-size:.72rem;font-weight:800;color:'+sigColor+';margin-bottom:3px">'+mainLabel+'</div>'
      +'<div class="chart-vote-bar"><div class="chart-vote-fill" style="width:'+mainBarPct+'%;background:'+stColor+'"></div></div>'
      +'</div>'
      +'</div>'
      +metricsHTML
      +pricesHTML
      +explainHTML
      +'</div>';
  }).join('');
}

function renderPriceLevels(stratResults,currentPrice){
  const entries=[],sls=[],tps=[];
  stratResults.forEach(function(sr){
    if(sr.entry)entries.push(sr.entry);
    if(sr.stop_loss)sls.push(sr.stop_loss);
    if(sr.take_profit)tps.push(sr.take_profit);
  });
  if(!entries.length&&!currentPrice){
    return '<div class="chart-prices"><div class="chart-section-title">Niveles de precio</div>'
      +'<div style="color:var(--muted);font-size:.82rem;text-align:center;padding:20px">Sin datos de precio disponibles</div></div>';
  }
  const avgEntry=entries.length?entries.reduce(function(a,b){return a+b},0)/entries.length:null;
  const avgSL=sls.length?sls.reduce(function(a,b){return a+b},0)/sls.length:null;
  const avgTP=tps.length?tps.reduce(function(a,b){return a+b},0)/tps.length:null;
  const allPrices=[avgEntry,avgSL,avgTP,currentPrice].filter(function(p){return p!==null});
  if(!allPrices.length){
    return '<div class="chart-prices"><div class="chart-section-title">Niveles de precio</div>'
      +'<div style="color:var(--muted);font-size:.82rem;text-align:center;padding:20px">Sin datos de precio</div></div>';
  }
  const minP=Math.min.apply(null,allPrices)*0.998;
  const maxP=Math.max.apply(null,allPrices)*1.002;
  const range=maxP-minP||1;
  function pct(v){return((v-minP)/range*100).toFixed(1)}
  function fmt(v){return v>=1000?v.toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2}):v.toFixed(4)}
  let markers='';
  if(avgSL!==null)markers+='<div class="chart-price-marker" style="left:'+pct(avgSL)+'%;background:var(--sell)"><div class="chart-price-marker-label" style="color:var(--sell)">SL</div></div>';
  if(avgEntry!==null)markers+='<div class="chart-price-marker" style="left:'+pct(avgEntry)+'%;background:var(--accent)"><div class="chart-price-marker-label" style="color:var(--accent)">Entrada</div></div>';
  if(avgTP!==null)markers+='<div class="chart-price-marker" style="left:'+pct(avgTP)+'%;background:var(--buy)"><div class="chart-price-marker-label" style="color:var(--buy)">TP</div></div>';
  if(currentPrice!==null)markers+='<div class="chart-price-marker" style="left:'+pct(currentPrice)+'%;background:var(--text);width:2px;border-style:dashed"><div class="chart-price-marker-label" style="color:var(--text)">Actual</div></div>';
  let rangeBar='';
  if(avgSL!==null&&avgTP!==null){
    rangeBar='<div class="chart-price-range" style="left:'+pct(avgSL)+'%;width:'+(pct(avgTP)-pct(avgSL))+'%"></div>';
  }
  let legend='';
  if(avgSL!==null)legend+='<div><span class="chart-dot" style="background:var(--sell)"></span>Stop Loss: $'+fmt(avgSL)+'</div>';
  if(avgEntry!==null)legend+='<div><span class="chart-dot" style="background:var(--accent)"></span>Entrada: $'+fmt(avgEntry)+'</div>';
  if(avgTP!==null)legend+='<div><span class="chart-dot" style="background:var(--buy)"></span>Take Profit: $'+fmt(avgTP)+'</div>';
  if(currentPrice!==null)legend+='<div><span class="chart-dot" style="background:var(--text)"></span>Actual: $'+fmt(currentPrice)+'</div>';
  return '<div class="chart-prices">'
    +'<div class="chart-section-title">Niveles de precio</div>'
    +'<div class="chart-price-bar">'+rangeBar+markers+'</div>'
    +'<div class="chart-price-legend">'+legend+'</div>'
    +'</div>';
}

/* ── OCO Chart: mini price history fetch ─────────────────── */
var _chartDataCache={};
async function fetchMiniPriceHistory(symbol,interval,limit){
  limit=limit||30;
  try{
    var resp=await fetch('https://api.binance.com/api/v3/klines?symbol='+encodeURIComponent(symbol)+'&interval='+interval+'&limit='+limit);
    var data=await resp.json();
    return data.map(function(k){return parseFloat(k[4])});
  }catch(e){return []}
}

/* ── OCO Chart: main render ──────────────────────────────── */
function renderOCOChart(stratResults,currentPrice,recipeId,opts){
  opts=opts||{};
  var entries=[],sls=[],tps=[],isBuy=true;
  if(stratResults&&stratResults.length){
    stratResults.forEach(function(sr){
      if(sr.entry)entries.push(sr.entry);
      if(sr.stop_loss)sls.push(sr.stop_loss);
      if(sr.take_profit)tps.push(sr.take_profit);
    });
    var buyC=stratResults.filter(function(s){return s.recommendation==='BUY'}).length;
    var sellC=stratResults.filter(function(s){return s.recommendation==='SELL'}).length;
    isBuy=buyC>=sellC;
  }
  var avgEntry=opts.entryOverride||(entries.length?entries.reduce(function(a,b){return a+b},0)/entries.length:null);
  var avgSL=opts.slOverride||(sls.length?sls.reduce(function(a,b){return a+b},0)/sls.length:null);
  var avgTP=opts.tpOverride||(tps.length?tps.reduce(function(a,b){return a+b},0)/tps.length:null);
  var cur=opts.currentOverride||currentPrice;
  if(opts.slPct!=null&&avgEntry){
    avgSL=isBuy?avgEntry*(1-opts.slPct/100):avgEntry*(1+opts.slPct/100);
    avgTP=isBuy?avgEntry*(1+opts.tpPct/100):avgEntry*(1-opts.tpPct/100);
  }
  var allP=[avgEntry,avgSL,avgTP,cur].filter(function(p){return p!=null});
  var closePrices=opts.closePrices||[];
  closePrices.forEach(function(p){allP.push(p)});
  if(!allP.length){
    return '<div class="oco-chart-wrap"><div class="chart-section-title">Orden OCO</div>'
      +'<div style="color:var(--muted);font-size:.82rem;text-align:center;padding:20px">Sin datos de precio disponibles</div></div>';
  }
  var W=480,H=220,ML=65,MR=25,MT=25,MB=20;
  var cW=W-ML-MR,cH=H-MT-MB;
  var minP=Math.min.apply(null,allP)*0.996;
  var maxP=Math.max.apply(null,allP)*1.004;
  var rng=maxP-minP;if(rng<0.0001)rng=maxP*0.01;
  function yP(v){return MT+cH-((v-minP)/rng*cH)}
  function fmtP(v){return v>=1000?v.toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2}):v.toFixed(v>=1?4:6)}
  var svg='<svg class="oco-chart-svg" viewBox="0 0 '+W+' '+H+'" xmlns="http://www.w3.org/2000/svg">';
  /* grid lines */
  if(avgSL!=null)svg+='<line x1="'+ML+'" y1="'+yP(avgSL)+'" x2="'+(W-MR)+'" y2="'+yP(avgSL)+'" stroke="#2a3050" stroke-dasharray="4,4" stroke-width="1"/>';
  if(avgEntry!=null)svg+='<line x1="'+ML+'" y1="'+yP(avgEntry)+'" x2="'+(W-MR)+'" y2="'+yP(avgEntry)+'" stroke="#2a3050" stroke-dasharray="4,4" stroke-width="1"/>';
  if(avgTP!=null)svg+='<line x1="'+ML+'" y1="'+yP(avgTP)+'" x2="'+(W-MR)+'" y2="'+yP(avgTP)+'" stroke="#2a3050" stroke-dasharray="4,4" stroke-width="1"/>';
  /* Y-axis labels */
  if(avgSL!=null)svg+='<text x="'+(ML-4)+'" y="'+(yP(avgSL)+1)+'" text-anchor="end" fill="#ef4444" font-size="8" font-weight="700" dominant-baseline="central">$'+fmtP(avgSL)+'</text>';
  if(avgEntry!=null)svg+='<text x="'+(ML-4)+'" y="'+(yP(avgEntry)+1)+'" text-anchor="end" fill="#e2e8f0" font-size="8" font-weight="700" dominant-baseline="central">$'+fmtP(avgEntry)+'</text>';
  if(avgTP!=null)svg+='<text x="'+(ML-4)+'" y="'+(yP(avgTP)+1)+'" text-anchor="end" fill="#22c55e" font-size="8" font-weight="700" dominant-baseline="central">$'+fmtP(avgTP)+'</text>';
  /* mini price history line */
  if(closePrices.length>1){
    var pts=[];
    var lineEndX=ML+cW*0.65;
    var lineStartX=ML;
    for(var i=0;i<closePrices.length;i++){
      var px=lineStartX+(lineEndX-lineStartX)*i/(closePrices.length-1);
      pts.push(px.toFixed(1)+','+yP(closePrices[i]).toFixed(1));
    }
    svg+='<polyline points="'+pts.join(' ')+'" fill="none" stroke="#4a5370" stroke-width="1.5" stroke-linejoin="round"/>';
  }
  /* point A (entry) */
  var xA=ML+cW*0.70;
  if(avgEntry!=null){
    var yA=yP(avgEntry);
    svg+='<circle cx="'+xA+'" cy="'+yA+'" r="5" fill="#1a1f32" stroke="#e2e8f0" stroke-width="2"/>';
    svg+='<text x="'+xA+'" y="'+(yA-12)+'" text-anchor="middle" fill="#e2e8f0" font-size="11" font-weight="800">A</text>';
  }
  /* OCO dashed legs + points B and C */
  var xBC=ML+cW*0.90;
  if(avgTP!=null&&avgEntry!=null){
    var yB=yP(avgTP);
    svg+='<line x1="'+xA+'" y1="'+yP(avgEntry)+'" x2="'+xBC+'" y2="'+yB+'" stroke="#4a5370" stroke-dasharray="6,4" stroke-width="1.5"/>';
    svg+='<circle cx="'+xBC+'" cy="'+yB+'" r="5" fill="#f59e0b"/>';
    svg+='<text x="'+(xBC+10)+'" y="'+(yB-8)+'" fill="#f59e0b" font-size="11" font-weight="800">\u2265B</text>';
    svg+='<text x="'+(xBC+10)+'" y="'+(yB+6)+'" fill="#5a6480" font-size="8" font-weight="600">TP $'+fmtP(avgTP)+'</text>';
    /* projection dashed line from B continuing */
    var xEnd=W-MR+5;
    var yEnd=isBuy?yB-(xEnd-xBC)*0.3:yB+(xEnd-xBC)*0.3;
    yEnd=Math.max(MT,Math.min(H-MB,yEnd));
    svg+='<line x1="'+xBC+'" y1="'+yB+'" x2="'+xEnd+'" y2="'+yEnd+'" stroke="#f59e0b" stroke-dasharray="4,3" stroke-width="1"/>';
  }
  if(avgSL!=null&&avgEntry!=null){
    var yC=yP(avgSL);
    svg+='<line x1="'+xA+'" y1="'+yP(avgEntry)+'" x2="'+xBC+'" y2="'+yC+'" stroke="#4a5370" stroke-dasharray="6,4" stroke-width="1.5"/>';
    svg+='<circle cx="'+xBC+'" cy="'+yC+'" r="5" fill="#f59e0b"/>';
    svg+='<text x="'+(xBC+10)+'" y="'+(yC-8)+'" fill="#f59e0b" font-size="11" font-weight="800">C</text>';
    svg+='<text x="'+(xBC+10)+'" y="'+(yC+6)+'" fill="#5a6480" font-size="8" font-weight="600">SL $'+fmtP(avgSL)+'</text>';
    /* projection dashed line from C continuing */
    var xEnd2=W-MR+5;
    var yEnd2=isBuy?yC+(xEnd2-xBC)*0.3:yC-(xEnd2-xBC)*0.3;
    yEnd2=Math.max(MT,Math.min(H-MB,yEnd2));
    svg+='<line x1="'+xBC+'" y1="'+yC+'" x2="'+xEnd2+'" y2="'+yEnd2+'" stroke="#f59e0b" stroke-dasharray="4,3" stroke-width="1"/>';
  }
  /* current price horizontal dotted line */
  if(cur!=null){
    var yCur=yP(cur);
    svg+='<line x1="'+ML+'" y1="'+yCur+'" x2="'+(W-MR)+'" y2="'+yCur+'" stroke="#e2e8f0" stroke-opacity="0.2" stroke-dasharray="2,3" stroke-width="1"/>';
    svg+='<text x="'+(ML-4)+'" y="'+(yCur+1)+'" text-anchor="end" fill="#5a6480" font-size="7" font-weight="600" dominant-baseline="central">Actual</text>';
  }
  svg+='</svg>';
  /* legend */
  var leg='<div class="oco-chart-legend">';
  if(avgEntry!=null)leg+='<div class="oco-chart-legend-item"><div class="oco-chart-legend-dot" style="background:#e2e8f0"></div>Entrada: $'+fmtP(avgEntry)+'</div>';
  if(avgTP!=null)leg+='<div class="oco-chart-legend-item"><div class="oco-chart-legend-dot" style="background:#22c55e"></div>TP: $'+fmtP(avgTP)+'</div>';
  if(avgSL!=null)leg+='<div class="oco-chart-legend-item"><div class="oco-chart-legend-dot" style="background:#ef4444"></div>SL: $'+fmtP(avgSL)+'</div>';
  if(cur!=null)leg+='<div class="oco-chart-legend-item"><div class="oco-chart-legend-dot" style="background:#5a6480"></div>Actual: $'+fmtP(cur)+'</div>';
  leg+='</div>';
  return '<div class="oco-chart-wrap" id="oco-chart-'+recipeId+'">'
    +'<div class="chart-section-title">Orden OCO</div>'
    +svg+leg+'</div>';
}

/* ── OCO Chart: reactive update from SL/TP inputs ────────── */
function updateOCOChartFromInputs(recipeId){
  var cached=_chartDataCache[recipeId];
  if(!cached)return;
  var slPct=parseFloat(document.getElementById('inlineSlPct-'+recipeId).value)||2;
  var tpPct=parseFloat(document.getElementById('inlineTpPct-'+recipeId).value)||4;
  var container=document.getElementById('oco-chart-'+recipeId);
  if(!container)return;
  var html=renderOCOChart(cached.stratResults,cached.currentPrice,recipeId,{
    slPct:slPct,tpPct:tpPct,closePrices:cached.closePrices
  });
  container.outerHTML=html;
}

/* ── OCO Chart: closed trade render ──────────────────────── */
function renderOCOChartClosed(pathData){
  var closes=pathData.closes||[];
  var entryP=pathData.entry_price;
  var exitP=pathData.exit_price;
  var sl=pathData.stop_loss;
  var tp=pathData.take_profit;
  var exitType=pathData.exit_type;
  var side=pathData.side;
  var isBuy=side==='BUY';
  var allP=[entryP,exitP,sl,tp].filter(function(p){return p!=null});
  closes.forEach(function(p){allP.push(p)});
  if(!allP.length)return '<div style="color:var(--muted);font-size:.82rem;padding:10px;text-align:center">Sin datos de precio</div>';
  var W=480,H=200,ML=65,MR=25,MT=20,MB=20;
  var cW=W-ML-MR,cH=H-MT-MB;
  var minP=Math.min.apply(null,allP)*0.996;
  var maxP=Math.max.apply(null,allP)*1.004;
  var rng=maxP-minP;if(rng<0.0001)rng=maxP*0.01;
  function yP(v){return MT+cH-((v-minP)/rng*cH)}
  function fmtP(v){return v>=1000?v.toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2}):v.toFixed(v>=1?4:6)}
  var svg='<svg class="oco-chart-svg" viewBox="0 0 '+W+' '+H+'" xmlns="http://www.w3.org/2000/svg">';
  /* SL/TP grid lines */
  if(sl!=null)svg+='<line x1="'+ML+'" y1="'+yP(sl)+'" x2="'+(W-MR)+'" y2="'+yP(sl)+'" stroke="#ef4444" stroke-opacity="0.25" stroke-dasharray="4,4" stroke-width="1"/>';
  if(tp!=null)svg+='<line x1="'+ML+'" y1="'+yP(tp)+'" x2="'+(W-MR)+'" y2="'+yP(tp)+'" stroke="#22c55e" stroke-opacity="0.25" stroke-dasharray="4,4" stroke-width="1"/>';
  /* Y-axis labels */
  if(sl!=null)svg+='<text x="'+(ML-4)+'" y="'+(yP(sl)+1)+'" text-anchor="end" fill="#ef4444" font-size="8" font-weight="700" dominant-baseline="central">SL $'+fmtP(sl)+'</text>';
  if(tp!=null)svg+='<text x="'+(ML-4)+'" y="'+(yP(tp)+1)+'" text-anchor="end" fill="#22c55e" font-size="8" font-weight="700" dominant-baseline="central">TP $'+fmtP(tp)+'</text>';
  if(entryP!=null)svg+='<text x="'+(ML-4)+'" y="'+(yP(entryP)+1)+'" text-anchor="end" fill="#e2e8f0" font-size="8" font-weight="700" dominant-baseline="central">$'+fmtP(entryP)+'</text>';
  /* price path polyline */
  if(closes.length>1){
    var pts=[];
    for(var i=0;i<closes.length;i++){
      var px=ML+cW*i/(closes.length-1);
      pts.push(px.toFixed(1)+','+yP(closes[i]).toFixed(1));
    }
    svg+='<polyline points="'+pts.join(' ')+'" fill="none" stroke="#4a5370" stroke-width="1.5" stroke-linejoin="round"/>';
    /* shaded P&L area */
    if(entryP!=null&&exitP!=null){
      var isProfit=(isBuy&&exitP>entryP)||(!isBuy&&exitP<entryP);
      var fillColor=isProfit?'rgba(34,197,94,0.08)':'rgba(239,68,68,0.08)';
      var yEntry=yP(entryP);
      var areaPoints=pts.join(' ')+' '+(ML+cW)+','+yEntry+' '+ML+','+yEntry;
      svg+='<polygon points="'+areaPoints+'" fill="'+fillColor+'"/>';
    }
  }
  /* entry point */
  if(entryP!=null){
    var xEntry=ML;
    if(closes.length>0)xEntry=ML;
    var yE=yP(entryP);
    var entryColor=isBuy?'#22c55e':'#ef4444';
    svg+='<circle cx="'+xEntry+'" cy="'+yE+'" r="5" fill="'+entryColor+'"/>';
    svg+='<text x="'+(xEntry+10)+'" y="'+(yE-8)+'" fill="'+entryColor+'" font-size="10" font-weight="800">Entrada</text>';
  }
  /* exit point */
  if(exitP!=null&&closes.length>1){
    var xExit=ML+cW;
    var yEx=yP(exitP);
    var exitColor=exitType==='TP'?'#22c55e':'#ef4444';
    var exitLabel=exitType==='TP'?'TP Alcanzado':'SL Alcanzado';
    svg+='<circle cx="'+xExit+'" cy="'+yEx+'" r="5" fill="'+exitColor+'"/>';
    svg+='<text x="'+(xExit-10)+'" y="'+(yEx-10)+'" text-anchor="end" fill="'+exitColor+'" font-size="10" font-weight="800">'+exitLabel+'</text>';
  }
  /* entry horizontal line */
  if(entryP!=null){
    svg+='<line x1="'+ML+'" y1="'+yP(entryP)+'" x2="'+(W-MR)+'" y2="'+yP(entryP)+'" stroke="#e2e8f0" stroke-opacity="0.15" stroke-dasharray="2,3" stroke-width="1"/>';
  }
  svg+='</svg>';
  /* P&L summary below */
  var pnlHtml='';
  if(entryP&&exitP){
    var pnl=isBuy?((exitP-entryP)/entryP*100):((entryP-exitP)/entryP*100);
    var pnlColor=pnl>=0?'#22c55e':'#ef4444';
    var pnlSign=pnl>=0?'+':'';
    pnlHtml='<div style="text-align:center;margin-top:8px;font-size:.82rem">'
      +'<span style="color:'+pnlColor+';font-weight:800">'+pnlSign+pnl.toFixed(2)+'%</span>'
      +' <span style="color:var(--muted)">('+side+' '+fmtP(entryP)+' \u2192 '+fmtP(exitP)+')</span></div>';
  }
  return '<div class="oco-chart-wrap"><div class="chart-section-title">Operaci\u00f3n cerrada</div>'+svg+pnlHtml+'</div>';
}

async function loadClosedTradeChart(tradeId){
  var container=document.getElementById('closed-chart-'+tradeId);
  if(!container)return;
  container.innerHTML='<div style="text-align:center;padding:10px"><div class="spinner" style="margin:0 auto"></div></div>';
  try{
    var data=await api('GET','/trade/operations/'+tradeId+'/price-path');
    container.innerHTML=renderOCOChartClosed(data);
  }catch(e){
    container.innerHTML='<div style="color:var(--sell);font-size:.82rem;padding:10px">'+e.message+'</div>';
  }
}

async function saveInlineThresholds(recipeId){
  var buyPct=parseFloat(document.getElementById('inlineBuyTh-'+recipeId).value);
  var sellPct=parseFloat(document.getElementById('inlineSellTh-'+recipeId).value);
  var autoPct=parseFloat(document.getElementById('inlineAutoTh-'+recipeId).value);
  var autoStrPct=parseFloat(document.getElementById('inlineAutoStrTh-'+recipeId).value)||0;
  var buyQty=parseFloat(document.getElementById('inlineBuyQty-'+recipeId).value)||0;
  var sellQty=parseFloat(document.getElementById('inlineSellQty-'+recipeId).value)||0;
  var strengthThPct=parseFloat(document.getElementById('inlineStrengthTh-'+recipeId).value)||0;
  var confirmMin=parseFloat(document.getElementById('inlineConfirmMin-'+recipeId).value)||0;
  var confirmSec=parseInt(document.getElementById('inlineConfirmSec-'+recipeId).value)||0;
  var slPct=parseFloat(document.getElementById('inlineSlPct-'+recipeId).value);
  var tpPct=parseFloat(document.getElementById('inlineTpPct-'+recipeId).value);
  var maxPct=parseFloat(document.getElementById('inlineMaxPct-'+recipeId).value);
  if(isNaN(buyPct)||buyPct<10||buyPct>100)return toast('Umbral de compra debe estar entre 10% y 100%','error');
  if(isNaN(sellPct)||sellPct<10||sellPct>100)return toast('Umbral de venta debe estar entre 10% y 100%','error');
  if(isNaN(strengthThPct)||strengthThPct<0||strengthThPct>100)return toast('Umbral de fuerza debe estar entre 0% y 100%','error');
  if(isNaN(autoPct)||autoPct<0||autoPct>100)return toast('Umbral auto debe estar entre 0% y 100%','error');
  if(isNaN(confirmMin)||confirmMin<0||confirmMin>1440)return toast('Confirmaci\u00f3n debe estar entre 0 y 1440 minutos','error');
  if(isNaN(slPct)||slPct<0.1||slPct>50)return toast('Stop-Loss debe estar entre 0.1% y 50%','error');
  if(isNaN(tpPct)||tpPct<0.1||tpPct>100)return toast('Take-Profit debe estar entre 0.1% y 100%','error');
  if(isNaN(maxPct)||maxPct<0.1||maxPct>100)return toast('Max orden debe estar entre 0.1% y 100%','error');
  var buyTh=buyPct/100,sellTh=sellPct/100,autoTh=autoPct/100,autoStrTh=autoStrPct/100,strengthTh=strengthThPct/100;
  if(autoTh>0&&(autoTh<buyTh||autoTh<sellTh))return toast('El umbral de auto-aprobacion debe ser >= que compra y venta','error');
  if(isNaN(autoStrPct)||autoStrPct<0||autoStrPct>100)return toast('Auto fuerza debe estar entre 0% y 100%','error');
  try{
    await api('PATCH','/recipe/'+recipeId,{buy_threshold:buyTh,sell_threshold:sellTh,auto_threshold:autoTh,auto_strength_threshold:autoStrTh,strength_threshold:strengthTh,buy_quantity:buyQty>0?buyQty:null,sell_quantity:sellQty>0?sellQty:null,buy_order_type:'oco',sell_order_type:'oco',confirmation_minutes:confirmMin,confirmation_seconds:confirmSec,stop_loss_pct:slPct,take_profit_pct:tpPct,max_order_pct:maxPct});
    toast('Umbrales actualizados','success');
    var savedEl=document.getElementById('inlineThSaved-'+recipeId);
    if(savedEl){savedEl.style.display='block';setTimeout(function(){savedEl.style.display='none'},3000)}
    await refreshChartPanel(recipeId,false);
    loadRecipes();
  }catch(e){toast('Error guardando umbrales: '+e.message,'error')}
}

/* ── TEST EXECUTE ──────────────────────────────────── */
async function testExecute(recipeId,side){
  var btnId=side==='BUY'?'btnTestBuy-'+recipeId:'btnTestSell-'+recipeId;
  var btn=document.getElementById(btnId);
  var label=side==='BUY'?'COMPRA':'VENTA';
  if(!confirm('Ejecutar TEST '+label+' con los parametros de la receta?\n\nEsto enviara una orden REAL a Binance.'))return;
  if(btn){btn.disabled=true;btn.textContent='Ejecutando...';}
  try{
    var res=await api('POST','/recipe/'+recipeId+'/test-execute/'+side,{});
    if(res.status==='filled'){
      toast('TEST '+label+' ejecutado: trade #'+res.trade_id+' ('+res.order_type+')','success');
    }else{
      toast('TEST '+label+' resultado: '+res.status+' — '+(res.result&&res.result.error?res.result.error:'ver detalle'),'error');
    }
    loadPendingApprovals();
    await refreshChartPanel(recipeId,false);
  }catch(e){
    toast('Error test '+label+': '+e.message,'error');
  }finally{
    if(btn){btn.disabled=false;btn.textContent='TEST '+side;}
  }
}

/* ── APPROVALS TAB ───────────────────────────────────── */
let _execApprovalId=null,_execSymbol='',_execSide='',_execOrderType='market';
async function loadPendingApprovals(){
  const loader=document.getElementById('approvalsLoader');
  const content=document.getElementById('approvalsContent');
  const _scrollY=window.scrollY;
  loader.classList.add('show');
  document.getElementById('execPanel').classList.add('hidden');
  try{
    const items=await api('GET','/recipe/pending-approvals');
    loader.classList.remove('show');
    if(!items.length){
      content.innerHTML='<div class="ops-empty"><div class="ops-empty-icon">&#9989;</div>'
        +'<div style="font-weight:700;margin-bottom:4px">Sin aprobaciones pendientes</div>'
        +'<div style="font-size:.82rem;color:var(--muted)">Cuando una receta activa detecte una se\u00f1al, aparecer\u00e1 ac\u00e1.</div></div>';
      return;
    }
    const isAdmin=USER&&USER.role==='admin';
    let h='';
    for(const a of items){
      const fmt=v=>v!=null?'$'+v.toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:6}):'\u2014';
      const sigColor=a.recommendation==='BUY'?'var(--buy)':'var(--sell)';
      const sigText=a.recommendation==='BUY'?'COMPRAR':'VENDER';
      const sigIcon=a.recommendation==='BUY'?'&#128994;':'&#128308;';
      const isAutoApproved=a.status==='approved';
      const scoreColor=a.final_score!=null?(a.final_score>0?'var(--buy)':'var(--sell)'):'var(--muted)';
      const dt=_localDt(a.created_at);
      const stratParts=a.strategies_used.split('+').map(function(sk){
        var lb=STRATEGY_LABELS[sk]||{name:sk,icon:''};
        return lb.icon+' '+lb.name;
      }).join(', ');
      var autoBadge=isAutoApproved?'<span style="display:inline-block;padding:2px 10px;border-radius:3px;font-size:.7rem;font-weight:700;background:var(--auto-badge-bg);color:var(--auto-badge);margin-left:8px">AUTO-APROBADA</span>':'';
      h+='<div class="card" style="padding:16px'+(isAutoApproved?';border-left:3px solid var(--auto-badge)':'')+'">'
        +'<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:10px">'
        +'<div style="display:flex;align-items:center;gap:10px">'
        +'<span style="font-size:1.3rem">'+sigIcon+'</span>'
        +'<div><strong style="font-size:1.05rem">'+a.symbol+'</strong>'
        +'<span style="color:'+sigColor+';font-weight:800;font-size:.95rem;margin-left:10px">'+sigText+'</span>'+autoBadge+'</div>'
        +'</div>'
        +'<div style="text-align:right;font-size:.75rem;color:var(--muted)">'+dt
        +'<br><span class="approval-elapsed" data-created="'+a.created_at+'" style="font-weight:700;color:var(--accent)"></span>'
        +(a.recipe_name?'<br><span style="color:var(--text);font-weight:600">'+a.recipe_name+'</span>':'')
        +'</div></div>'
        +'<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px;margin-bottom:10px">'
        +'<div style="background:var(--surface);padding:8px 10px;border-radius:4px"><div style="font-size:.65rem;color:var(--muted);text-transform:uppercase;font-weight:600">Score</div>'
        +'<div style="font-weight:800;font-size:.95rem;color:'+scoreColor+'">'+(a.final_score!=null?(a.final_score>=0?'+':'')+Math.round(a.final_score*100)+'%':'\u2014')+'</div></div>'
        +'<div style="background:var(--surface);padding:8px 10px;border-radius:4px"><div style="font-size:.65rem;color:var(--muted);text-transform:uppercase;font-weight:600">Entrada</div>'
        +'<div style="font-weight:700;font-size:.85rem;font-family:monospace">'+fmt(a.entry_price)+'</div></div>'
        +'<div style="background:var(--surface);padding:8px 10px;border-radius:4px"><div style="font-size:.65rem;color:var(--sell);text-transform:uppercase;font-weight:600">Stop Loss</div>'
        +'<div style="font-weight:700;font-size:.85rem;font-family:monospace;color:var(--sell)">'+fmt(a.stop_loss)+'</div></div>'
        +'<div style="background:var(--surface);padding:8px 10px;border-radius:4px"><div style="font-size:.65rem;color:var(--buy);text-transform:uppercase;font-weight:600">Take Profit</div>'
        +'<div style="font-weight:700;font-size:.85rem;font-family:monospace;color:var(--buy)">'+fmt(a.take_profit)+'</div></div>'
        +'</div>'
        +'<div style="font-size:.75rem;color:var(--muted);margin-bottom:8px">Estrategias: '+stratParts+'</div>';
      if(a.explanation){
        h+='<div style="font-size:.75rem;color:var(--muted);line-height:1.5;padding:8px 10px;background:var(--surface);border-radius:4px;margin-bottom:10px">'+a.explanation+'</div>';
      }
      if(isAdmin){
        if(isAutoApproved){
          h+='<div style="display:flex;gap:8px;flex-wrap:wrap">'
            +'<button class="btn btn-sm" style="background:var(--auto-badge-bg);color:var(--auto-badge);border:1px solid rgba(156,39,176,.3);flex:1;min-width:140px" onclick="_execApprovalId='+a.approval_id+';_execSymbol=\''+a.symbol+'\';_execSide=\''+a.recommendation+'\';showExecPanel(\''+(a.order_type||'market')+'\')">&#9654; Ejecutar orden</button>'
            +'<button class="btn btn-sm" style="background:rgba(239,68,68,.15);color:var(--sell);border:1px solid rgba(239,68,68,.3);min-width:100px" onclick="doRejectFromTab('+a.approval_id+')">&#10060; Rechazar</button>'
            +'<button class="btn btn-sm" style="background:rgba(239,68,68,.1);color:var(--sell);border:1px solid rgba(239,68,68,.25);min-width:80px" onclick="deletePendingApproval('+a.approval_id+')">&#128465; Borrar</button>'
            +'</div>';
        }else{
          h+='<div style="display:flex;gap:8px;flex-wrap:wrap">'
            +'<button class="btn btn-sm" style="background:rgba(34,197,94,.15);color:var(--buy);border:1px solid rgba(34,197,94,.3);flex:1;min-width:120px" onclick="doApproveFromTab('+a.approval_id+',\''+a.symbol+'\',\''+a.recommendation+'\',\''+(a.order_type||'market')+'\')">&#9989; Aprobar</button>'
            +'<button class="btn btn-sm" style="background:rgba(239,68,68,.15);color:var(--sell);border:1px solid rgba(239,68,68,.3);flex:1;min-width:120px" onclick="doRejectFromTab('+a.approval_id+')">&#10060; Rechazar</button>'
            +'<button class="btn btn-sm" style="background:rgba(239,68,68,.1);color:var(--sell);border:1px solid rgba(239,68,68,.25);min-width:80px" onclick="deletePendingApproval('+a.approval_id+')">&#128465; Borrar</button>'
            +'</div>';
        }
      }
      h+='</div>';
    }
    if(!isAdmin){
      h+='<div class="card" style="text-align:center;border-color:var(--hold);margin-top:12px"><div style="font-size:1.5rem;margin-bottom:6px">&#128274;</div>'
        +'<div style="font-weight:700">Solo administradores pueden aprobar</div>'
        +'<div style="color:var(--muted);font-size:.85rem">Tu rol es <strong>user</strong>.</div></div>';
    }
    content.innerHTML=h;
    _startElapsedTimer();
    requestAnimationFrame(function(){window.scrollTo(0,_scrollY)});
  }catch(e){loader.classList.remove('show');toast('Error cargando aprobaciones: '+e.message,'error')}
}

async function doApproveFromTab(approvalId,symbol,side,orderType){
  try{
    await api('POST','/approval/'+approvalId+'/approve',{reason:'Aprobado desde panel'});
    toast('Aprobada correctamente','success');
    _execApprovalId=approvalId;_execSymbol=symbol;_execSide=side||'';
    await loadPendingApprovals();
    showExecPanel(orderType||'market');
  }catch(e){toast('Error aprobando: '+e.message,'error')}
}
async function doRejectFromTab(approvalId){
  if(!confirm('Rechazar esta recomendaci\u00f3n?'))return;
  try{
    await api('POST','/approval/'+approvalId+'/reject',{reason:'Rechazado desde panel'});
    toast('Rechazada','warn');loadPendingApprovals();
  }catch(e){toast('Error rechazando: '+e.message,'error')}
}
async function deletePendingApproval(approvalId){
  if(!confirm('Eliminar esta aprobaci\u00f3n y su recomendaci\u00f3n?'))return;
  try{
    await api('DELETE','/approval/'+approvalId);
    toast('Eliminada','success');loadPendingApprovals();
  }catch(e){toast('Error eliminando: '+e.message,'error')}
}

function showExecPanel(orderType){
  var ot=orderType||'market';
  const panel=document.getElementById('execPanel');
  panel.classList.remove('hidden');
  const base=_execSymbol.replace(/USDT|FDUSD|BUSD$/,'');
  document.getElementById('execQtyHint').textContent='En moneda base. Ej: 0.01 '+base;
  document.getElementById('execNoKeysWarn').classList.toggle('hidden',!!USER.hasKeys);
  document.getElementById('execLoader').classList.remove('show');
  _execOrderType=ot;
  document.querySelectorAll('#execPanel .order-card').forEach(c=>c.classList.remove('selected'));
  var sel=document.querySelector('#execPanel .order-card[data-otype="'+ot+'"]');
  if(sel)sel.classList.add('selected');
  else document.querySelector('#execPanel .order-card[data-otype="market"]').classList.add('selected');
  // Fetch and display Binance balance
  var balBox=document.getElementById('execBalanceBox');
  var balContent=document.getElementById('execBalanceContent');
  balBox.classList.add('hidden');
  balContent.innerHTML='';
  if(USER.hasKeys&&_execSymbol){
    balContent.innerHTML='<span style="font-size:.8rem;color:var(--muted)">Consultando Binance...</span>';
    balBox.classList.remove('hidden');
    api('GET','/trade/balance/'+_execSymbol).then(function(d){
      var bals=d.balances||{};
      var baseB=bals[d.base]||{free:0,locked:0};
      var quoteB=bals[d.quote]||{free:0,locked:0};
      var side=_execSide||'BUY';
      var relevantAsset=side==='BUY'?d.quote:d.base;
      var relevantBal=side==='BUY'?quoteB:baseB;
      var otherAsset=side==='BUY'?d.base:d.quote;
      var otherBal=side==='BUY'?baseB:quoteB;
      var fmtN=function(v){return v<1?v.toFixed(8).replace(/0+$/,'').replace(/\.$/,'.0'):v.toFixed(4).replace(/0+$/,'').replace(/\.$/,'.0')};
      balContent.innerHTML=
        '<div style="flex:1;min-width:120px">'
        +'<div style="font-size:.65rem;color:var(--muted);font-weight:600;text-transform:uppercase">'+relevantAsset+' <span style="font-size:.6rem">('+( side==='BUY'?'para comprar':'para vender')+')</span></div>'
        +'<div style="font-weight:800;font-size:1.05rem;color:'+(relevantBal.free>0?'var(--buy)':'var(--sell)')+'">'+fmtN(relevantBal.free)+'</div>'
        +(relevantBal.locked>0?'<div style="font-size:.65rem;color:var(--muted)">Bloqueado: '+fmtN(relevantBal.locked)+'</div>':'')
        +'</div>'
        +'<div style="flex:1;min-width:120px">'
        +'<div style="font-size:.65rem;color:var(--muted);font-weight:600;text-transform:uppercase">'+otherAsset+'</div>'
        +'<div style="font-weight:700;font-size:.9rem">'+fmtN(otherBal.free)+'</div>'
        +(otherBal.locked>0?'<div style="font-size:.65rem;color:var(--muted)">Bloqueado: '+fmtN(otherBal.locked)+'</div>':'')
        +'</div>';
    }).catch(function(e){
      balContent.innerHTML='<span style="font-size:.75rem;color:var(--sell)">No se pudo obtener saldo: '+e.message+'</span>';
    });
  }
}
function hideExecPanel(){document.getElementById('execPanel').classList.add('hidden');_execApprovalId=null}
function selectExecOrderType(type,el){
  _execOrderType=type;
  document.querySelectorAll('#execPanel .order-card').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected');
}

async function doExecFromApprovals(){
  if(!_execApprovalId)return;
  if(!USER.hasKeys)return toast('Configura tus API keys de Binance primero (icono engranaje)','error');
  var qty=parseFloat(document.getElementById('execQty').value);
  if(!qty||qty<=0)return toast('Ingresa una cantidad valida mayor a 0','error');
  if(!confirm('\u26a0\ufe0f ATENCION: Orden REAL en Binance.\n\nPar: '+_execSymbol+'\nTipo: '+(_execOrderType==='oco'?'OCO':'Mercado')+'\nCantidad: '+qty+'\n\nConfirmas?'))return;
  var loader=document.getElementById('execLoader');
  loader.classList.add('show');
  try{
    var tr=await api('POST','/trade/execute',{approval_id:_execApprovalId,quantity:qty,order_type:_execOrderType});
    loader.classList.remove('show');
    var ok=tr.status==='filled';
    toast(ok?'Orden ejecutada en Binance':('Error ejecutando: '+(tr.result&&tr.result.error?tr.result.error:'La orden no se completo')),ok?'success':'error');
    hideExecPanel();
  }catch(e){loader.classList.remove('show');toast('Error de ejecucion: '+e.message,'error')}
}

/* ── APPROVAL TABS (Pendientes / Historial) ──────────── */
function showApprovalTab(tab,btn){
  document.querySelectorAll('#approvalTabs .analytics-tab').forEach(function(t){t.classList.remove('active')});
  btn.classList.add('active');
  document.getElementById('approvalPendingTab').style.display=tab==='pending'?'':'none';
  document.getElementById('approvalHistoryTab').style.display=tab==='history'?'':'none';
  if(tab==='history')loadApprovalHistory();
}

async function loadApprovalHistory(){
  var loader=document.getElementById('historyLoader');
  var content=document.getElementById('historyContent');
  var _scrollY=window.scrollY;
  loader.classList.add('show');
  try{
    var items=await api('GET','/approval/history');
    loader.classList.remove('show');
    if(!items.length){
      content.innerHTML='<div class="ops-empty"><div class="ops-empty-icon">&#128196;</div>'
        +'<div style="font-weight:700;margin-bottom:4px">Sin historial de aprobaciones</div>'
        +'<div style="font-size:.82rem;color:var(--muted)">Las aprobaciones procesadas aparecer\u00e1n ac\u00e1.</div></div>';
      return;
    }
    var isAdmin=USER&&USER.role==='admin';
    var counts={approved:0,rejected:0,pending:0,auto:0};
    items.forEach(function(a){
      if(a.status==='approved'){
        counts.approved++;
        if(a.review_reason&&a.review_reason.indexOf('Auto-aprobado')===0)counts.auto++;
      }else if(a.status==='rejected')counts.rejected++;
      else counts.pending++;
    });
    var summary='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:10px;margin-bottom:16px">'
      +'<div class="card" style="text-align:center;padding:12px"><div style="font-size:.65rem;text-transform:uppercase;color:var(--muted);margin-bottom:2px">Total</div><div style="font-size:1.4rem;font-weight:800">'+items.length+'</div></div>'
      +'<div class="card" style="text-align:center;padding:12px"><div style="font-size:.65rem;text-transform:uppercase;color:var(--muted);margin-bottom:2px">Aprobadas</div><div style="font-size:1.4rem;font-weight:800;color:var(--buy)">'+counts.approved+'</div></div>'
      +'<div class="card" style="text-align:center;padding:12px"><div style="font-size:.65rem;text-transform:uppercase;color:var(--muted);margin-bottom:2px">Auto-aprobadas</div><div style="font-size:1.4rem;font-weight:800;color:var(--accent)">'+counts.auto+'</div></div>'
      +'<div class="card" style="text-align:center;padding:12px"><div style="font-size:.65rem;text-transform:uppercase;color:var(--muted);margin-bottom:2px">Rechazadas</div><div style="font-size:1.4rem;font-weight:800;color:var(--sell)">'+counts.rejected+'</div></div>'
      +'<div class="card" style="text-align:center;padding:12px"><div style="font-size:.65rem;text-transform:uppercase;color:var(--muted);margin-bottom:2px">Pendientes</div><div style="font-size:1.4rem;font-weight:800;color:var(--hold)">'+counts.pending+'</div></div>'
      +'</div>';
    var h='';
    for(var i=0;i<items.length;i++){
      var a=items[i];
      var fmt=function(v){return v!=null?'$'+v.toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:6}):'\u2014'};
      var sigColor=a.recommendation==='BUY'?'var(--buy)':'var(--sell)';
      var sigText=a.recommendation==='BUY'?'COMPRA':'VENTA';
      var sigIcon=a.recommendation==='BUY'?'&#128994;':'&#128308;';
      var isAuto=a.review_reason&&a.review_reason.indexOf('Auto-aprobado')===0;
      var statusBadge='';
      if(a.status==='approved'&&isAuto)statusBadge='<span style="display:inline-block;padding:2px 10px;border-radius:3px;font-size:.72rem;font-weight:700;background:var(--auto-badge-bg);color:var(--auto-badge)">AUTO-APROBADA</span>';
      else if(a.status==='approved')statusBadge='<span style="display:inline-block;padding:2px 10px;border-radius:3px;font-size:.72rem;font-weight:700;background:rgba(34,197,94,.12);color:var(--buy)">APROBADA</span>';
      else if(a.status==='rejected')statusBadge='<span style="display:inline-block;padding:2px 10px;border-radius:3px;font-size:.72rem;font-weight:700;background:rgba(239,68,68,.12);color:var(--sell)">RECHAZADA</span>';
      else statusBadge='<span style="display:inline-block;padding:2px 10px;border-radius:3px;font-size:.72rem;font-weight:700;background:rgba(255,214,0,.12);color:var(--hold)">PENDIENTE</span>';
      var scoreColor=a.final_score!=null?(a.final_score>0?'var(--buy)':'var(--sell)'):'var(--muted)';
      var dt=_localDt(a.created_at);
      var reviewDt=a.reviewed_at?_localDt(a.reviewed_at):'';
      var stratParts=a.strategies_used.split('+').map(function(sk){var lb=STRATEGY_LABELS[sk]||{name:sk,icon:''};return lb.icon+' '+lb.name}).join(', ');
      h+='<div class="card" style="padding:14px" id="hist-card-'+a.approval_id+'">'
        +'<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:6px;margin-bottom:8px">'
        +'<div style="display:flex;align-items:center;gap:8px">'
        +'<span style="font-size:1.2rem">'+sigIcon+'</span>'
        +'<strong style="font-size:1rem">'+a.symbol+'</strong>'
        +'<span style="color:'+sigColor+';font-weight:800;font-size:.9rem">'+sigText+'</span>'
        +statusBadge
        +'</div>'
        +'<div style="text-align:right;font-size:.72rem;color:var(--muted)">'+dt
        +(a.recipe_name?'<br><span style="color:var(--text);font-weight:600">'+a.recipe_name+'</span>':'')
        +'</div></div>'
        +'<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:6px;margin-bottom:8px">'
        +'<div style="background:var(--surface);padding:6px 8px;border-radius:4px"><div style="font-size:.6rem;color:var(--muted);text-transform:uppercase;font-weight:600">Score</div>'
        +'<div style="font-weight:800;font-size:.9rem;color:'+scoreColor+'">'+(a.final_score!=null?(a.final_score>=0?'+':'')+Math.round(a.final_score*100)+'%':'\u2014')+'</div></div>'
        +'<div style="background:var(--surface);padding:6px 8px;border-radius:4px"><div style="font-size:.6rem;color:var(--muted);text-transform:uppercase;font-weight:600">Entrada</div>'
        +'<div style="font-weight:700;font-size:.8rem;font-family:monospace">'+fmt(a.entry_price)+'</div></div>'
        +'<div style="background:var(--surface);padding:6px 8px;border-radius:4px"><div style="font-size:.6rem;color:var(--sell);text-transform:uppercase;font-weight:600">SL</div>'
        +'<div style="font-weight:700;font-size:.8rem;font-family:monospace;color:var(--sell)">'+fmt(a.stop_loss)+'</div></div>'
        +'<div style="background:var(--surface);padding:6px 8px;border-radius:4px"><div style="font-size:.6rem;color:var(--buy);text-transform:uppercase;font-weight:600">TP</div>'
        +'<div style="font-weight:700;font-size:.8rem;font-family:monospace;color:var(--buy)">'+fmt(a.take_profit)+'</div></div>'
        +'</div>'
        +'<div style="font-size:.72rem;color:var(--muted);margin-bottom:6px">'+stratParts+'</div>';
      if(a.review_reason){
        h+='<div style="font-size:.72rem;color:var(--muted);padding:6px 8px;background:var(--surface);border-radius:4px;margin-bottom:6px">'
          +(reviewDt?'<span style="font-weight:600">'+reviewDt+'</span> \u2014 ':'')+a.review_reason+'</div>';
      }
      if(isAdmin){
        h+='<div style="display:flex;gap:8px;justify-content:flex-end">';
        if(a.status==='approved'){
          h+='<button class="btn btn-sm" style="background:rgba(34,197,94,.12);color:var(--buy);border:1px solid rgba(34,197,94,.25);font-size:.75rem" onclick="_execApprovalId='+a.approval_id+';_execSymbol=\''+a.symbol+'\';_execSide=\''+(a.recommendation||'')+'\';showExecPanel(\''+(a.order_type||'market')+'\')">&#9654; Ejecutar</button>';
        }
        h+='<button class="btn btn-sm" style="background:rgba(239,68,68,.1);color:var(--sell);border:1px solid rgba(239,68,68,.25);font-size:.75rem" onclick="deleteApproval('+a.approval_id+')">&#128465; Eliminar</button>'
          +'</div>';
      }
      h+='</div>';
    }
    content.innerHTML=summary+h;
    requestAnimationFrame(function(){window.scrollTo(0,_scrollY)});
  }catch(e){loader.classList.remove('show');toast('Error cargando historial: '+e.message,'error')}
}

async function deleteApproval(id){
  if(!confirm('Eliminar esta aprobaci\u00f3n y su recomendaci\u00f3n asociada?'))return;
  try{
    await api('DELETE','/approval/'+id);
    toast('Eliminada','success');
    var card=document.getElementById('hist-card-'+id);
    if(card)card.remove();
  }catch(e){toast('Error eliminando: '+e.message,'error')}
}

/* ── OPERATIONS TAB ──────────────────────────────────── */
let _analyticsLoaded=false;
function showOpsTab(tab,btn){
  document.querySelectorAll('#opsTabs .analytics-tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('opsTabContent').style.display=tab==='operations'?'':'none';
  document.getElementById('analyticsTabContent').style.display=tab==='analytics'?'':'none';
  if(tab==='analytics'&&!_analyticsLoaded)loadAnalytics();
}

async function loadOperations(){
  const loader=document.getElementById('opsLoader');
  const content=document.getElementById('opsContent');
  const _scrollY=window.scrollY;
  loader.classList.add('show');_analyticsLoaded=false;
  try{
    const ops=await api('GET','/trade/operations/enriched');
    loader.classList.remove('show');
    if(!ops.length){
      content.innerHTML='<div class="ops-empty"><div class="ops-empty-icon">&#128202;</div>'
        +'<div style="font-weight:700;margin-bottom:4px">No ten\u00e9s operaciones todav\u00eda</div>'
        +'<div style="font-size:.82rem;color:var(--muted)">Cuando ejecutes un trade, va a aparecer ac\u00e1.</div></div>';
      return;
    }
    const fmt=function(v){return v!=null?'$'+v.toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:8}):'\u2014'};
    /* Split active vs closed */
    var activeOps=[],closedOps=[];
    for(var i=0;i<ops.length;i++){
      if(ops[i].is_closed) closedOps.push(ops[i]);
      else activeOps.push(ops[i]);
    }
    /* Summary cards */
    var totalPnl=0;closedOps.forEach(function(o){if(o.net_pnl_abs!=null)totalPnl+=o.net_pnl_abs;});
    var pnlColor=totalPnl>=0?'var(--buy)':'var(--sell)';
    var pnlSign=totalPnl>=0?'+':'';
    var summary='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(90px,1fr));gap:8px;margin-bottom:14px">'
      +'<div class="card" style="text-align:center;padding:12px"><div style="font-size:.65rem;text-transform:uppercase;color:var(--muted);margin-bottom:3px">Total</div><div style="font-size:1.4rem;font-weight:800">'+ops.length+'</div></div>'
      +'<div class="card" style="text-align:center;padding:12px"><div style="font-size:.65rem;text-transform:uppercase;color:var(--muted);margin-bottom:3px">Activas</div><div style="font-size:1.4rem;font-weight:800;color:var(--accent)">'+activeOps.filter(function(o){return o.is_active}).length+'</div></div>'
      +'<div class="card" style="text-align:center;padding:12px"><div style="font-size:.65rem;text-transform:uppercase;color:var(--muted);margin-bottom:3px">Cerradas</div><div style="font-size:1.4rem;font-weight:800;color:var(--accent)">'+closedOps.length+'</div></div>'
      +(closedOps.length?'<div class="card" style="text-align:center;padding:12px"><div style="font-size:.65rem;text-transform:uppercase;color:var(--muted);margin-bottom:3px">P&L Neto</div><div style="font-size:1.4rem;font-weight:800;color:'+pnlColor+'">'+pnlSign+totalPnl.toFixed(2)+' USD</div></div>':'')
      +'</div>';
    var html=summary;
    /* Active section */
    if(activeOps.length) html+=_buildActiveTable(activeOps,fmt);
    /* History section */
    html+=_buildHistorySection(closedOps,fmt);
    content.innerHTML=html;
    _updateOpsElapsed();_startOpsElapsedTimer();
    requestAnimationFrame(function(){window.scrollTo(0,_scrollY)});
  }catch(e){loader.classList.remove('show');toast('Error cargando operaciones: '+e.message,'error')}
}
function _buildActiveTable(ops,fmt){
  var h='<div class="ops-section-title">Operaciones Activas <span class="ops-section-count">'+ops.length+'</span></div>';
  h+='<div class="card" style="padding:0;overflow:hidden"><table class="ops-table-active">'
    +'<colgroup><col class="ca-par"><col class="ca-tipo"><col class="ca-entry"><col class="ca-sl"><col class="ca-tp"><col class="ca-estado"><col class="ca-acc"></colgroup>'
    +'<thead><tr><th>Par / Lado</th><th>Tipo</th><th>Entrada</th><th>SL</th><th>TP</th><th>Estado</th><th>Acciones</th></tr></thead><tbody>';
  for(var i=0;i<ops.length;i++){
    var op=ops[i];
    var sideClass=op.side==='BUY'?'ops-side-buy':'ops-side-sell';
    var sideIcon=op.side==='BUY'?'&#9650;':'&#9660;';
    var sideText=op.side==='BUY'?'COMPRA':'VENTA';
    var typeText=op.order_type==='oco'?'OCO':op.order_type==='limit'?'Limit':'Market';
    var entryP=op.filled_price!=null?op.filled_price:op.price;
    /* Status badge */
    var badgeClass,statusText,elapsedHtml='';
    if(op.status==='filled'){
      if(op.order_type==='limit'&&!op.filled_price){badgeClass='active-waiting';statusText='Esperando';}
      else{badgeClass='active';statusText='Activa';}
      elapsedHtml='<div class="ops-elapsed" data-executed="'+op.executed_at+'" data-active="1" style="font-size:.62rem;color:var(--accent);font-weight:700;margin-top:2px"></div>';
    }else if(op.status==='invalid'){badgeClass='invalid';statusText='Inv\u00e1lida';}
    else{badgeClass='failed';statusText='Fallida';}
    /* Actions */
    var actions='<div style="display:flex;flex-wrap:wrap;gap:3px">';
    if(op.status==='filled'){
      actions+='<button class="track-btn" onclick="event.stopPropagation();toggleTrack('+op.id+',this)" title="Seguimiento">&#128200;</button>';
      if(op.is_active)actions+='<button class="track-btn" style="color:var(--sell)" onclick="event.stopPropagation();closeTrade('+op.id+')" title="Cerrar orden">&#10006;</button>';
      actions+='<button class="track-btn" onclick="event.stopPropagation();validateTrade('+op.id+')" title="Validar en Binance">&#9989;</button>';
    }
    actions+='<button class="del-btn" onclick="event.stopPropagation();deleteTrade('+op.id+')" title="Eliminar">&#128465;</button>';
    actions+='</div>';
    /* Row */
    h+='<tr class="data-row" onclick="toggleDetailRow('+op.id+')">'
      +'<td data-label="Par / Lado"><span class="ops-expand-icon" id="expand-icon-'+op.id+'">&#9654;</span>'
      +'<strong style="font-size:.78rem">'+op.symbol+'</strong> '
      +'<span class="'+sideClass+'" style="font-size:.7rem">'+sideIcon+' '+sideText+'</span>'
      +'<div style="font-size:.6rem;color:var(--muted);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="'+(op.recipe_name||'')+'">'+(op.recipe_name||'')+'</div>'
      +'</td>'
      +'<td data-label="Tipo" style="font-size:.7rem">'+typeText+'<div style="font-size:.6rem;color:var(--muted)">x'+(op.quantity!=null?op.quantity:'\u2014')+'</div></td>'
      +'<td data-label="Entrada" style="font-family:monospace;font-size:.75rem">'+fmt(entryP)+'</td>'
      +'<td data-label="SL" style="font-family:monospace;font-size:.75rem;color:var(--sell)">'+(op.stop_loss?fmt(op.stop_loss):'\u2014')+'</td>'
      +'<td data-label="TP" style="font-family:monospace;font-size:.75rem;color:var(--buy)">'+(op.take_profit?fmt(op.take_profit):'\u2014')+'</td>'
      +'<td data-label="Estado"><span class="ops-badge '+badgeClass+'">'+statusText+'</span>'+elapsedHtml
      +(op.validation_reason?'<div style="font-size:.58rem;color:var(--sell);margin-top:1px">'+op.validation_reason+'</div>':'')
      +(op.error_message&&!op.validation_reason?'<div style="font-size:.58rem;color:var(--sell);margin-top:1px;word-break:break-all">'+op.error_message.substring(0,60)+'</div>':'')
      +'</td>'
      +'<td data-label="Acciones">'+actions+'</td></tr>';
    h+='<tr id="detail-row-'+op.id+'" style="display:none"><td colspan="7" style="background:var(--surface);padding:0;border-bottom:2px solid var(--border)">'+_renderDetailPanel(op,fmt)+'</td></tr>';
    h+='<tr class="track-row" id="track-row-'+op.id+'" style="display:none"><td colspan="7"></td></tr>';
  }
  h+='</tbody></table></div>';
  return h;
}
function _buildHistorySection(ops,fmt){
  var h='<div class="ops-section-title">Historial <span class="ops-section-count">'+ops.length+'</span></div>';
  if(!ops.length){
    h+='<div style="text-align:center;padding:30px;color:var(--muted);font-size:.82rem">Sin operaciones cerradas todav\u00eda. Cuando una OCO alcance TP o SL, aparecer\u00e1 ac\u00e1.</div>';
    return h;
  }
  /* Summary cards for history */
  var wins=ops.filter(function(o){return o.net_pnl_pct!=null&&o.net_pnl_pct>0}).length;
  var losses=ops.filter(function(o){return o.net_pnl_pct!=null&&o.net_pnl_pct<=0}).length;
  var winRate=ops.length>0?Math.round(wins/ops.length*100):0;
  var totalPnl=0;ops.forEach(function(o){if(o.net_pnl_abs!=null)totalPnl+=o.net_pnl_abs;});
  var pC=totalPnl>=0?'var(--buy)':'var(--sell)',pS=totalPnl>=0?'+':'';
  h+='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:10px">'
    +'<div class="card" style="text-align:center;padding:10px"><div style="font-size:.6rem;text-transform:uppercase;color:var(--muted);margin-bottom:2px">Cerradas</div><div style="font-size:1.2rem;font-weight:800">'+ops.length+'</div></div>'
    +'<div class="card" style="text-align:center;padding:10px"><div style="font-size:.6rem;text-transform:uppercase;color:var(--muted);margin-bottom:2px">Ganadas</div><div style="font-size:1.2rem;font-weight:800;color:var(--buy)">'+wins+' <span style="font-size:.7rem;color:var(--muted)">('+winRate+'%)</span></div></div>'
    +'<div class="card" style="text-align:center;padding:10px"><div style="font-size:.6rem;text-transform:uppercase;color:var(--muted);margin-bottom:2px">Perdidas</div><div style="font-size:1.2rem;font-weight:800;color:var(--sell)">'+losses+'</div></div>'
    +'<div class="card" style="text-align:center;padding:10px"><div style="font-size:.6rem;text-transform:uppercase;color:var(--muted);margin-bottom:2px">P&L Neto</div><div style="font-size:1.2rem;font-weight:800;color:'+pC+'">'+pS+totalPnl.toFixed(2)+' USD</div></div></div>';
  /* History table */
  h+='<div class="card" style="padding:0;overflow:hidden"><table class="ops-table-history">'
    +'<colgroup><col class="ch-fecha"><col class="ch-par"><col class="ch-lado"><col class="ch-entry"><col class="ch-exit"><col class="ch-pnl"><col class="ch-tipo"><col class="ch-receta"></colgroup>'
    +'<thead><tr><th>Fecha</th><th>Par</th><th>Lado</th><th>Entrada</th><th>Salida</th><th>P&L</th><th>Salida</th><th>Receta</th></tr></thead><tbody>';
  for(var i=0;i<ops.length;i++){
    var op=ops[i];
    var _d=new Date(op.executed_at.endsWith('Z')?op.executed_at:op.executed_at+'Z');
    var dateStr=_d.toLocaleString('es-AR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',timeZone:_TZ});
    var sideClass=op.side==='BUY'?'ops-side-buy':'ops-side-sell';
    var sideIcon=op.side==='BUY'?'&#9650;':'&#9660;';
    var sideText=op.side==='BUY'?'COMPRA':'VENTA';
    var entryP=op.filled_price!=null?op.filled_price:op.price;
    /* P&L */
    var pnlHtml='\u2014';
    if(op.net_pnl_pct!=null){
      var pnlCls=op.net_pnl_pct>=0?'positive':'negative';
      var pnlSgn=op.net_pnl_pct>=0?'+':'';
      pnlHtml='<span class="pnl-value '+pnlCls+'">'+pnlSgn+op.net_pnl_pct.toFixed(2)+'%</span>';
      if(op.net_pnl_abs!=null) pnlHtml+='<div class="pnl-abs">'+pnlSgn+op.net_pnl_abs.toFixed(2)+' USD</div>';
    }else if(op.pnl_pct!=null){
      var pnlCls2=op.pnl_pct>=0?'positive':'negative';
      var pnlSgn2=op.pnl_pct>=0?'+':'';
      pnlHtml='<span class="pnl-value '+pnlCls2+'">'+pnlSgn2+op.pnl_pct.toFixed(2)+'%</span>';
    }
    /* Exit type badge */
    var exitBadge='\u2014';
    if(op.exit_type==='TP') exitBadge='<span class="ops-badge closed-tp">TP</span>';
    else if(op.exit_type==='SL') exitBadge='<span class="ops-badge closed-sl">SL</span>';
    else if(op.exit_type==='MANUAL') exitBadge='<span class="ops-badge closed-manual">Manual</span>';
    else exitBadge='<span class="ops-badge filled">OK</span>';
    /* Row */
    h+='<tr class="data-row" onclick="toggleDetailRow('+op.id+')">'
      +'<td data-label="Fecha" style="font-size:.7rem;white-space:nowrap"><span class="ops-expand-icon" id="expand-icon-'+op.id+'">&#9654;</span>'+dateStr+'</td>'
      +'<td data-label="Par"><strong style="font-size:.78rem">'+op.symbol+'</strong></td>'
      +'<td data-label="Lado" class="'+sideClass+'" style="font-size:.72rem" title="'+sideText+'">'+sideIcon+' '+(op.side==='BUY'?'C':'V')+'</td>'
      +'<td data-label="Entrada" style="font-family:monospace;font-size:.75rem">'+fmt(entryP)+'</td>'
      +'<td data-label="Salida" style="font-family:monospace;font-size:.75rem">'+(op.exit_price!=null?fmt(op.exit_price):'\u2014')+'</td>'
      +'<td data-label="P&L">'+pnlHtml+'</td>'
      +'<td data-label="Tipo" style="text-align:center">'+exitBadge+'</td>'
      +'<td data-label="Receta" style="font-size:.68rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="'+(op.recipe_name||'')+'">'+(op.recipe_name||'\u2014')+'</td>'
      +'</tr>';
    h+='<tr id="detail-row-'+op.id+'" style="display:none"><td colspan="8" style="background:var(--surface);padding:0;border-bottom:2px solid var(--border)">'+_renderDetailPanel(op,fmt)+'</td></tr>';
    h+='<tr class="track-row" id="track-row-'+op.id+'" style="display:none"><td colspan="8"></td></tr>';
  }
  h+='</tbody></table></div>';
  return h;
}

function _renderDetailPanel(op,fmt){
  /* Section 1: Prices */
  var p='<div class="detail-section"><div class="detail-section-title">Precios</div>';
  if(op.signal_price!=null)p+='<div class="detail-row-item"><span class="dl">Se\u00f1al (estrategia)</span><span class="dv">'+fmt(op.signal_price)+'</span></div>';
  p+='<div class="detail-row-item"><span class="dl">Entrada solicitada</span><span class="dv">'+fmt(op.price)+'</span></div>';
  if(op.filled_price!=null)p+='<div class="detail-row-item"><span class="dl">Ejecuci\u00f3n real</span><span class="dv">'+fmt(op.filled_price)+'</span></div>';
  if(op.stop_loss)p+='<div class="detail-row-item"><span class="dl">Stop Loss</span><span class="dv" style="color:var(--sell)">'+fmt(op.stop_loss)+'</span></div>';
  if(op.take_profit)p+='<div class="detail-row-item"><span class="dl">Take Profit</span><span class="dv" style="color:var(--buy)">'+fmt(op.take_profit)+'</span></div>';
  if(op.exit_price!=null)p+='<div class="detail-row-item"><span class="dl">Precio salida</span><span class="dv" style="font-weight:800">'+fmt(op.exit_price)+'</span></div>';
  p+='</div>';
  /* Section 2: Order info */
  var o='<div class="detail-section"><div class="detail-section-title">Orden</div>';
  o+='<div class="detail-row-item"><span class="dl">Tipo</span><span class="dv">'+op.order_type.toUpperCase()+'</span></div>';
  o+='<div class="detail-row-item"><span class="dl">Cantidad</span><span class="dv">'+(op.quantity!=null?op.quantity:'\u2014')+'</span></div>';
  if(op.total_commission!=null)o+='<div class="detail-row-item"><span class="dl">Comisi\u00f3n</span><span class="dv">'+op.total_commission.toFixed(6)+' '+(op.commission_asset||'')+'</span></div>';
  if(op.binance_order_id)o+='<div class="detail-row-item"><span class="dl">Order ID</span><span class="dv" style="font-size:.6rem">'+op.binance_order_id+'</span></div>';
  if(op.binance_order_list_id)o+='<div class="detail-row-item"><span class="dl">OCO List ID</span><span class="dv" style="font-size:.6rem">'+op.binance_order_list_id+'</span></div>';
  if(op.oco_status)o+='<div class="detail-row-item"><span class="dl">Estado OCO</span><span class="dv">'+op.oco_status+'</span></div>';
  o+='</div>';
  /* Section 3: Recipe & P&L */
  var r='<div class="detail-section"><div class="detail-section-title">Origen & P&L</div>';
  if(op.recipe_name)r+='<div class="detail-row-item"><span class="dl">Receta</span><span class="dv">'+op.recipe_name+'</span></div>';
  if(op.confidence!=null)r+='<div class="detail-row-item"><span class="dl">Confianza</span><span class="dv">'+op.confidence.toFixed(1)+'%</span></div>';
  if(op.net_pnl_pct!=null){
    var pC=op.net_pnl_pct>=0?'var(--buy)':'var(--sell)',pS=op.net_pnl_pct>=0?'+':'';
    r+='<div class="detail-row-item"><span class="dl">P&L Neto</span><span class="dv" style="color:'+pC+'">'+pS+op.net_pnl_pct.toFixed(2)+'%'+(op.net_pnl_abs!=null?' / '+pS+op.net_pnl_abs.toFixed(2)+' USD':'')+'</span></div>';
  }
  if(op.pnl_pct!=null&&op.net_pnl_pct==null){
    var pC2=op.pnl_pct>=0?'var(--buy)':'var(--sell)',pS2=op.pnl_pct>=0?'+':'';
    r+='<div class="detail-row-item"><span class="dl">P&L Bruto</span><span class="dv" style="color:'+pC2+'">'+pS2+op.pnl_pct.toFixed(2)+'%</span></div>';
  }
  if(op.exit_type)r+='<div class="detail-row-item"><span class="dl">Tipo salida</span><span class="dv">'+op.exit_type+'</span></div>';
  if(op.exit_time)r+='<div class="detail-row-item"><span class="dl">Fecha salida</span><span class="dv" style="font-size:.6rem">'+op.exit_time+'</span></div>';
  if(op.error_message)r+='<div class="detail-row-item"><span class="dl">Error</span><span class="dv" style="color:var(--sell);font-size:.6rem;word-break:break-all">'+op.error_message+'</span></div>';
  r+='</div>';
  /* Section 4: Filter adjustments (full width) */
  var f='';
  if(op.filter_adjustments&&op.filter_adjustments.length){
    f='<div class="detail-section detail-full" style="background:rgba(245,158,11,.05);border-color:rgba(245,158,11,.15)">'
      +'<div class="detail-section-title" style="color:var(--hold)">Ajustes de filtro Binance</div>';
    for(var i=0;i<op.filter_adjustments.length;i++)f+='<div style="font-size:.65rem;color:var(--muted);margin-bottom:2px">'+op.filter_adjustments[i]+'</div>';
    f+='</div>';
  }
  /* Section 5: Closed trade chart */
  var g='';
  if(op.exit_price!=null&&op.exit_type){
    g='<div class="detail-section detail-full">'
      +'<button class="oco-closed-btn" onclick="loadClosedTradeChart('+op.id+')">Ver gr\u00e1fico de operaci\u00f3n</button>'
      +'<div id="closed-chart-'+op.id+'" style="margin-top:8px"></div>'
      +'</div>';
  }
  return '<div class="detail-panel">'+p+o+r+f+g+'</div>';
}

function toggleDetailRow(tradeId){
  var row=document.getElementById('detail-row-'+tradeId);
  var icon=document.getElementById('expand-icon-'+tradeId);
  if(!row)return;
  if(row.style.display!=='none'){row.style.display='none';if(icon)icon.classList.remove('open')}
  else{row.style.display='';if(icon)icon.classList.add('open')}
}

/* ANALYTICS */
async function loadAnalytics(){
  const panel=document.getElementById('analyticsPanel'),loader=document.getElementById('analyticsLoader');
  if(!panel)return;if(loader)loader.classList.add('show');
  try{
    const a=await api('GET','/trade/analytics');if(loader)loader.classList.remove('show');_analyticsLoaded=true;
    if(!a.summary.total_trades){
      panel.innerHTML='<div class="ops-empty"><div class="ops-empty-icon">&#128202;</div>'
        +'<div style="font-weight:700;margin-bottom:4px">Sin operaciones cerradas</div>'
        +'<div style="font-size:.82rem;color:var(--muted)">Cuando una OCO se complete, las analiticas van a aparecer.</div></div>';return}
    renderAnalytics(panel,a);
  }catch(e){if(loader)loader.classList.remove('show');panel.innerHTML='<div style="padding:16px;color:var(--sell)">'+e.message+'</div>'}
}
function renderAnalytics(panel,a){
  const s=a.summary,pnlColor=s.net_pnl>=0?'var(--buy)':'var(--sell)',pnlSign=s.net_pnl>=0?'+':'';
  const fmtUsd=v=>(v>=0?'+':'')+v.toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2});
  let h='<div class="analytics-section"><div class="analytics-title">Analiticas de P&L</div>'
    +'<div class="analytics-grid">'
    +'<div class="analytics-card highlight"><div class="analytics-card-label">P&L Neto</div><div class="analytics-card-value" style="color:'+pnlColor+'">'+pnlSign+fmtUsd(s.net_pnl)+' USD</div></div>'
    +'<div class="analytics-card"><div class="analytics-card-label">Win Rate</div><div class="analytics-card-value" style="color:'+(s.win_rate>=50?'var(--buy)':'var(--sell)')+'">'+s.win_rate.toFixed(1)+'%</div></div>'
    +'<div class="analytics-card"><div class="analytics-card-label">Profit Factor</div><div class="analytics-card-value">'+(s.profit_factor!=null?s.profit_factor.toFixed(2):'\u2014')+'</div></div>'
    +'<div class="analytics-card"><div class="analytics-card-label">Trades</div><div class="analytics-card-value">'+s.total_trades+'</div><div style="font-size:.68rem;color:var(--muted)"><span style="color:var(--buy)">'+s.wins+'W</span> / <span style="color:var(--sell)">'+s.losses+'L</span></div></div>'
    +'<div class="analytics-card"><div class="analytics-card-label">Prom. Ganancia</div><div class="analytics-card-value" style="font-size:1rem;color:var(--buy)">'+fmtUsd(s.avg_win)+'</div></div>'
    +'<div class="analytics-card"><div class="analytics-card-label">Prom. Perdida</div><div class="analytics-card-value" style="font-size:1rem;color:var(--sell)">'+fmtUsd(s.avg_loss)+'</div></div>'
    +'<div class="analytics-card"><div class="analytics-card-label">Comisiones</div><div class="analytics-card-value" style="font-size:1rem;color:var(--sell)">-'+s.total_commissions.toFixed(2)+'</div></div>'
    +'</div>'
    +'<div class="analytics-tabs" id="periodTabs">'
    +'<button class="analytics-tab active" onclick="showPeriodTab(\'daily\',this)">Diario</button>'
    +'<button class="analytics-tab" onclick="showPeriodTab(\'monthly\',this)">Mensual</button></div>'
    +'<div id="analyticsDaily">'+buildPeriodTable(a.daily,'Fecha')+'</div>'
    +'<div id="analyticsMonthly" style="display:none">'+buildPeriodTable(a.monthly,'Mes')+'</div></div>';
  panel.innerHTML=h;
}
function buildPeriodTable(periods,label){
  if(!periods.length)return '<div style="padding:16px;text-align:center;color:var(--muted);font-size:.82rem">Sin datos</div>';
  const fmtUsd=v=>(v>=0?'+':'')+v.toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2});
  let t='<div class="card" style="padding:0;overflow-x:auto"><table class="analytics-table"><thead><tr>'
    +'<th>'+label+'</th><th>Trades</th><th>W</th><th>L</th><th>P&L Neto</th><th>Acumulado</th></tr></thead><tbody>';
  for(const p of periods.slice().reverse()){const cls=p.net_pnl>=0?'pnl-pos':'pnl-neg',cumCls=p.cumulative>=0?'pnl-pos':'pnl-neg';
    t+='<tr><td style="white-space:nowrap;font-weight:600">'+p.period+'</td><td>'+p.trades+'</td>'
      +'<td style="color:var(--buy)">'+p.wins+'</td><td style="color:var(--sell)">'+p.losses+'</td>'
      +'<td class="'+cls+'">'+fmtUsd(p.net_pnl)+' USD</td><td class="'+cumCls+'">'+fmtUsd(p.cumulative)+' USD</td></tr>'}
  t+='</tbody></table></div>';return t;
}
function showPeriodTab(tab,btn){
  document.querySelectorAll('#periodTabs .analytics-tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('analyticsDaily').style.display=tab==='daily'?'':'none';
  document.getElementById('analyticsMonthly').style.display=tab==='monthly'?'':'none';
}

/* OPS ELAPSED TIMER */
var _opsElapsedTimer=null;
function _startOpsElapsedTimer(){
  if(_opsElapsedTimer)return;
  _opsElapsedTimer=setInterval(_updateOpsElapsed,1000);
}
function _stopOpsElapsedTimer(){
  if(_opsElapsedTimer){clearInterval(_opsElapsedTimer);_opsElapsedTimer=null}
}
function _updateOpsElapsed(){
  var els=document.querySelectorAll('.ops-elapsed');
  if(!els.length){_stopOpsElapsedTimer();return}
  var now=Date.now();
  els.forEach(function(el){
    var dt=el.getAttribute('data-executed');
    if(!dt)return;
    var ts=new Date(dt.endsWith('Z')?dt:dt+'Z').getTime();
    var diff=Math.max(0,Math.floor((now-ts)/1000));
    var isActive=el.getAttribute('data-active')==='1';
    var d=Math.floor(diff/86400),h=Math.floor((diff%86400)/3600),m=Math.floor((diff%3600)/60),s=diff%60;
    var txt='';
    if(d>0)txt=d+'d '+h+'h '+m+'m';
    else if(h>0)txt=h+'h '+m+'m '+s+'s';
    else if(m>0)txt=m+'m '+s+'s';
    else txt=s+'s';
    el.textContent=txt;
  });
}

/* TRACKING */
let _trackTimers={};
function stopAllTracking(){Object.keys(_trackTimers).forEach(id=>{clearInterval(_trackTimers[id]);delete _trackTimers[id]})}
async function toggleTrack(tradeId,btn){
  const row=document.getElementById('track-row-'+tradeId);
  if(row.style.display!=='none'){row.style.display='none';btn.textContent='Seguimiento';
    if(_trackTimers[tradeId]){clearInterval(_trackTimers[tradeId]);delete _trackTimers[tradeId]}return}
  row.style.display='';btn.textContent='Cerrar';await refreshTrack(tradeId);
}
async function refreshTrack(tradeId){
  const _scrollY=window.scrollY;
  const row=document.getElementById('track-row-'+tradeId),cell=row.querySelector('td');
  try{const t=await api('GET','/trade/operations/'+tradeId+'/track');renderTrackPanel(cell,t);
    requestAnimationFrame(function(){window.scrollTo(0,_scrollY)});
  }catch(e){cell.innerHTML='<div style="padding:12px;color:var(--sell);font-size:.82rem">'+e.message+'</div>'}
}
function renderTrackPanel(cell,t){
  const pnlColor=t.pnl_pct>=0?'var(--buy)':'var(--sell)',pnlSign=t.pnl_pct>=0?'+':'';
  const evalClass=t.evaluation==='EN GANANCIA'?'ganancia':t.evaluation==='EN PERDIDA'?'perdida':t.evaluation==='SL ALCANZADO'?'sl':t.evaluation==='TP ALCANZADO'?'tp':'neutral';
  const fmt=v=>v!=null?'$'+v.toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:8}):'\u2014';
  let barPos=50;if(t.tp_progress_pct!=null)barPos=Math.max(0,Math.min(100,50+t.tp_progress_pct/2));
  let h='<div class="track-panel"><div class="track-header"><div><span class="track-eval '+evalClass+'">'+t.evaluation+'</span> <span class="track-elapsed">'+t.elapsed+'</span></div>'
    +'<div style="font-size:.68rem;color:var(--muted)">'+_localDtFull(t.timestamp)+'</div></div>'
    +'<div class="track-metric"><div class="track-metric-label">Precio actual</div><div class="track-metric-value">'+fmt(t.current_price)+'</div></div>'
    +'<div class="track-metric"><div class="track-metric-label">Precio entrada</div><div class="track-metric-value">'+fmt(t.entry_price)+'</div></div>'
    +'<div class="track-metric"><div class="track-metric-label">P&L</div><div class="track-metric-value" style="color:'+pnlColor+'">'+pnlSign+t.pnl_pct.toFixed(2)+'%</div>'
    +'<div style="font-size:.72rem;color:'+pnlColor+'">'+pnlSign+t.pnl_abs.toFixed(2)+' USD</div></div>'
    +'<div class="track-metric"><div class="track-metric-label">Risk/Reward</div><div style="display:flex;gap:8px;justify-content:center;margin-top:2px">'
    +'<div style="font-size:.68rem"><span style="color:var(--sell)">SL</span> '+(t.sl_distance_pct!=null?t.sl_distance_pct.toFixed(2)+'%':'\u2014')+'</div>'
    +'<div style="font-size:.68rem"><span style="color:var(--buy)">TP</span> '+(t.tp_distance_pct!=null?t.tp_distance_pct.toFixed(2)+'%':'\u2014')+'</div></div></div>'
    +'<div class="track-bar-wrap"><div class="track-bar-labels"><span>SL '+(t.stop_loss?fmt(t.stop_loss):'\u2014')+'</span><span>Entry '+fmt(t.entry_price)+'</span><span>TP '+(t.take_profit?fmt(t.take_profit):'\u2014')+'</span></div>'
    +'<div class="track-bar"><div class="track-bar-entry" style="left:50%"></div><div class="track-bar-marker" style="left:'+barPos+'%;background:'+pnlColor+'"></div></div></div>'
    +'<div class="track-actions"><button class="btn btn-outline" style="font-size:.72rem;padding:5px 12px" onclick="refreshTrack('+t.trade_id+')">Actualizar</button>'
    +(t.stop_loss&&t.take_profit&&t.oco_status!=='ALL_DONE'?'<button class="btn btn-outline" style="font-size:.72rem;padding:5px 12px" onclick="syncOperations()">Verificar</button>':'')
    +'<button class="track-auto" id="auto-btn-'+t.trade_id+'" onclick="toggleAutoRefresh('+t.trade_id+')">Auto-refresh</button></div></div>';
  cell.innerHTML=h;
  if(_trackTimers[t.trade_id])document.getElementById('auto-btn-'+t.trade_id).classList.add('active');
}
function toggleAutoRefresh(tradeId){
  const btn=document.getElementById('auto-btn-'+tradeId);
  if(_trackTimers[tradeId]){clearInterval(_trackTimers[tradeId]);delete _trackTimers[tradeId];btn.classList.remove('active')}
  else{_trackTimers[tradeId]=setInterval(()=>refreshTrack(tradeId),10000);btn.classList.add('active')}
}

/* VALIDATE AGAINST BINANCE */
async function validateTrade(tradeId){
  try{
    var r=await api('POST','/trade/operations/'+tradeId+'/validate');
    if(r.valid){toast('Orden valida en Binance: '+r.reason,'success')}
    else{toast('Orden invalida: '+r.reason,'error');loadOperations()}
  }catch(e){toast('Error validando: '+e.message,'error')}
}

/* DELETE FAILED/INVALID */
async function closeTrade(tradeId){
  if(!confirm('Cerrar/cancelar esta orden en Binance?'))return;
  try{await api('POST','/trade/operations/'+tradeId+'/close');toast('Orden cerrada en Binance','success');loadOperations()}catch(e){toast('Error cerrando orden: '+e.message,'error')}
}
async function deleteTrade(tradeId){
  if(!confirm('Eliminar esta operacion del historial?'))return;
  try{await api('DELETE','/trade/operations/'+tradeId);toast('Operacion eliminada','success');loadOperations()}catch(e){toast('Error eliminando operacion: '+e.message,'error')}
}

/* SYNC WITH BINANCE */
var _syncing=false;
async function syncOperations(){
  if(_syncing)return;_syncing=true;
  var btn=document.getElementById('syncBtn');
  if(btn){btn.disabled=true;btn.textContent='Sincronizando...';}
  try{
    var r=await api('POST','/trade/operations/sync');
    var n=r.changes?r.changes.length:0;
    var errs=r.errors?r.errors.length:0;
    if(n>0){
      var msgs=r.changes.map(function(c){
        if(c.action==='oco_completed') return c.symbol+': '+(c.exit_type==='TP'?'TP':'SL')+' alcanzado';
        if(c.action==='invalidated') return c.symbol+': invalidada';
        return c.symbol+': '+c.action;
      });
      toast(n+' cambio'+(n>1?'s':'')+' detectado'+(n>1?'s':'')+': '+msgs.join(', '),'success');
      loadOperations();
    }else if(!_syncTimer){
      toast('Todo sincronizado ('+r.synced+' activa'+(r.synced!==1?'s':'')+' verificada'+(r.synced!==1?'s':'')+')',r.synced>0?'success':'warn');
    }
    if(errs>0) toast(errs+' error'+(errs>1?'es':'')+' durante sync','error');
  }catch(e){toast('Error sincronizando: '+e.message,'error')}
  finally{
    _syncing=false;if(btn){btn.disabled=false;btn.textContent='\u21C5 Sync';}
    var lbl=document.getElementById('syncStatus');
    if(lbl&&_syncTimer)lbl.textContent='\u00daltimo: '+new Date().toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  }
}

/* AUTO-SYNC WITH BINANCE */
let _syncTimer=null;
function toggleAutoSync(){
  if(_syncTimer) stopAutoSync();
  else startAutoSync();
}
function startAutoSync(){
  var ms=parseInt(document.getElementById('syncInterval').value);
  if(!ms||ms<=0){toast('Seleccion\u00e1 un intervalo para auto-sync','warn');return}
  var btn=document.getElementById('syncAutoBtn');if(btn)btn.classList.add('active');
  var lbl=document.getElementById('syncStatus');if(lbl)lbl.textContent='Auto-sync activo';
  syncOperations();
  _syncTimer=setInterval(function(){syncOperations()},ms);
}
function stopAutoSync(){
  if(_syncTimer){clearInterval(_syncTimer);_syncTimer=null}
  var btn=document.getElementById('syncAutoBtn');if(btn)btn.classList.remove('active');
  var lbl=document.getElementById('syncStatus');if(lbl)lbl.textContent='';
}
/* ── Visibility change: pause/resume ALL timers when tab hidden/visible ── */
var _pausedTimers={clock:false,elapsed:false,opsElapsed:false,sync:false,notif:false};
document.addEventListener('visibilitychange',function(){
  if(document.hidden){
    /* Pause all active timers */
    if(_clockTimer){_stopClock();_pausedTimers.clock=true}
    if(_elapsedTimer){_stopElapsedTimer();_pausedTimers.elapsed=true}
    if(_opsElapsedTimer){_stopOpsElapsedTimer();_pausedTimers.opsElapsed=true}
    if(_syncTimer){clearInterval(_syncTimer);_syncTimer=null;_pausedTimers.sync=true}
    if(_notifInterval){clearInterval(_notifInterval);_notifInterval=null;_pausedTimers.notif=true}
    stopAllTracking();
    Object.keys(_chartTimers).forEach(function(id){clearInterval(_chartTimers[id]);delete _chartTimers[id]});
    Object.keys(_chartCountdowns).forEach(function(id){clearInterval(_chartCountdowns[id]);delete _chartCountdowns[id]});
  } else if(TOKEN){
    /* Resume paused timers */
    if(_pausedTimers.clock){_startClock();_pausedTimers.clock=false}
    if(_pausedTimers.elapsed){_startElapsedTimer();_pausedTimers.elapsed=false}
    if(_pausedTimers.opsElapsed){_startOpsElapsedTimer();_pausedTimers.opsElapsed=false}
    if(_pausedTimers.sync){startAutoSync();_pausedTimers.sync=false}
    if(_pausedTimers.notif){startNotifPoller();_pausedTimers.notif=false}
    /* Refresh current tab data */
    if(currentTab==='operations')loadOperations();
    else if(currentTab==='approvals')loadPendingApprovals();
    else if(currentTab==='recipes')loadRecipes();
  }
});

/* API */
function _formatApiError(detail){
  if(!detail)return 'Error del servidor';
  if(typeof detail==='string')return detail;
  if(Array.isArray(detail)){
    var fieldNames={
      symbol:'Par de trading',strategies:'Estrategias',strategy:'Estrategia',
      weight:'Peso',name:'Nombre',interval:'Intervalo',lookback_days:'Dias historicos',
      buy_threshold:'Umbral de compra',sell_threshold:'Umbral de venta',auto_threshold:'Umbral de auto-aprobacion',
      max_order_pct:'Max orden %',stop_loss_pct:'Stop-Loss %',take_profit_pct:'Take-Profit %',
      strategy_params:'Parametros',username:'Usuario',password:'Contrasena',
      api_key:'API Key',api_secret:'API Secret',quantity:'Cantidad',
      approval_id:'ID aprobacion',reason:'Motivo'
    };
    var msgMap={
      'Field required':'campo obligatorio',
      'Value error':'valor invalido',
      'String should have at least':'debe tener al menos',
      'Input should be':'debe ser uno de',
      'ensure this value is greater than':'debe ser mayor que',
      'ensure this value is less than':'debe ser menor que',
      'value is not a valid':'formato invalido'
    };
    return detail.map(function(e){
      var parts=(e.loc||[]).filter(function(l){return l!=='body'});
      var field=parts.map(function(p){return fieldNames[p]||p}).join(' > ')||'Campo';
      var msg=e.msg||'valor invalido';
      for(var en in msgMap){if(msg.indexOf(en)===0||msg.indexOf(en)!==-1){msg=msg.replace(en,msgMap[en]);break}}
      return field+': '+msg;
    }).join('. ');
  }
  return String(detail);
}
async function api(method,path,body,auth=true){
  var headers={'Content-Type':'application/json'};
  if(auth&&TOKEN)headers['Authorization']='Bearer '+TOKEN;
  var opts={method:method,headers:headers};
  if(body&&method!=='GET'&&method!=='DELETE')opts.body=JSON.stringify(body);
  var resp;
  try{resp=await fetch(path,opts)}catch(netErr){throw new Error('Sin conexion al servidor. Verifica que este corriendo en el puerto 8000.')}
  var data;
  try{data=await resp.json()}catch(parseErr){throw new Error('El servidor respondio con un formato inesperado (HTTP '+resp.status+')')}
  if(!resp.ok){
    var msg=_formatApiError(data.detail);
    var err=new Error(msg);
    err.status=resp.status;
    err.detail=data.detail;
    throw err;
  }
  return data;
}

/* ── TIMESTAMP HELPER (UTC→AR UTC-3) ───────────────── */
var _TZ='America/Argentina/Buenos_Aires';
function _localDt(iso,opts){
  if(!iso)return '\u2014';
  var s=String(iso);
  if(!s.endsWith('Z')&&!/[+\-]\d{2}:?\d{2}$/.test(s))s+='Z';
  var d=new Date(s);
  if(isNaN(d))return String(iso);
  if(!opts)opts={day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit',timeZone:_TZ};
  else if(!opts.timeZone)opts.timeZone=_TZ;
  return d.toLocaleString('es-AR',opts);
}
function _localDtFull(iso){
  return _localDt(iso,{day:'2-digit',month:'2-digit',year:'2-digit',hour:'2-digit',minute:'2-digit',timeZone:_TZ});
}
function _nowLocalStr(){
  return new Date().toLocaleString('es-AR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit',timeZone:_TZ});
}
var _clockTimer=null;
function _startClock(){
  var el=document.getElementById('headerClock');
  if(!el)return;
  function tick(){el.textContent=_nowLocalStr()+' (UTC\u22123)'}
  tick();
  _clockTimer=setInterval(tick,1000);
}
function _stopClock(){if(_clockTimer){clearInterval(_clockTimer);_clockTimer=null}}

/* ── GAUSS PHOSPHOR TICKER ─────────────────────────────── */
var _gaussQuotes=[
  "La matem\u00e1tica es la reina de las ciencias.",
  "La matem\u00e1tica es la reina de las ciencias, y la aritm\u00e9tica es la reina de la matem\u00e1tica.",
  "No me interesa el progreso, me interesa la verdad.",
  "He tenido mis resultados durante mucho tiempo; pero a\u00fan no s\u00e9 c\u00f3mo llegar\u00e9 a ellos.",
  "Es sorprendente lo poco que se necesita para ser feliz en matem\u00e1tica.",
  "Pocos, pero maduros. \u2014 Pauca sed matura",
  "La falta de rigor matem\u00e1tico es un pecado imperdonable.",
  "La vida es corta, el arte es largo, la oportunidad fugaz.",
  "No apruebo el entusiasmo excesivo por publicar resultados incompletos.",
  "Nada es m\u00e1s pr\u00e1ctico que una buena teor\u00eda.",
  "Las matem\u00e1ticas no deben escribirse para los matem\u00e1ticos, sino para la verdad.",
  "La verdad matem\u00e1tica no depende de la opini\u00f3n humana.",
  "Es mejor no publicar que publicar algo incompleto.",
  "La dificultad no est\u00e1 en las ideas nuevas, sino en escapar de las viejas.",
  "El m\u00e9todo correcto se revela solo despu\u00e9s de encontrar la soluci\u00f3n.",
  "La belleza de una demostraci\u00f3n importa tanto como su correcci\u00f3n.",
  "La matem\u00e1tica exige claridad absoluta.",
  "Prefiero entender una cosa profundamente que muchas superficialmente.",
  "La intuici\u00f3n es importante, pero debe ser dominada por el rigor.",
  "La verdad siempre termina imponi\u00e9ndose."
];
function _shuffleArray(a){for(var i=a.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=a[i];a[i]=a[j];a[j]=t}return a}
function _initGaussTicker(){
  var inner=document.getElementById('gaussTickerInner');
  if(!inner)return;
  var shuffled=_shuffleArray(_gaussQuotes.slice());
  var idx=0;
  function showNext(){
    var q=shuffled[idx];
    inner.innerHTML='<span>\u00ab '+q+' \u00bb \u2014 C.F. Gauss</span>';
    /* Adjust animation duration based on text length */
    var dur=Math.max(16,q.length*0.26);
    inner.style.animationDuration=dur+'s';
    /* Reset animation */
    inner.style.animation='none';
    inner.offsetHeight;
    inner.style.animation='gaussScroll '+dur+'s linear infinite';
    idx++;
    if(idx>=shuffled.length){idx=0;_shuffleArray(shuffled);}
  }
  showNext();
  /* Listen for animation iteration to show next quote */
  inner.addEventListener('animationiteration',showNext);
}
_initGaussTicker();

/* ── APPROVAL ELAPSED TIMER ──────────────────────────── */
var _elapsedTimer=null;
function _startElapsedTimer(){
  if(_elapsedTimer)return;
  _updateElapsedAll();
  _elapsedTimer=setInterval(_updateElapsedAll,1000);
}
function _stopElapsedTimer(){if(_elapsedTimer){clearInterval(_elapsedTimer);_elapsedTimer=null}}
function _updateElapsedAll(){
  var els=document.querySelectorAll('.approval-elapsed[data-created]');
  if(!els.length){_stopElapsedTimer();return}
  var now=Date.now();
  els.forEach(function(el){
    var iso=el.getAttribute('data-created');
    if(!iso)return;
    var s=String(iso);
    if(!s.endsWith('Z')&&!/[+\-]\d{2}:?\d{2}$/.test(s))s+='Z';
    var created=new Date(s).getTime();
    if(isNaN(created))return;
    var diff=Math.max(0,Math.floor((now-created)/1000));
    var h=Math.floor(diff/3600);
    var m=Math.floor((diff%3600)/60);
    var sec=diff%60;
    var txt='hace ';
    if(h>0)txt+=h+'h '+m+'m '+sec+'s';
    else if(m>0)txt+=m+'m '+sec+'s';
    else txt+=sec+'s';
    el.textContent=txt;
    /* Color escalation: green <5min, yellow <15min, orange <30min, red >30min */
    if(diff<300)el.style.color='var(--buy)';
    else if(diff<900)el.style.color='var(--hold)';
    else if(diff<1800)el.style.color='#ff9800';
    else el.style.color='var(--sell)';
  });
}

/* TOAST */
/* ── AUTO-EXECUTION NOTIFICATION ─────────────────────── */
var _notifInterval=null;
var _lastSeenApprovalId=0;
var _knownPendingIds=new Set();
var _pendingInitialized=false;
var _audioCtx=null;

function _playChime(){
  try{
    if(!_audioCtx)_audioCtx=new(window.AudioContext||window.webkitAudioContext)();
    var ctx=_audioCtx;
    var now=ctx.currentTime;
    /* Gentle two-note chime */
    var notes=[523.25,659.25]; /* C5, E5 */
    notes.forEach(function(freq,i){
      var osc=ctx.createOscillator();
      var gain=ctx.createGain();
      osc.type='sine';
      osc.frequency.value=freq;
      gain.gain.setValueAtTime(0,now+i*0.15);
      gain.gain.linearRampToValueAtTime(0.12,now+i*0.15+0.05);
      gain.gain.exponentialRampToValueAtTime(0.001,now+i*0.15+0.8);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(now+i*0.15);
      osc.stop(now+i*0.15+0.8);
    });
  }catch(e){}
}
function _playAlarm(){
  try{
    if(!_audioCtx)_audioCtx=new(window.AudioContext||window.webkitAudioContext)();
    var ctx=_audioCtx;
    var now=ctx.currentTime;
    /* 3-beep alert: ascending A5-C6-E6 */
    var notes=[880,1046.5,1318.5];
    notes.forEach(function(freq,i){
      var osc=ctx.createOscillator();
      var gain=ctx.createGain();
      osc.type='triangle';
      osc.frequency.value=freq;
      gain.gain.setValueAtTime(0,now+i*0.18);
      gain.gain.linearRampToValueAtTime(0.18,now+i*0.18+0.03);
      gain.gain.setValueAtTime(0.18,now+i*0.18+0.1);
      gain.gain.exponentialRampToValueAtTime(0.001,now+i*0.18+0.35);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(now+i*0.18);
      osc.stop(now+i*0.18+0.35);
    });
  }catch(e){}
}

var _notifCurrentMs=30000;
function startNotifPoller(){
  if(_notifInterval)return;
  _fetchLastApprovalId().then(function(id){_lastSeenApprovalId=id});
  _seedKnownPending();
  _notifCurrentMs=30000;
  _notifInterval=setInterval(_checkNewAutoApprovals,_notifCurrentMs);
}
async function _seedKnownPending(){
  try{
    var items=await api('GET','/recipe/pending-approvals');
    items.forEach(function(a){_knownPendingIds.add(a.approval_id)});
    _pendingInitialized=true;
  }catch(e){_pendingInitialized=true}
}
function stopNotifPoller(){
  if(_notifInterval){clearInterval(_notifInterval);_notifInterval=null}
}
function _adjustPollerSpeed(turbo){
  var ms=turbo?15000:30000;
  if(ms===_notifCurrentMs)return;
  _notifCurrentMs=ms;
  if(_notifInterval){
    clearInterval(_notifInterval);
    _notifInterval=setInterval(_checkNewAutoApprovals,ms);
  }
}

async function _fetchLastApprovalId(){
  try{
    var items=await api('GET','/approval/history');
    if(!items.length)return 0;
    return Math.max.apply(null,items.map(function(a){return a.approval_id}));
  }catch(e){return _lastSeenApprovalId}
}

async function _checkNewAutoApprovals(){
  if(!TOKEN)return;
  try{
    /* Check turbo state and adjust poller speed */
    var status=await api('GET','/recipe/engine-status');
    _adjustPollerSpeed(status.turbo);

    /* Check for new pending/auto-approved proposals */
    if(_pendingInitialized){
      try{
        var pending=await api('GET','/recipe/pending-approvals');
        var newPending=pending.filter(function(a){return !_knownPendingIds.has(a.approval_id)});
        if(newPending.length>0){
          newPending.forEach(function(a){_knownPendingIds.add(a.approval_id)});
          _playAlarm();
          var p=newPending[0];
          var pSig=p.recommendation==='BUY'?'COMPRA':'VENTA';
          var pStatus=p.status==='approved'?'auto-aprobada':'pendiente';
          toast('Nueva senal '+pSig+': '+p.symbol+(p.recipe_name?' ('+p.recipe_name+')':'')+' ['+pStatus+']','success');
          /* Refresh approvals tab if visible */
          var appTab=document.getElementById('tabApprovals');
          if(appTab&&appTab.style.display!=='none')loadPendingApprovals();
        }
        /* Sync: remove IDs no longer pending */
        var currentPendingIds=new Set(pending.map(function(a){return a.approval_id}));
        _knownPendingIds.forEach(function(id){if(!currentPendingIds.has(id))_knownPendingIds.delete(id)});
      }catch(e){}
    }

    var items=await api('GET','/approval/history');
    if(!items.length)return;
    var newAutos=items.filter(function(a){
      return a.approval_id>_lastSeenApprovalId && a.status==='approved'
        && a.review_reason && a.review_reason.indexOf('Auto-aprobado')===0;
    });
    if(newAutos.length>0){
      var maxId=Math.max.apply(null,newAutos.map(function(a){return a.approval_id}));
      _lastSeenApprovalId=maxId;
      _playChime();
      var a=newAutos[0];
      var sigText=a.recommendation==='BUY'?'COMPRA':'VENTA';
      toast(sigText+' auto-ejecutada: '+a.symbol+' (score '+(a.final_score!=null?(a.final_score>=0?'+':'')+Math.round(a.final_score*100)+'%':'')+')'+(status.turbo?' [TURBO]':''), 'success');
    }else{
      var currentMax=Math.max.apply(null,items.map(function(a){return a.approval_id}));
      if(currentMax>_lastSeenApprovalId)_lastSeenApprovalId=currentMax;
    }
  }catch(e){}
}

var toastTimer;
function toast(msg,type){
  if(!type)type='success';
  var el=document.getElementById('toast');
  el.textContent=msg;
  el.className='toast '+type+' show';
  clearTimeout(toastTimer);
  toastTimer=setTimeout(function(){el.classList.remove('show')},type==='error'?6000:3500);
}

/* ── FLOW DIAGRAMS ─────────────────────────────────── */
var STRATEGY_FLOWS={
A:{name:'Prediccion (AR)',icon:'\ud83d\udcc8',category:'Modelos Predictivos',steps:[
  {type:'input',title:'Datos de entrada',body:'Velas (klines) de Binance: precios de cierre.',formula:'closes = candles[:, 4]'},
  {type:'calc',title:'Serie diferenciada',body:'Se calculan las diferencias entre precios consecutivos para trabajar con cambios (estacionarizar la serie).',formula:'diff = np.diff(closes)'},
  {type:'calc',title:'Ajuste AR(p) via Yule-Walker',body:'Calcula la autocorrelacion de la serie diferenciada y resuelve un sistema matricial (Toeplitz) para obtener los coeficientes AR que mejor predicen el siguiente valor.',formula:'R \u00b7 \u03c6 = r \u2192 coefs AR'},
  {type:'calc',title:'Forecast multi-paso',body:'Usa los coeficientes AR para predecir los proximos K valores de la serie diferenciada.',formula:'forecast[t+k] = \u03a3 \u03c6\u1d62 \u00b7 diff[t+k-i]'},
  {type:'norm',title:'Reconstruccion de precio',body:'Convierte las diferencias pronosticadas de vuelta a niveles de precio mediante suma acumulada.',formula:'expected_return = (forecast_end - close) / close'},
  {type:'decision',title:'Regla de senal',body:'Compara el retorno esperado contra un umbral parametrizable.',branches:[
    {cls:'buy',label:'COMPRA',cond:'return > +threshold%'},
    {cls:'hold',label:'ESPERAR',cond:'|return| < threshold'},
    {cls:'sell',label:'VENTA',cond:'return < -threshold%'}
  ]},
  {type:'output',title:'Confianza',body:'Basada en la desviacion estandar residual del modelo AR: menor residuo = mayor confianza.',formula:'conf = max(0, 1 - residual_std/price \u00d7 10) \u00d7 100'},
  {type:'risk',title:'Stop Loss / Take Profit',body:'Calculados con ATR de las ultimas 20 velas.',formula:'SL = entry \u00b1 1.5\u00d7ATR, TP = entry \u00b1 2.5\u00d7ATR'}
]},
B:{name:'Tendencia (Kalman)',icon:'\ud83d\udd2c',category:'Modelos Predictivos',steps:[
  {type:'input',title:'Datos de entrada',body:'Velas de Binance: precios de cierre (minimo 30).',formula:'closes = candles[:, 4]'},
  {type:'calc',title:'Filtro de Kalman',body:'Modelo de espacio de estados con dos componentes: nivel (precio suavizado) y pendiente (velocidad de cambio). Se actualiza recursivamente para cada vela: predice \u2192 observa \u2192 corrige.',formula:'estado = [nivel, pendiente], P = covarianza'},
  {type:'calc',title:'Extraer pendiente normalizada',body:'La pendiente del Kalman indica la velocidad de la tendencia. Se normaliza por el precio para hacerla comparable entre activos.',formula:'norm_slope = slope / last_close'},
  {type:'calc',title:'Volatilidad rolling',body:'Desviacion estandar de los log-retornos de las ultimas 20 velas.',formula:'vol = std(log_returns[-20:])'},
  {type:'norm',title:'Fuerza de tendencia',body:'Relacion entre la pendiente y la volatilidad: si la pendiente es grande respecto al ruido, la tendencia es confiable.',formula:'trend_strength = |norm_slope| / (vol + \u03b5)'},
  {type:'decision',title:'Reglas de senal',body:'Se silencia si la volatilidad supera el tope (mercado caotico). Si no, evalua la pendiente.',branches:[
    {cls:'buy',label:'COMPRA',cond:'slope > +threshold'},
    {cls:'hold',label:'ESPERAR',cond:'vol > cap o |slope| < th'},
    {cls:'sell',label:'VENTA',cond:'slope < -threshold'}
  ]},
  {type:'output',title:'Confianza',body:'Proporcional a la fuerza de tendencia.',formula:'conf = min(trend_strength \u00d7 20, 100)'},
  {type:'risk',title:'Stop Loss / Take Profit',body:'Basados en ATR de 20 velas.',formula:'SL = entry \u00b1 1.5\u00d7ATR, TP = entry \u00b1 2.5\u00d7ATR'}
]},
C:{name:'Reversion a la Media (OU)',icon:'\ud83d\udd04',category:'Contrarian',steps:[
  {type:'input',title:'Datos de entrada',body:'Velas de Binance: precios de cierre (minimo lookback + 10).',formula:'closes = candles[:, 4]'},
  {type:'calc',title:'Log-retornos',body:'Se calculan los retornos logaritmicos para normalizar las variaciones.',formula:'log_returns = diff(log(closes))'},
  {type:'calc',title:'Estadisticas rolling',body:'Media y desviacion estandar de los ultimos N retornos (ventana de lookback).',formula:'mean = avg(window), std = stdev(window)'},
  {type:'norm',title:'Z-Score suavizado',body:'Mide cuantas desviaciones estandar se alejo el retorno actual de su media. Se promedia con los ultimos 5 valores para suavizar.',formula:'z = (return - mean) / std, avg_z = mean(z[-5:])'},
  {type:'calc',title:'Filtro de regimen de volatilidad',body:'Compara la volatilidad actual con la historica. Si es mucho mayor, el mercado esta en modo caos y no opera.',formula:'vol_ratio = rolling_std / long_run_std'},
  {type:'decision',title:'Regla de senal',body:'Usa el z-score promediado con umbral de 2 desviaciones estandar.',branches:[
    {cls:'buy',label:'COMPRA',cond:'z < -2.0 (sobrevendido)'},
    {cls:'hold',label:'ESPERAR',cond:'|z| < 2.0 o vol alta'},
    {cls:'sell',label:'VENTA',cond:'z > +2.0 (sobrecomprado)'}
  ]},
  {type:'output',title:'Confianza',body:'Proporcional a cuanto excede el z-score el umbral.',formula:'conf = min((|z| - threshold) / threshold \u00d7 80 + 50, 100)'},
  {type:'risk',title:'Stop Loss / Take Profit',body:'Basados en ATR.',formula:'SL = entry \u00b1 1.5\u00d7ATR, TP = entry \u00b1 2.0\u00d7ATR'}
]},
D:{name:'EMA Crossover',icon:'\u2702\ufe0f',category:'Contrarian / Reversion',steps:[
  {type:'input',title:'Datos de entrada',body:'Velas de Binance: precios de cierre, maximos, minimos.',formula:'closes, highs, lows = candles[:, 4/2/3]'},
  {type:'calc',title:'Calcular EMAs',body:'Media movil exponencial rapida y lenta. La EMA da mas peso a los precios recientes.',formula:'\u03b1 = 2/(period+1), EMA[i] = \u03b1\u00b7close + (1-\u03b1)\u00b7EMA[i-1]'},
  {type:'calc',title:'Diferencia relativa',body:'Mide la separacion entre EMAs como proporcion del precio actual.',formula:'diff = (EMA_fast - EMA_slow) / close'},
  {type:'norm',title:'Normalizar por volatilidad',body:'Divide el diff por la desviacion estandar de los retornos recientes. Esto hace el score comparable entre tokens de distinta volatilidad.',formula:'vol = std(returns[-14:]), norm = diff / (vol + \u03b5)'},
  {type:'calc',title:'Mapeo tanh \u2192 [-100, +100]',body:'La funcion tanh comprime cualquier valor a [-1, +1]. Multiplicado por 100 da un porcentaje suave que satura en los extremos.',formula:'scaled_pct = 100 \u00d7 tanh(k \u00d7 norm)'},
  {type:'decision',title:'Regla de senal con zona muerta',body:'Si el score esta dentro de la zona muerta, no opera.',branches:[
    {cls:'buy',label:'COMPRA',cond:'pct < -deadzone'},
    {cls:'hold',label:'ESPERAR',cond:'|pct| < deadzone'},
    {cls:'sell',label:'VENTA',cond:'pct > +deadzone'}
  ]},
  {type:'output',title:'Confianza',body:'Igual al valor absoluto del score.',formula:'confidence = |scaled_pct|'},
  {type:'risk',title:'Stop Loss / Take Profit',body:'Basados en ATR de 14 velas.',formula:'SL = entry \u00b1 1.5\u00d7ATR, TP = entry \u00b1 2.5\u00d7ATR'}
]},
E:{name:'RSI (Fuerza Relativa)',icon:'\ud83d\udcca',category:'Osciladores',steps:[
  {type:'input',title:'Datos de entrada',body:'Velas de Binance: precios de cierre (minimo 14+5 velas).',formula:'closes = candles[:, 4]'},
  {type:'calc',title:'Deltas de precio',body:'Cambio de precio entre cada vela consecutiva.',formula:'deltas = diff(closes)'},
  {type:'calc',title:'Ganancias y perdidas promedio',body:'Separa los movimientos positivos (gains) y negativos (losses). Los promedia con suavizado exponencial de Wilder.',formula:'avg_gain = EMA(gains, 14), avg_loss = EMA(losses, 14)'},
  {type:'norm',title:'Calcular RSI',body:'Relative Strength = ganancia promedio / perdida promedio. RSI normaliza esto a un rango 0-100.',formula:'RS = avg_gain / avg_loss, RSI = 100 - 100/(1+RS)'},
  {type:'decision',title:'Regla de senal',body:'RSI por debajo de 30 indica sobreventa (panico), por encima de 70 indica sobrecompra (euforia).',branches:[
    {cls:'buy',label:'COMPRA',cond:'RSI < 30 (sobreventa)'},
    {cls:'hold',label:'ESPERAR',cond:'30 \u2264 RSI \u2264 70'},
    {cls:'sell',label:'VENTA',cond:'RSI > 70 (sobrecompra)'}
  ]},
  {type:'output',title:'Confianza',body:'Proporcional a la profundidad en la zona extrema.',formula:'conf = min(50 + depth \u00d7 100, 100)'},
  {type:'risk',title:'Stop Loss / Take Profit',body:'Basados en ATR de 20 velas.',formula:'SL = entry \u00b1 1.5\u00d7ATR, TP = entry \u00b1 2.5\u00d7ATR'}
]},
F:{name:'MACD (Momentum)',icon:'\ud83d\udcc9',category:'Seguimiento de Tendencia',steps:[
  {type:'input',title:'Datos de entrada',body:'Velas de Binance: precios de cierre (minimo 26+9+2 velas).',formula:'closes = candles[:, 4]'},
  {type:'calc',title:'Linea MACD',body:'Diferencia entre la EMA rapida (12) y la EMA lenta (26). Positiva = momentum alcista.',formula:'MACD = EMA(12) - EMA(26)'},
  {type:'calc',title:'Linea de Senal',body:'EMA de 9 periodos aplicada sobre la linea MACD. Actua como referencia suavizada.',formula:'Signal = EMA(MACD, 9)'},
  {type:'calc',title:'Histograma',body:'Diferencia entre MACD y Signal. Barras crecientes = tendencia se fortalece.',formula:'Histogram = MACD - Signal'},
  {type:'decision',title:'Regla de senal (2 modos)',body:'Modo "cross": cuando MACD cruza la Signal. Modo "histogram": cuando el histograma cambia de signo.',branches:[
    {cls:'buy',label:'COMPRA',cond:'Cruce alcista o hist > 0'},
    {cls:'hold',label:'ESPERAR',cond:'Sin cruce ni cambio'},
    {cls:'sell',label:'VENTA',cond:'Cruce bajista o hist < 0'}
  ]},
  {type:'output',title:'Confianza',body:'Proporcional al tamano del histograma relativo al precio.',formula:'conf = min(|histogram|/close \u00d7 20000, 100)'},
  {type:'risk',title:'Stop Loss / Take Profit',body:'Basados en ATR de 20 velas.',formula:'SL = entry \u00b1 1.5\u00d7ATR, TP = entry \u00b1 2.5\u00d7ATR'}
]},
G:{name:'Bandas de Bollinger',icon:'\ud83c\udf0a',category:'Volatilidad',steps:[
  {type:'input',title:'Datos de entrada',body:'Velas de Binance: OHLCV (minimo 20+2 velas).',formula:'closes, highs, lows = candles'},
  {type:'calc',title:'Bandas de Bollinger',body:'Banda media = SMA de 20 periodos. Bandas superior/inferior = media \u00b1 2 desviaciones estandar.',formula:'upper = SMA + 2\u00b7\u03c3, lower = SMA - 2\u00b7\u03c3'},
  {type:'norm',title:'Porcentaje B (%B)',body:'Mide donde esta el precio dentro de las bandas. 0 = en la banda inferior, 1 = en la superior, >1 o <0 = fuera de las bandas.',formula:'%B = (close - lower) / (upper - lower)'},
  {type:'calc',title:'Ancho de banda',body:'Mide la volatilidad actual. Bandas estrechas = mercado comprimido (posible explosion). Bandas anchas = alta volatilidad.',formula:'bandwidth = (upper - lower) / middle \u00d7 100'},
  {type:'decision',title:'Regla de senal',body:'Si el precio toca o penetra la banda inferior = sobreventa. Si toca la superior = sobrecompra. Dos modos: "touch" o "close_outside".',branches:[
    {cls:'buy',label:'COMPRA',cond:'Precio toca banda inf'},
    {cls:'hold',label:'ESPERAR',cond:'Dentro de las bandas'},
    {cls:'sell',label:'VENTA',cond:'Precio toca banda sup'}
  ]},
  {type:'output',title:'Confianza',body:'Proporcional a cuanto penetro el precio fuera de la banda.',formula:'conf = min(50 + penetracion \u00d7 30, 100)'},
  {type:'risk',title:'Stop Loss / Take Profit',body:'Basados en ATR.',formula:'SL = entry \u00b1 1.5\u00d7ATR, TP = entry \u00b1 2.5\u00d7ATR'}
]},
H:{name:'Ruptura de Canal (Breakout)',icon:'\ud83d\ude80',category:'Seguimiento de Tendencia',steps:[
  {type:'input',title:'Datos de entrada',body:'Velas de Binance: OHLCV con volumen (minimo lookback + 2).',formula:'highs, lows, closes, volumes = candles'},
  {type:'calc',title:'Canal Donchian',body:'Maximo de los maximos y minimo de los minimos de las ultimas N velas (excluyendo la actual).',formula:'upper = max(highs[-N:-1]), lower = min(lows[-N:-1])'},
  {type:'calc',title:'Niveles de ruptura con buffer',body:'Se agrega un margen al canal para filtrar falsas rupturas.',formula:'break_up = upper \u00d7 (1 + buffer%), break_dn = lower \u00d7 (1 - buffer%)'},
  {type:'norm',title:'Filtro de volumen (opcional)',body:'Si esta activado, solo confirma la ruptura si el volumen actual es mayor al promedio \u00d7 1.2.',formula:'vol_ok = current_vol > avg_vol \u00d7 1.2'},
  {type:'decision',title:'Regla de senal',body:'Ruptura alcista si el cierre supera el canal superior. Bajista si rompe el inferior.',branches:[
    {cls:'buy',label:'COMPRA',cond:'close > break_up AND vol_ok'},
    {cls:'hold',label:'ESPERAR',cond:'Dentro del canal'},
    {cls:'sell',label:'VENTA',cond:'close < break_dn AND vol_ok'}
  ]},
  {type:'output',title:'Confianza',body:'Proporcional a cuanto penetro el precio fuera del nivel de ruptura.',formula:'conf = min(50 + penetracion \u00d7 500, 100)'},
  {type:'risk',title:'Stop Loss / Take Profit',body:'Basados en ATR.',formula:'SL = entry \u00b1 1.5\u00d7ATR, TP = entry \u00b1 2.5\u00d7ATR'}
]},
I:{name:'ATR Trailing Stop',icon:'\ud83d\udee1\ufe0f',category:'Gestion de Riesgo',steps:[
  {type:'input',title:'Datos de entrada',body:'Velas de Binance: OHLCV (minimo 14+10 velas).',formula:'highs, lows, closes = candles'},
  {type:'calc',title:'ATR (Average True Range)',body:'Mide la volatilidad real del mercado usando el rango verdadero de cada vela, suavizado con el metodo de Wilder.',formula:'TR = max(H-L, |H-prevC|, |L-prevC|), ATR = Wilder_EMA(TR)'},
  {type:'calc',title:'Trailing Stop dinamico',body:'Un stop que se mueve con el precio. En tendencia alcista sube pero nunca baja. En bajista baja pero nunca sube. La distancia es ATR \u00d7 multiplicador.',formula:'up_stop = close - mult\u00d7ATR, dn_stop = close + mult\u00d7ATR'},
  {type:'norm',title:'Deteccion de flip de tendencia',body:'Cuando el precio cruza el trailing stop, la tendencia cambia de direccion. Se compara el estado actual vs el anterior.',formula:'Si close < trail (era long) \u2192 flip a short, y viceversa'},
  {type:'decision',title:'Regla de senal',body:'Solo genera senal cuando hay un flip de tendencia. Respeta el filtro de direccion (both/long_only/short_only).',branches:[
    {cls:'buy',label:'COMPRA',cond:'Flip a alcista'},
    {cls:'hold',label:'ESPERAR',cond:'Sin flip'},
    {cls:'sell',label:'VENTA',cond:'Flip a bajista'}
  ]},
  {type:'output',title:'Confianza',body:'Proporcional a la distancia entre el precio y el trailing stop en el momento del flip.',formula:'conf = min(distance_pct \u00d7 20, 100)'},
  {type:'risk',title:'Stop Loss / Take Profit',body:'SL adicional de seguridad mas el trailing stop propio.',formula:'SL = entry \u00b1 1.0\u00d7ATR, TP = entry \u00b1 2.0\u00d7ATR'}
]},
J:{name:'ADX (Fuerza de Tendencia)',icon:'\ud83d\udcaa',category:'Seguimiento de Tendencia',steps:[
  {type:'input',title:'Datos de entrada',body:'Velas de Binance: OHLCV (minimo periodo\u00d72 + confirm + 2).',formula:'highs, lows, closes = candles'},
  {type:'calc',title:'Movimiento direccional (+DM/-DM)',body:'Mide la fuerza de compradores (+DM: maximo sube) vs vendedores (-DM: minimo baja) en cada vela.',formula:'+DM = max(H[i]-H[i-1], 0), -DM = max(L[i-1]-L[i], 0)'},
  {type:'calc',title:'Indicadores direccionales (+DI/-DI)',body:'Suaviza los movimientos direccionales con el metodo de Wilder y los normaliza por el ATR.',formula:'+DI = 100 \u00d7 smooth(+DM) / ATR, -DI = 100 \u00d7 smooth(-DM) / ATR'},
  {type:'norm',title:'Calcular ADX',body:'El ADX mide la FUERZA de la tendencia (sin importar la direccion). DX = diferencia entre DI, ADX = suavizado de DX.',formula:'DX = 100 \u00d7 |+DI - -DI| / (+DI + -DI), ADX = Wilder(DX)'},
  {type:'decision',title:'Regla de senal',body:'Solo opera si ADX >= 25 (hay tendencia fuerte). La direccion la da +DI vs -DI. Opcionalmente requiere ADX subiendo.',branches:[
    {cls:'buy',label:'COMPRA',cond:'ADX \u2265 25 AND +DI > -DI'},
    {cls:'hold',label:'ESPERAR',cond:'ADX < 25 (sin tendencia)'},
    {cls:'sell',label:'VENTA',cond:'ADX \u2265 25 AND -DI > +DI'}
  ]},
  {type:'output',title:'Confianza',body:'Proporcional a cuanto supera el ADX el umbral de 25.',formula:'conf = min((ADX - 25) / 25 \u00d7 80 + 20, 100)'},
  {type:'risk',title:'Stop Loss / Take Profit',body:'Basados en ATR.',formula:'SL = entry \u00b1 1.5\u00d7ATR, TP = entry \u00b1 2.5\u00d7ATR'}
]},
K:{name:'Fear & Greed (Sentimiento)',icon:'\ud83d\ude28',category:'Sentimiento de Mercado',steps:[
  {type:'input',title:'Datos de entrada',body:'Dos fuentes: (1) API externa Alternative.me para el indice Fear & Greed, (2) Velas de Binance para precios y ATR.',formula:'FNG API: api.alternative.me/fng/ + klines Binance'},
  {type:'calc',title:'Obtener indice FNG actual',body:'El indice combina volatilidad de BTC, volumen, redes sociales, encuestas, dominancia de BTC y Google Trends. Va de 0 (miedo extremo) a 100 (codicia extrema).',formula:'fng_now = data[0].value (0-100)'},
  {type:'calc',title:'Tendencia del sentimiento',body:'Compara el FNG actual con el promedio de los ultimos N dias para ver si el sentimiento esta cambiando.',formula:'fng_avg = mean(fng[-7d]), trend = fng_now - fng_avg'},
  {type:'decision',title:'Regla de senal (contrarian)',body:'Logica contraria: cuando todos tienen miedo = oportunidad de compra. Cuando todos tienen codicia = momento de vender.',branches:[
    {cls:'buy',label:'COMPRA',cond:'FNG \u2264 25 (miedo extremo)'},
    {cls:'hold',label:'ESPERAR',cond:'25 < FNG < 75 (neutral)'},
    {cls:'sell',label:'VENTA',cond:'FNG \u2265 75 (codicia extrema)'}
  ]},
  {type:'output',title:'Confianza',body:'Proporcional a la profundidad dentro de la zona extrema.',formula:'BUY: conf = (25 - FNG)/25 \u00d7 80 + 20, SELL: (FNG - 75)/25 \u00d7 80 + 20'},
  {type:'risk',title:'Stop Loss / Take Profit',body:'Basados en ATR de las velas de Binance (14 periodos).',formula:'SL = entry \u00b1 1.5\u00d7ATR, TP = entry \u00b1 2.5\u00d7ATR'}
]},
L:{name:'Pendiente EMA (Slope)',icon:'\ud83d\udcd0',category:'Seguimiento de Tendencia',steps:[
  {type:'input',title:'Datos de entrada',body:'Precios de cierre de velas Binance.',formula:'closes = candles[:, 4]'},
  {type:'calc',title:'EMA rapida',body:'Calcula la Media Movil Exponencial del precio de cierre. La EMA filtra el ruido intravela, dejando solo la tendencia subyacente.',formula:'ema_fast = EMA(closes, period=9)'},
  {type:'calc',title:'Regresion lineal sobre la EMA',body:'Toma los ultimos N puntos de la EMA y ajusta una recta mediante minimos cuadrados. Esto da una pendiente estable, no afectada por una sola vela anomala.',formula:'y = ema[-10:], m = polyfit(x, y, 1)[0]'},
  {type:'norm',title:'Normalizacion y angulo',body:'Se divide la pendiente por el precio medio para hacerla comparable entre activos (BTC $97K vs SOL $200). Luego se convierte a grados con arcotangente.',formula:'m_norm = m / mean(ema), \u03b8 = arctan(m_norm \u00d7 window) \u00d7 180/\u03c0'},
  {type:'norm',title:'Suavizado y factor',body:'Se promedian los angulos de las ultimas evaluaciones con pesos exponenciales para filtrar picos. Luego se normaliza a [-100, +100] dividiendo por max_angle.',formula:'factor = clamp(\u03b8 / max_angle, -1, 1) \u00d7 100'},
  {type:'decision',title:'Regla de senal',body:'El factor indica direccion y fuerza. Positivo = alcista, negativo = bajista, cercano a cero = lateral.',branches:[
    {cls:'buy',label:'COMPRA',cond:'factor > +deadzone'},
    {cls:'hold',label:'ESPERAR',cond:'|factor| < deadzone'},
    {cls:'sell',label:'VENTA',cond:'factor < -deadzone'}
  ]},
  {type:'output',title:'Confianza y fuerza',body:'La confianza es |factor| (0-100). La fuerza (force) es |factor|/100 (0-1) para uso como indicador de fuerza en recetas con roles.',formula:'confidence = |factor|, force = |factor| / 100'},
  {type:'risk',title:'Stop Loss / Take Profit',body:'Basados en ATR simple de las ultimas 20 velas.',formula:'SL = entry \u00b1 1.5\u00d7ATR, TP = entry \u00b1 2.5\u00d7ATR'}
]}
};

/* Per-step metric keys: {strategyKey: {stepIndex: 'key1,key2,...'}} */
var FLOW_KEYS={
  A:{4:'predicted_return'},
  B:{1:'kalman_slope',3:'volatility',4:'trend'},
  C:{3:'z_score',4:'vol_regime'},
  D:{1:'ema_fast,ema_slow',2:'diff',3:'volatility,norm',4:'scaled_pct'},
  E:{3:'rsi'},
  F:{1:'macd_line',2:'signal_line',3:'histogram'},
  G:{1:'upper_band,middle_band,lower_band',2:'pct_b',3:'bandwidth'},
  H:{1:'upper_channel,lower_channel'},
  I:{1:'atr',2:'trailing_stop',3:'trend'},
  J:{2:'plus_di,minus_di',3:'adx'},
  K:{1:'fng_value,fng_classification',2:'fng_avg,fng_trend'},
  L:{1:'ema_value',2:'slope_raw,slope_normalized',3:'angle_degrees',4:'angle_smoothed,factor'}
};

var _flowTabInited=false;
var _flowLiveData=null;
var _flowRecipeData=null;
var _flowRecipes=[];

async function initFlowTab(){
  var stratSel=document.getElementById('flowStratSelect');
  if(!_flowTabInited){
    _flowTabInited=true;
    Object.keys(STRATEGY_FLOWS).forEach(function(k){
      var s=STRATEGY_FLOWS[k];
      stratSel.innerHTML+='<option value="'+k+'">'+s.icon+' '+k+': '+s.name+'</option>';
    });
  }
  try{
    var all=await api('GET','/recipe/');
    _flowRecipes=all;
  }catch(e){_flowRecipes=[]}
  var rSel=document.getElementById('flowRecipeSelect');
  rSel.innerHTML='<option value="">-- Selecciona receta --</option>';
  if(!_flowRecipes.length){
    rSel.innerHTML='<option value="">Sin recetas</option>';
  }else{
    _flowRecipes.forEach(function(r,i){
      var mTag=r.mode==='weighted'?'[POND]':r.mode==='roles'?'[ROLES]':'[SIN MODO]';
      rSel.innerHTML+='<option value="'+i+'">'+mTag+' '+r.symbol+' \u2014 '+r.name+' ('+r.interval+')</option>';
    });
  }
}

async function runFlowLive(){
  var idx=document.getElementById('flowRecipeSelect').value;
  if(idx===''||!_flowRecipes.length){toast('Seleccion\u00e1 una receta','warn');return}
  var recipe=_flowRecipes[parseInt(idx)];
  var stratKey=document.getElementById('flowStratSelect').value;
  var btn=document.getElementById('flowRunBtn');
  btn.disabled=true;btn.textContent='Ejecutando...';
  document.getElementById('flowSummaryContainer').innerHTML='';
  document.getElementById('flowDiagramContainer').innerHTML='';
  try{
    if(stratKey){
      /* Single strategy mode */
      var data=await api('GET','/strategies/'+stratKey+'/run?symbol='+recipe.symbol+'&interval='+recipe.interval+'&lookback_days='+recipe.lookback_days);
      _flowLiveData=data;_flowRecipeData=null;
      renderFlowSummary(data);
      renderFlowDiagram(stratKey);
    }else{
      /* Full recipe simulation */
      var data=await api('GET','/recipe/'+recipe.id+'/simulate');
      _flowRecipeData=data;_flowLiveData=null;
      renderRecipeFlow(data);
    }
  }catch(e){
    toast('Error: '+e.message,'error');
    _flowLiveData=null;_flowRecipeData=null;
  }finally{
    btn.disabled=false;btn.textContent='\u25b6 Ejecutar en vivo';
  }
}

function renderRecipeFlow(d){
  var fP=function(v){if(!v&&v!==0)return'\u2014';return v>=1000?'$'+v.toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2}):'$'+v.toFixed(4)};
  var sigColor=d.signal==='BUY'?'var(--buy)':d.signal==='SELL'?'var(--sell)':'var(--muted)';
  var sigLabel=d.signal==='BUY'?'COMPRA':d.signal==='SELL'?'VENTA':'ESPERAR';
  var c=d.combination;
  var th=d.thresholds;
  var ex=d.execution||{};
  var confInfo=d.confirmation;
  var isWeightedMode=d.mode==='weighted';
  var hasStrength=c.has_strength;
  var autoStrThPct=th.auto_strength_pct||0;

  /* Summary header */
  var h='<div class="flow-summary">'
    +'<div class="flow-summary-item"><div class="flow-summary-label">Receta</div><div class="flow-summary-value" style="font-size:.82rem">'+d.recipe_name+'</div></div>'
    +'<div class="flow-summary-item"><div class="flow-summary-label">Modo</div><div class="flow-summary-value"><span class="mode-chip '+(d.mode||'nomode')+'">'+(d.mode==='weighted'?'PONDERADO':d.mode==='roles'?'ROLES':'SIN MODO')+'</span></div></div>'
    +'<div class="flow-summary-item"><div class="flow-summary-label">Par</div><div class="flow-summary-value">'+d.symbol+'</div></div>'
    +'<div class="flow-summary-item"><div class="flow-summary-label">Precio</div><div class="flow-summary-value">'+fP(d.last_close)+'</div></div>'
    +'<div class="flow-summary-item"><div class="flow-summary-label">Velas</div><div class="flow-summary-value">'+d.candle_count+'</div></div>'
    +'<div class="flow-summary-item"><div class="flow-summary-label">Score</div><div class="flow-summary-value" style="color:'+sigColor+'">'+(c.final_pct>0?'+':'')+c.final_pct+'%</div></div>'
    +'<div class="flow-summary-item"><div class="flow-summary-label">Se\u00f1al</div><div class="flow-summary-value" style="color:'+sigColor+'">'+sigLabel+'</div></div>'
    +'</div>';
  document.getElementById('flowSummaryContainer').innerHTML=h;

  /* ═══════════════════════════════════════════════════════════════════
   *  DIAGRAMA DE FLUJO T\u00c9CNICO
   *  Pipeline: Ingesta \u2192 Procesamiento \u2192 Combinaci\u00f3n \u2192 Disparadores \u2192 Confirmaci\u00f3n \u2192 Ruta \u2192 Orden
   * ═══════════════════════════════════════════════════════════════════ */
  var NS='padding:14px 16px;border-radius:4px;border:1px solid;position:relative;';
  var dot=function(color){return '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:'+color+';margin-right:5px;vertical-align:middle;flex-shrink:0"></span>'};
  var stepNum=function(n,color){return '<span style="display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:'+color+';color:var(--bg);font-size:.55rem;font-weight:900;margin-right:6px;flex-shrink:0">'+n+'</span>'};
  var arrow='<div style="text-align:center;padding:3px 0"><svg width="20" height="22" viewBox="0 0 20 22"><path d="M10 0 L10 16 M5 12 L10 18 L15 12" stroke="rgba(90,100,128,.35)" stroke-width="1.5" fill="none"/></svg></div>';
  var triggerRow=function(label,condition,actual,ok,color){
    return '<div style="display:flex;align-items:center;gap:6px;padding:5px 8px;border-radius:6px;background:rgba(90,100,128,.03);margin-bottom:3px">'
      +dot(ok?color:'#5a6480')
      +'<span style="font-size:.6rem;font-weight:700;color:var(--text);min-width:80px">'+label+'</span>'
      +'<span style="font-size:.58rem;color:var(--muted);font-family:monospace;flex:1">'+condition+'</span>'
      +'<span style="font-size:.7rem;font-weight:900;font-family:monospace;color:'+(ok?color:'var(--muted)')+'">'+actual+'</span>'
      +'<span style="font-size:.72rem;margin-left:4px">'+(ok?'\u2705':'\u274c')+'</span>'
      +'</div>';
  };

  var dg='<div class="flow-diagram" style="max-width:780px">';

  /* ══ PASO 1: INGESTA DE DATOS ══ */
  dg+='<div style="'+NS+'background:rgba(90,100,128,.04);border-color:rgba(90,100,128,.12)">'
    +'<div style="display:flex;align-items:center;margin-bottom:8px">'+stepNum('1','rgba(90,100,128,.3)')+'<span style="font-size:.6rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">INGESTA DE DATOS</span></div>';
  dg+='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px">';
  var dataItems=[
    {k:'Par',v:d.symbol},{k:'Intervalo',v:d.interval},{k:'Velas',v:d.candle_count},{k:'Lookback',v:d.lookback_days+'d'},
    {k:'Precio',v:fP(d.last_close)},{k:'SL %',v:ex.stop_loss_pct+'%'},{k:'TP %',v:ex.take_profit_pct+'%'},{k:'Max orden',v:ex.max_order_pct+'%'}
  ];
  for(var di2=0;di2<dataItems.length;di2++){
    dg+='<div style="text-align:center;padding:5px;border-radius:6px;background:rgba(90,100,128,.04)">'
      +'<div style="font-size:.48rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.3px">'+dataItems[di2].k+'</div>'
      +'<div style="font-size:.72rem;font-weight:800;color:var(--text);font-family:monospace">'+dataItems[di2].v+'</div>'
      +'</div>';
  }
  dg+='</div></div>';
  dg+=arrow;

  /* ══ PASO 2: PROCESAMIENTO DE ESTRATEGIAS ══ */
  dg+='<div style="'+NS+'background:rgba(90,100,128,.03);border-color:rgba(90,100,128,.1)">'
    +'<div style="display:flex;align-items:center;margin-bottom:8px">'+stepNum('2','rgba(90,100,128,.3)')+'<span style="font-size:.6rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">PROCESAMIENTO DE ESTRATEGIAS</span>'
    +'<span style="font-size:.52rem;color:var(--muted);margin-left:auto">'+d.strategies.length+' estrategia'+(d.strategies.length>1?'s':'')+'</span></div>';
  /* Strategy table header */
  dg+='<div style="display:grid;grid-template-columns:140px 1fr 60px 50px 80px;gap:4px;padding:0 4px 4px;border-bottom:1px solid rgba(90,100,128,.08);margin-bottom:4px">'
    +'<span style="font-size:.48rem;font-weight:700;color:var(--muted);text-transform:uppercase">Estrategia</span>'
    +'<span style="font-size:.48rem;font-weight:700;color:var(--muted);text-transform:uppercase">Salida</span>'
    +'<span style="font-size:.48rem;font-weight:700;color:var(--muted);text-transform:uppercase;text-align:right">Valor</span>'
    +'<span style="font-size:.48rem;font-weight:700;color:var(--muted);text-transform:uppercase;text-align:right">Peso</span>'
    +'<span style="font-size:.48rem;font-weight:700;color:var(--muted);text-transform:uppercase;text-align:right">Confianza</span>'
    +'</div>';
  for(var i=0;i<d.strategies.length;i++){
    var s=d.strategies[i];
    var lb=STRATEGY_LABELS[s.strategy]||{name:s.strategy,icon:'\ud83d\udcca',color:'var(--muted)'};
    var stC=lb.color||'var(--muted)';
    var isForce=s.force!=null;
    var sVal,sValColor,sRec;
    if(s.error){
      sVal='\u26a0 Error';sValColor='var(--sell)';sRec=s.error;
    }else if(isForce){
      var fPct2=Math.round(s.force*100);
      sVal=fPct2+'%';sValColor='var(--hold)';sRec='Fuerza: '+fPct2+'%';
    }else{
      var sPct2=Math.round(s.score*100);
      sVal=(sPct2>0?'+':'')+sPct2+'%';
      sValColor=sPct2>0?'var(--buy)':sPct2<0?'var(--sell)':'var(--muted)';
      sRec=(s.recommendation||'HOLD');
    }
    dg+='<div style="display:grid;grid-template-columns:140px 1fr 60px 50px 80px;gap:4px;padding:4px;border-radius:4px;align-items:center;background:'+(i%2===0?'rgba(90,100,128,.02)':'transparent')+'">';
    /* Name + role tag */
    dg+='<div style="display:flex;align-items:center;gap:4px">'
      +'<span style="font-size:.68rem;font-weight:800;color:'+stC+'">'+lb.icon+' '+lb.name+'</span>'
      +'<span style="font-size:.46rem;font-weight:700;padding:1px 4px;border-radius:3px;background:'+(isForce?'rgba(255,152,0,.1);color:var(--strength-color)':'rgba(30,136,229,.1);color:var(--direction-color)')+'">'+(isWeightedMode?'POND':isForce?'FZA':'DIR')+'</span>'
      +'</div>';
    /* Output bar */
    if(!s.error){
      var barW=isForce?Math.round(s.force*100):Math.abs(Math.round(s.score*100));
      var barLeft=isForce?'0':s.score>=0?'50%':(50-barW/2)+'%';
      dg+='<div style="position:relative;height:6px;background:rgba(90,100,128,.06);border-radius:3px;overflow:hidden">'
        +(isForce?'':'<div style="position:absolute;left:50%;top:0;width:1px;height:100%;background:rgba(90,100,128,.12)"></div>')
        +'<div style="position:absolute;top:0;left:'+barLeft+';height:100%;width:'+(barW/2)+'%;background:'+sValColor+';border-radius:3px;opacity:.7"></div>'
        +'</div>';
    }else{
      dg+='<div style="font-size:.55rem;color:var(--sell)">'+s.error.substring(0,30)+'</div>';
    }
    /* Value */
    dg+='<div style="text-align:right;font-size:.7rem;font-weight:900;font-family:monospace;color:'+sValColor+'">'+sVal+'</div>';
    /* Weight */
    dg+='<div style="text-align:right;font-size:.62rem;font-weight:700;font-family:monospace;color:var(--muted)">'+Math.round(s.weight*100)+'%</div>';
    /* Confidence */
    dg+='<div style="text-align:right;font-size:.62rem;font-family:monospace;color:var(--muted)">'+(s.confidence!=null?s.confidence.toFixed(1)+'%':'\u2014')+'</div>';
    dg+='</div>';
    /* Explanation row */
    if(s.explanation&&!s.error){
      dg+='<div style="padding:1px 4px 2px 148px;font-size:.5rem;color:var(--muted);font-style:italic;line-height:1.3">'+s.explanation.substring(0,120)+(s.explanation.length>120?'\u2026':'')+'</div>';
    }
  }
  dg+='</div>';
  dg+=arrow;

  /* ══ PASO 3: COMBINACI\u00d3N ══ */
  var combLabel=isWeightedMode?'COMBINACI\u00d3N PONDERADA':'COMBINACI\u00d3N POR ROLES';
  var combColor=isWeightedMode?'var(--accent)':'#1e88e5';
  var combBgS=isWeightedMode?'rgba(59,130,246,.03)':'rgba(30,136,229,.03)';
  var combBdS=isWeightedMode?'rgba(59,130,246,.12)':'rgba(30,136,229,.12)';
  dg+='<div style="'+NS+'background:'+combBgS+';border-color:'+combBdS+'">'
    +'<div style="display:flex;align-items:center;margin-bottom:8px">'+stepNum('3',combColor)+'<span style="font-size:.6rem;font-weight:700;color:'+combColor+';text-transform:uppercase;letter-spacing:.5px">'+combLabel+'</span></div>';

  if(!isWeightedMode&&hasStrength){
    /* ROLES: dual direction + strength */
    dg+='<div style="display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:stretch">';
    var dirColor=c.direction_pct>=0?'var(--buy)':'var(--sell)';
    /* Direction panel */
    dg+='<div style="padding:10px;border-radius:4px;background:rgba(30,136,229,.04);border:1px solid rgba(30,136,229,.1)">'
      +'<div style="font-size:.5rem;font-weight:700;color:var(--direction-color);text-transform:uppercase;text-align:center;margin-bottom:4px">EJE: DIRECCI\u00d3N</div>'
      +'<div style="font-weight:900;font-size:1.15rem;color:'+dirColor+';text-align:center;margin:2px 0;font-family:monospace">'+(c.direction_pct>0?'+':'')+c.direction_pct+'%</div>';
    if(c.direction_contributions){
      for(var di3=0;di3<c.direction_contributions.length;di3++){
        var dc2=c.direction_contributions[di3];
        var dcLb2=STRATEGY_LABELS[dc2.strategy]||{name:dc2.strategy,icon:'',color:'var(--muted)'};
        dg+='<div style="font-size:.5rem;color:var(--muted);text-align:center">'+dcLb2.icon+' <span style="font-family:monospace">'+dc2.score_pct+'% \u00d7 '+dc2.relative_weight_pct+'%</span> = <span style="font-weight:800;color:'+(dc2.contribution_pct>0?'var(--buy)':'var(--sell)')+';font-family:monospace">'+(dc2.contribution_pct>0?'+':'')+dc2.contribution_pct+'%</span></div>';
      }
    }
    dg+='</div>';
    dg+='<div style="display:flex;align-items:center;font-weight:900;font-size:.6rem;color:rgba(90,100,128,.35);padding:0 2px">&amp;&amp;</div>';
    /* Strength panel */
    dg+='<div style="padding:10px;border-radius:4px;background:rgba(255,152,0,.04);border:1px solid rgba(255,152,0,.1)">'
      +'<div style="font-size:.5rem;font-weight:700;color:var(--strength-color);text-transform:uppercase;text-align:center;margin-bottom:4px">EJE: FUERZA</div>'
      +'<div style="font-weight:900;font-size:1.15rem;color:var(--hold);text-align:center;margin:2px 0;font-family:monospace">'+c.strength_pct+'%</div>';
    if(c.strength_contributions){
      for(var si3=0;si3<c.strength_contributions.length;si3++){
        var sc3=c.strength_contributions[si3];
        var scLb3=STRATEGY_LABELS[sc3.strategy]||{name:sc3.strategy,icon:'',color:'var(--muted)'};
        dg+='<div style="font-size:.5rem;color:var(--muted);text-align:center">'+scLb3.icon+' <span style="font-family:monospace">'+sc3.force_pct+'% \u00d7 '+sc3.relative_weight_pct+'%</span> = <span style="font-weight:800;color:var(--hold);font-family:monospace">'+sc3.contribution_pct+'%</span></div>';
      }
    }
    dg+='</div></div>';
  }else if(!isWeightedMode&&!hasStrength){
    /* ROLES sin fuerza */
    var dirColor3=c.final_pct>=0?'var(--buy)':'var(--sell)';
    dg+='<div style="display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:stretch">';
    dg+='<div style="padding:10px;border-radius:4px;background:rgba(30,136,229,.04);border:1px solid rgba(30,136,229,.1);text-align:center">'
      +'<div style="font-size:.5rem;font-weight:700;color:var(--direction-color);text-transform:uppercase;margin-bottom:4px">EJE: DIRECCI\u00d3N</div>'
      +'<div style="font-weight:900;font-size:1.15rem;color:'+dirColor3+';font-family:monospace;margin:2px 0">'+(c.final_pct>0?'+':'')+c.final_pct+'%</div>'
      +'<div style="font-size:.5rem;color:var(--muted)">'+c.formula+'</div>'
      +'</div>';
    dg+='<div style="display:flex;align-items:center;font-weight:900;font-size:.6rem;color:rgba(90,100,128,.2);padding:0 2px">\u2014</div>';
    dg+='<div style="padding:10px;border-radius:4px;background:rgba(255,152,0,.02);border:1px dashed rgba(255,152,0,.12);text-align:center;display:flex;flex-direction:column;justify-content:center">'
      +'<div style="font-size:.5rem;font-weight:700;color:rgba(255,152,0,.35);text-transform:uppercase;margin-bottom:4px">EJE: FUERZA</div>'
      +'<div style="font-size:.6rem;color:rgba(90,100,128,.35)">No configurado</div>'
      +'</div></div>';
  }else{
    /* PONDERADO: single score */
    var fColor=c.final_pct>=0?'var(--buy)':'var(--sell)';
    dg+='<div style="text-align:center;padding:8px;border-radius:4px;background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.08)">'
      +'<div style="font-size:.5rem;font-weight:700;color:var(--accent);text-transform:uppercase;margin-bottom:3px">Score ponderado total</div>'
      +'<div style="font-weight:900;font-size:1.3rem;color:'+fColor+';font-family:monospace">'+(c.final_pct>0?'+':'')+c.final_pct+'%</div>'
      +'<div style="font-size:.55rem;color:var(--muted);font-family:monospace">'+c.formula+'</div></div>';
  }
  dg+='</div>';
  dg+=arrow;

  /* ══ PASO 4: DISPARADORES (TRIGGERS) ══ */
  var dirOk=false,dirSide='';
  if(c.final_pct>=th.buy_pct){dirOk=true;dirSide='COMPRA';}
  else if(c.final_pct<=-th.sell_pct){dirOk=true;dirSide='VENTA';}
  var strGateOk=true;
  if(hasStrength&&th.strength_pct>0) strGateOk=c.strength_gate_ok;
  var allGatesOk=dirOk&&strGateOk;

  /* Auto conditions */
  var autoOkDir=th.auto_pct>0&&Math.abs(c.final_pct)>=th.auto_pct;
  var autoOkStr=true;
  if(hasStrength&&autoStrThPct>0) autoOkStr=c.strength_pct>=autoStrThPct;
  var isAutoPath=autoOkDir&&autoOkStr&&allGatesOk;
  var isApprovalPath=allGatesOk&&!isAutoPath;

  dg+='<div style="'+NS+'background:'+(allGatesOk?'rgba(34,197,94,.02)':'rgba(90,100,128,.02)')+';border-color:'+(allGatesOk?'rgba(34,197,94,.12)':'rgba(90,100,128,.1)')+'">'
    +'<div style="display:flex;align-items:center;margin-bottom:10px">'+stepNum('4',allGatesOk?'#22c55e':'rgba(90,100,128,.3)')+'<span style="font-size:.6rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">DISPARADORES (TRIGGERS)</span></div>';

  /* Trigger table header */
  dg+='<div style="display:flex;align-items:center;gap:6px;padding:3px 8px;margin-bottom:2px">'
    +'<span style="width:8px"></span>'
    +'<span style="font-size:.46rem;font-weight:700;color:var(--muted);text-transform:uppercase;min-width:80px">Disparador</span>'
    +'<span style="font-size:.46rem;font-weight:700;color:var(--muted);text-transform:uppercase;flex:1">Condici\u00f3n requerida</span>'
    +'<span style="font-size:.46rem;font-weight:700;color:var(--muted);text-transform:uppercase;text-align:right">Valor actual</span>'
    +'<span style="width:20px"></span>'
    +'</div>';

  /* Section A: Aprobaci\u00f3n (gates) */
  dg+='<div style="font-size:.5rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;padding:6px 8px 2px;border-top:1px solid rgba(90,100,128,.06)">A. Gates de se\u00f1al (aprobaci\u00f3n)</div>';
  dg+=triggerRow('Compra','score \u2265 '+th.buy_pct+'%',(c.final_pct>0?'+':'')+c.final_pct+'%',c.final_pct>=th.buy_pct,'#22c55e');
  dg+=triggerRow('Venta','score \u2264 \u2212'+th.sell_pct+'%',(c.final_pct>0?'+':'')+c.final_pct+'%',c.final_pct<=-th.sell_pct,'#ef4444');
  if(hasStrength&&th.strength_pct>0){
    dg+=triggerRow('Fuerza','ADX \u2265 '+th.strength_pct+'%',c.strength_pct+'%',strGateOk,'#f59e0b');
  }
  /* Gate result */
  dg+='<div style="display:flex;align-items:center;gap:6px;padding:4px 8px;margin:2px 0">'
    +'<span style="font-size:.55rem;font-weight:800;color:'+(allGatesOk?'var(--buy)':'var(--muted)')+'">'
    +(allGatesOk?'\u2705 Se\u00f1al disparada: '+dirSide:'\u274c Sin se\u00f1al \u2192 HOLD')+'</span></div>';

  /* Section B: Auto-ejecuci\u00f3n */
  dg+='<div style="font-size:.5rem;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:.4px;padding:8px 8px 2px;border-top:1px solid rgba(59,130,246,.1)">B. Disparadores de auto-ejecuci\u00f3n</div>';
  dg+=triggerRow('Auto dir.','|score| \u2265 '+(th.auto_pct>0?th.auto_pct+'%':'OFF'),th.auto_pct>0?Math.abs(c.final_pct)+'%':'N/A',autoOkDir,'#3b82f6');
  if(hasStrength){
    dg+=triggerRow('Auto fza.','ADX \u2265 '+(autoStrThPct>0?autoStrThPct+'%':'OFF'),autoStrThPct>0?c.strength_pct+'%':'N/A',autoOkStr&&autoStrThPct>0,'#3b82f6');
  }
  /* Turbo */
  if(ex.turbo_pct>0){
    var turboOk=Math.abs(c.final_pct)>=ex.turbo_pct;
    dg+=triggerRow('Turbo','|score| \u2265 '+ex.turbo_pct+'%',Math.abs(c.final_pct)+'%',turboOk,'#e040fb');
  }
  /* Auto result */
  dg+='<div style="display:flex;align-items:center;gap:6px;padding:4px 8px;margin:2px 0">'
    +'<span style="font-size:.55rem;font-weight:800;color:'+(isAutoPath?'var(--accent)':'var(--muted)')+'">'
    +(isAutoPath?'\u26a1 Auto-ejecuci\u00f3n activada':isApprovalPath?'\u23f3 Requiere aprobaci\u00f3n manual':'\u23f8 Sin acci\u00f3n')+'</span></div>';

  dg+='</div>';

  /* ══ PASO 5: CONFIRMACI\u00d3N (si aplica) ══ */
  if(confInfo&&confInfo.enabled){
    dg+=arrow;
    var confOk=confInfo.direction_status!=='HOLD'&&(confInfo.strength_status==='PASS'||!hasStrength);
    dg+='<div style="'+NS+'background:rgba(59,130,246,.03);border-color:rgba(59,130,246,.1)">'
      +'<div style="display:flex;align-items:center;margin-bottom:8px">'+stepNum('5','var(--accent)')+'<span style="font-size:.6rem;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:.5px">VENTANA DE CONFIRMACI\u00d3N</span>'
      +'<span style="font-size:.72rem;font-weight:900;color:var(--accent);margin-left:auto;font-family:monospace">'+confInfo.display+'</span></div>'
      +'<div style="font-size:.55rem;color:var(--muted);margin-bottom:8px">La se\u00f1al debe mantenerse estable durante el per\u00edodo configurado.</div>';
    dg+=triggerRow('EMA Dir.','se\u00f1al estable '+confInfo.display,confInfo.direction_status==='BUY'?'COMPRA':confInfo.direction_status==='SELL'?'VENTA':'ESPERAR',confInfo.direction_status!=='HOLD','#1e88e5');
    if(hasStrength){
      dg+=triggerRow('ADX Fza.','fuerza estable '+confInfo.display,confInfo.strength_status,confInfo.strength_status==='PASS','#ff9800');
    }
    dg+='</div>';
  }
  dg+=arrow;

  /* ══ PASO 6: RUTA DE EJECUCI\u00d3N ══ */
  var stepN=confInfo&&confInfo.enabled?'6':'5';
  dg+='<div style="'+NS+'background:rgba(90,100,128,.02);border-color:rgba(90,100,128,.1)">'
    +'<div style="display:flex;align-items:center;margin-bottom:10px">'+stepNum(stepN,'rgba(90,100,128,.3)')+'<span style="font-size:.6rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">RUTA DE EJECUCI\u00d3N</span></div>';

  dg+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';

  /* PATH A: Auto */
  var autoActive=isAutoPath;
  dg+='<div style="padding:12px;border-radius:4px;border:2px solid '+(autoActive?'var(--accent)':'rgba(59,130,246,.12)')+';background:'+(autoActive?'rgba(59,130,246,.06)':'rgba(59,130,246,.015)')+''+(autoActive?';box-shadow:0 0 16px rgba(59,130,246,.15)':'')+'">';
  dg+='<div style="display:flex;align-items:center;gap:4px;margin-bottom:8px">'
    +dot(autoActive?'#3b82f6':'#5a6480')+'<span style="font-size:.6rem;font-weight:800;color:'+(autoActive?'var(--accent)':'var(--muted)')+';text-transform:uppercase">\u26a1 Auto-ejecuci\u00f3n</span></div>';
  if(autoActive){
    /* Order details */
    var aSide=d.signal==='BUY'?'COMPRA':'VENTA';
    var aQty=d.signal==='BUY'?(ex.buy_quantity||ex.auto_quantity):(ex.sell_quantity||ex.auto_quantity);
    var aType=d.signal==='BUY'?(ex.buy_order_type||'oco'):(ex.sell_order_type||'oco');
    dg+='<div style="font-size:.55rem;color:var(--muted);margin-bottom:6px">Orden lista para ejecutar:</div>';
    dg+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px">';
    dg+='<div style="font-size:.5rem;color:var(--muted)">Lado</div><div style="font-size:.55rem;font-weight:800;color:'+sigColor+';font-family:monospace">'+aSide+'</div>';
    dg+='<div style="font-size:.5rem;color:var(--muted)">Tipo</div><div style="font-size:.55rem;font-weight:700;color:var(--text);font-family:monospace;text-transform:uppercase">'+(aType||'\u2014')+'</div>';
    dg+='<div style="font-size:.5rem;color:var(--muted)">Cantidad</div><div style="font-size:.55rem;font-weight:700;color:var(--text);font-family:monospace">'+(aQty||'\u2014')+'</div>';
    if(d.entry){
      dg+='<div style="font-size:.5rem;color:var(--muted)">Entrada</div><div style="font-size:.55rem;font-weight:700;color:var(--text);font-family:monospace">'+fP(d.entry)+'</div>';
      dg+='<div style="font-size:.5rem;color:var(--muted)">Stop Loss</div><div style="font-size:.55rem;font-weight:700;color:var(--sell);font-family:monospace">'+fP(d.stop_loss)+'</div>';
      dg+='<div style="font-size:.5rem;color:var(--muted)">Take Profit</div><div style="font-size:.55rem;font-weight:700;color:var(--buy);font-family:monospace">'+fP(d.take_profit)+'</div>';
    }
    dg+='</div>';
  }else{
    dg+='<div style="text-align:center;padding:8px;font-size:.6rem;color:var(--muted)">\u274c No aplica</div>';
  }
  dg+='<div style="text-align:center;margin-top:8px;padding:5px;border-radius:6px;background:'+(autoActive?'rgba(59,130,246,.1)':'rgba(90,100,128,.04)')+'">'
    +'<span style="font-size:.62rem;font-weight:800;color:'+(autoActive?'var(--accent)':'var(--muted)')+'">'+(autoActive?'\u26a1 EJECUTAR AUTOM\u00c1TICO':'\u2014')+'</span></div>';
  dg+='</div>';

  /* PATH B: Manual */
  var manualActive=isApprovalPath;
  dg+='<div style="padding:12px;border-radius:4px;border:2px solid '+(manualActive?'var(--hold)':'rgba(245,158,11,.12)')+';background:'+(manualActive?'rgba(245,158,11,.06)':'rgba(245,158,11,.015)')+''+(manualActive?';box-shadow:0 0 16px rgba(245,158,11,.15)':'')+'">';
  dg+='<div style="display:flex;align-items:center;gap:4px;margin-bottom:8px">'
    +dot(manualActive?'#f59e0b':'#5a6480')+'<span style="font-size:.6rem;font-weight:800;color:'+(manualActive?'var(--hold)':'var(--muted)')+';text-transform:uppercase">\u23f3 Aprobaci\u00f3n manual</span></div>';
  if(manualActive){
    dg+='<div style="font-size:.55rem;color:var(--muted);margin-bottom:6px">Se\u00f1al pendiente de revisi\u00f3n:</div>';
    dg+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px">';
    dg+='<div style="font-size:.5rem;color:var(--muted)">Se\u00f1al</div><div style="font-size:.55rem;font-weight:800;color:'+sigColor+';font-family:monospace">'+sigLabel+'</div>';
    dg+='<div style="font-size:.5rem;color:var(--muted)">Score</div><div style="font-size:.55rem;font-weight:700;color:'+sigColor+';font-family:monospace">'+(c.final_pct>0?'+':'')+c.final_pct+'%</div>';
    if(d.entry){
      dg+='<div style="font-size:.5rem;color:var(--muted)">Entrada</div><div style="font-size:.55rem;font-weight:700;color:var(--text);font-family:monospace">'+fP(d.entry)+'</div>';
      dg+='<div style="font-size:.5rem;color:var(--muted)">Stop Loss</div><div style="font-size:.55rem;font-weight:700;color:var(--sell);font-family:monospace">'+fP(d.stop_loss)+'</div>';
      dg+='<div style="font-size:.5rem;color:var(--muted)">Take Profit</div><div style="font-size:.55rem;font-weight:700;color:var(--buy);font-family:monospace">'+fP(d.take_profit)+'</div>';
    }
    dg+='</div>';
  }else{
    dg+='<div style="text-align:center;padding:8px;font-size:.6rem;color:var(--muted)">\u274c No aplica</div>';
  }
  dg+='<div style="text-align:center;margin-top:8px;padding:5px;border-radius:6px;background:'+(manualActive?'rgba(245,158,11,.1)':'rgba(90,100,128,.04)')+'">'
    +'<span style="font-size:.62rem;font-weight:800;color:'+(manualActive?'var(--hold)':'var(--muted)')+'">'+(manualActive?'\u23f3 PENDIENTE APROBACI\u00d3N':'\u2014')+'</span></div>';
  dg+='</div>';

  dg+='</div></div>';
  dg+=arrow;

  /* ══ RESULTADO FINAL ══ */
  var stepF=confInfo&&confInfo.enabled?'7':'6';
  var finalBg,finalBorder,finalColor,finalIcon,finalText;
  if(isAutoPath){
    finalBg='rgba(59,130,246,.08)';finalBorder='var(--accent)';finalColor='var(--accent)';finalIcon='\u26a1';finalText='AUTO-EJECUTAR '+sigLabel;
  }else if(isApprovalPath){
    finalBg=d.signal==='BUY'?'rgba(34,197,94,.08)':'rgba(239,68,68,.08)';
    finalBorder=sigColor;finalColor=sigColor;finalIcon='\u23f3';finalText='APROBACI\u00d3N '+sigLabel;
  }else{
    finalBg='rgba(90,100,128,.05)';finalBorder='var(--muted)';finalColor='var(--muted)';finalIcon='\u23f8';finalText='SIN ACCI\u00d3N (HOLD)';
  }
  dg+='<div style="text-align:center;padding:16px 20px;border-radius:4px;background:'+finalBg+';border:2px solid '+finalBorder+'">'
    +'<div style="display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:4px">'+stepNum(stepF,finalBorder)+'<span style="font-size:1.2rem">'+finalIcon+'</span></div>'
    +'<div style="font-weight:900;font-size:.95rem;color:'+finalColor+';letter-spacing:.5px">'+finalText+'</div>';
  if(d.entry&&(isAutoPath||isApprovalPath)){
    dg+='<div style="font-size:.6rem;color:var(--muted);margin-top:4px;font-family:monospace">Entrada: '+fP(d.entry)+' | SL: '+fP(d.stop_loss)+' | TP: '+fP(d.take_profit)+'</div>';
  }
  dg+='</div>';

  dg+='</div>';
  document.getElementById('flowDiagramContainer').innerHTML=dg;
}

function renderFlowSummary(d){
  var sigColor=d.recommendation==='BUY'?'var(--buy)':d.recommendation==='SELL'?'var(--sell)':'var(--muted)';
  var sigLabel=d.recommendation==='BUY'?'COMPRA':d.recommendation==='SELL'?'VENTA':'ESPERAR';
  function fmtP(v){if(!v&&v!==0)return'\u2014';return v>=1000?'$'+v.toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2}):'$'+v.toFixed(4)}
  var h='<div class="flow-summary">'
    +'<div class="flow-summary-item"><div class="flow-summary-label">Par</div><div class="flow-summary-value">'+d.symbol+'</div></div>'
    +'<div class="flow-summary-item"><div class="flow-summary-label">Precio actual</div><div class="flow-summary-value">'+fmtP(d.last_close)+'</div></div>'
    +'<div class="flow-summary-item"><div class="flow-summary-label">Se\u00f1al</div><div class="flow-summary-value" style="color:'+sigColor+'">'+sigLabel+'</div></div>'
    +'<div class="flow-summary-item"><div class="flow-summary-label">Confianza</div><div class="flow-summary-value">'+d.confidence+'%</div></div>'
    +'<div class="flow-summary-item"><div class="flow-summary-label">Entrada</div><div class="flow-summary-value">'+fmtP(d.entry)+'</div></div>'
    +'<div class="flow-summary-item"><div class="flow-summary-label">Stop Loss</div><div class="flow-summary-value" style="color:var(--sell)">'+fmtP(d.stop_loss)+'</div></div>'
    +'<div class="flow-summary-item"><div class="flow-summary-label">Take Profit</div><div class="flow-summary-value" style="color:var(--buy)">'+fmtP(d.take_profit)+'</div></div>'
    +'<div class="flow-summary-item"><div class="flow-summary-label">Velas</div><div class="flow-summary-value">'+d.candle_count+'</div></div>'
    +'</div>';
  document.getElementById('flowSummaryContainer').innerHTML=h;
}

function _flowPillsForStep(key,stepIdx){
  if(!_flowLiveData||!_flowLiveData.metrics)return'';
  var mapping=FLOW_KEYS[key];
  if(!mapping||!mapping[stepIdx])return'';
  var metricKeys=mapping[stepIdx].split(',');
  var pills=[];
  metricKeys.forEach(function(mk){
    var v=_flowLiveData.metrics[mk];
    if(v===undefined||v===null)return;
    pills.push('<span class="flow-live-pill"><span class="flk">'+formatMetricKey(mk)+':</span> <span class="flv">'+formatMetricValue(mk,v)+'</span></span>');
  });
  return pills.length?'<div class="flow-live-values">'+pills.join('')+'</div>':'';
}

function renderFlowDiagram(key){
  var container=document.getElementById('flowDiagramContainer');
  if(!key){container.innerHTML='';return}
  var flow=STRATEGY_FLOWS[key];
  if(!flow){container.innerHTML='';return}
  var live=_flowLiveData;
  var h='<div class="flow-diagram">';
  h+='<div class="flow-header"><div class="flow-header-icon">'+flow.icon+'</div>'
    +'<div class="flow-header-name">'+key+': '+flow.name+'</div>'
    +'<div class="flow-header-cat">'+flow.category+'</div></div>';
  var stepNum=1;
  for(var i=0;i<flow.steps.length;i++){
    var s=flow.steps[i];
    if(i>0)h+='<div class="flow-arrow"></div>';
    if(s.branches){
      h+='<div class="flow-step '+s.type+'">'
        +'<div class="flow-step-label"><span class="step-num">'+stepNum+'</span>DECISION</div>'
        +'<div class="flow-step-title">'+s.title+'</div>'
        +'<div class="flow-step-body">'+s.body+'</div></div>';
      h+='<div class="flow-arrow"></div>';
      h+='<div class="flow-decision-branches">';
      var activeRec=live?live.recommendation:'';
      s.branches.forEach(function(b){
        var isActive=(b.cls==='buy'&&activeRec==='BUY')||(b.cls==='sell'&&activeRec==='SELL')||(b.cls==='hold'&&activeRec==='NO-TRADE');
        h+='<div class="flow-branch '+b.cls+(isActive?' active-branch':'')+'">'+b.label+'<span class="flow-branch-cond">'+b.cond+'</span></div>';
      });
      h+='</div>';
    } else if(s.type==='output'&&live){
      var typeLabel='RESULTADO';
      h+='<div class="flow-step '+s.type+'">'
        +'<div class="flow-step-label"><span class="step-num">'+stepNum+'</span>'+typeLabel+'</div>'
        +'<div class="flow-step-title">'+s.title+'</div>'
        +'<div class="flow-step-body">'+s.body+'</div>'
        +(s.formula?'<div class="flow-step-formula">'+s.formula+'</div>':'')
        +'<div class="flow-live-values"><span class="flow-live-pill"><span class="flk">Confianza:</span> <span class="flv">'+live.confidence+'%</span></span></div>'
        +'</div>';
    } else if(s.type==='risk'&&live){
      var typeLabel='RIESGO';
      function fP(v){if(!v&&v!==0)return'\u2014';return v>=1000?'$'+v.toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2}):'$'+v.toFixed(4)}
      var riskPills='<div class="flow-live-values">';
      if(live.entry)riskPills+='<span class="flow-live-pill"><span class="flk">Entrada:</span> <span class="flv">'+fP(live.entry)+'</span></span>';
      if(live.stop_loss)riskPills+='<span class="flow-live-pill" style="border-color:rgba(239,68,68,.3)"><span class="flk">SL:</span> <span class="flv" style="color:var(--sell)">'+fP(live.stop_loss)+'</span></span>';
      if(live.take_profit)riskPills+='<span class="flow-live-pill" style="border-color:rgba(34,197,94,.3)"><span class="flk">TP:</span> <span class="flv" style="color:var(--buy)">'+fP(live.take_profit)+'</span></span>';
      riskPills+='</div>';
      h+='<div class="flow-step '+s.type+'">'
        +'<div class="flow-step-label"><span class="step-num">'+stepNum+'</span>'+typeLabel+'</div>'
        +'<div class="flow-step-title">'+s.title+'</div>'
        +'<div class="flow-step-body">'+s.body+'</div>'
        +(s.formula?'<div class="flow-step-formula">'+s.formula+'</div>':'')
        +riskPills
        +'</div>';
    } else {
      var typeLabel={input:'ENTRADA',calc:'CALCULO',norm:'NORMALIZACION',output:'RESULTADO',risk:'RIESGO'}[s.type]||s.type.toUpperCase();
      var pills=_flowPillsForStep(key,i);
      h+='<div class="flow-step '+s.type+'">'
        +'<div class="flow-step-label"><span class="step-num">'+stepNum+'</span>'+typeLabel+'</div>'
        +'<div class="flow-step-title">'+s.title+'</div>'
        +'<div class="flow-step-body">'+s.body+'</div>'
        +(s.formula?'<div class="flow-step-formula">'+s.formula+'</div>':'')
        +pills
        +'</div>';
    }
    stepNum++;
  }
  if(live&&live.explanation){
    h+='<div class="flow-arrow"></div>';
    h+='<div class="flow-step calc" style="background:rgba(59,130,246,.03)">'
      +'<div class="flow-step-label"><span class="step-num">\u2139</span>EXPLICACION</div>'
      +'<div class="flow-step-body" style="font-style:italic">'+live.explanation+'</div>'
      +'</div>';
  }
  h+='</div>';
  container.innerHTML=h;
}

/* ════════════════════════════════════════════════════════════════════
   MARKETPLACE
   ════════════════════════════════════════════════════════════════════ */
var _mktSelected=new Set();
var _mktLastResults=null;

async function loadMarketplace(){
  var loader=document.getElementById('mktLoader');
  var list=document.getElementById('mktRecipeList');
  loader.classList.add('show');list.innerHTML='';
  document.getElementById('mktResults').innerHTML='';
  try{
    var recipes=await api('GET','/recipe/');
    loader.classList.remove('show');
    if(!recipes.length){
      list.innerHTML='<div class="ops-empty"><div class="ops-empty-icon">&#128202;</div>'
        +'<div style="font-weight:700;margin-bottom:4px">No hay recetas</div>'
        +'<div style="font-size:.82rem;color:var(--muted)">Cre\u00e1 recetas en la pesta\u00f1a Recetas primero.</div></div>';
      return;
    }
    var h='';
    for(var r of recipes){
      var strats=(r.strategies||[]).map(function(x){return x.strategy}).join('+');
      var mode=r.mode?(r.mode==='weighted'?' \u00b7 Pond.':' \u00b7 Roles'):'';
      var checked=_mktSelected.has(r.id)?'checked':'';
      var selCls=_mktSelected.has(r.id)?' selected':'';
      h+='<label class="mkt-recipe-item'+selCls+'" onclick="event.stopPropagation()">';
      h+='<input type="checkbox" '+checked+' onchange="toggleMktRecipe('+r.id+',this)">';
      h+='<div class="mkt-recipe-info">';
      h+='<div class="mkt-recipe-name">'+r.name+'</div>';
      h+='<div class="mkt-recipe-meta">'+r.symbol+' \u00b7 '+r.interval+' \u00b7 '+strats+mode+'</div>';
      h+='</div></label>';
    }
    list.innerHTML=h;
    _updateMktBtn();
  }catch(e){loader.classList.remove('show');toast('Error: '+e.message,'error')}
}

function toggleMktRecipe(id,cb){
  if(cb.checked)_mktSelected.add(id);else _mktSelected.delete(id);
  // Update visual state
  var item=cb.closest('.mkt-recipe-item');
  if(item)item.classList.toggle('selected',cb.checked);
  _updateMktBtn();
}

function _updateMktBtn(){
  var btn=document.getElementById('btnMktCompare');
  var n=_mktSelected.size;
  btn.disabled=n<2;
  btn.textContent='Comparar seleccionadas'+(n>0?' ('+n+')':'');
}

async function runMktCompare(){
  if(_mktSelected.size<2){toast('Seleccion\u00e1 al menos 2 recetas','warn');return}
  var btn=document.getElementById('btnMktCompare');
  btn.disabled=true;btn.textContent='Comparando...';
  try{
    var ids=Array.from(_mktSelected);
    var results=await api('POST','/marketplace/compare',{recipe_ids:ids});
    _renderCompareResults(results);
  }catch(e){toast('Error: '+e.message,'error')}
  _updateMktBtn();
}

function _renderCompareResults(results){
  var panel=document.getElementById('mktResults');
  _mktLastResults=results;
  if(!results.length){panel.innerHTML='<p style="color:var(--muted)">No hay resultados.</p>';return}

  // Find best values for highlighting
  var bests={};
  var metrics=[
    {key:'total_trades',label:'Trades',fmt:function(v){return v},higher:true},
    {key:'wins',label:'Ganados',fmt:function(v){return v},higher:true},
    {key:'losses',label:'Perdidos',fmt:function(v){return v},higher:false},
    {key:'win_rate',label:'Win Rate',fmt:function(v){return v.toFixed(1)+'%'},higher:true},
    {key:'net_pnl',label:'P&L Neto',fmt:function(v){return (v>=0?'+$':'$')+v.toFixed(2)},higher:true},
    {key:'gross_pnl',label:'P&L Bruto',fmt:function(v){return (v>=0?'+$':'$')+v.toFixed(2)},higher:true},
    {key:'avg_win',label:'Avg Ganancia',fmt:function(v){return v?'$'+v.toFixed(2):'N/A'},higher:true},
    {key:'avg_loss',label:'Avg P\u00e9rdida',fmt:function(v){return v?'$'+v.toFixed(2):'N/A'},higher:true},
    {key:'profit_factor',label:'Profit Factor',fmt:function(v){return v!==null?v.toFixed(2):'N/A'},higher:true},
    {key:'best_trade',label:'Mejor Trade',fmt:function(v){return (v>=0?'+$':'$')+v.toFixed(2)},higher:true},
    {key:'worst_trade',label:'Peor Trade',fmt:function(v){return (v>=0?'+$':'$')+v.toFixed(2)},higher:true},
  ];

  // Find best per metric
  for(var m of metrics){
    var bestIdx=-1,bestVal=null;
    for(var ri=0;ri<results.length;ri++){
      var val=results[ri][m.key];
      if(val===null||val===undefined)continue;
      if(bestVal===null||(m.higher?val>bestVal:val<bestVal)){bestVal=val;bestIdx=ri}
    }
    bests[m.key]=bestIdx;
  }

  // Build table header
  var h='<div style="font-weight:800;font-size:1rem;margin-bottom:12px">Resultados de Operaciones Reales</div>';
  h+='<div style="overflow-x:auto"><table class="mkt-results-table"><thead><tr><th>M\u00e9trica</th>';
  for(var r of results){
    h+='<th>'+r.recipe_name+'<br><span style="font-weight:400;font-size:.6rem;text-transform:none">'+r.symbol+' \u00b7 '+r.interval+'</span></th>';
  }
  h+='</tr></thead><tbody>';

  // Build rows
  for(var m of metrics){
    h+='<tr><td>'+m.label+'</td>';
    for(var ri=0;ri<results.length;ri++){
      var val=results[ri][m.key];
      var cls=bests[m.key]===ri&&results.length>1?' class="mkt-best"':'';
      var pnlStyle='';
      if(m.key==='net_pnl'||m.key==='gross_pnl'||m.key==='best_trade'||m.key==='worst_trade'){
        pnlStyle=' style="color:'+(val>=0?'var(--buy)':'var(--sell)')+'"';
      }
      if(m.key==='avg_loss'&&val!==0){pnlStyle=' style="color:var(--sell)"'}
      if(m.key==='avg_win'&&val!==0){pnlStyle=' style="color:var(--buy)"'}
      h+='<td'+cls+pnlStyle+'>'+m.fmt(val)+(bests[m.key]===ri&&results.length>1?' \u2713':'')+'</td>';
    }
    h+='</tr>';
  }
  h+='</tbody></table></div>';

  // Trades detail per recipe
  h+='<div class="mkt-trades-section">';
  h+='<div style="font-weight:800;font-size:.92rem;margin:20px 0 10px">Detalle de Trades por Receta</div>';
  for(var ri=0;ri<results.length;ri++){
    var r=results[ri];
    var tid='mktTrades_'+r.recipe_id;
    h+='<div style="margin-bottom:6px">';
    h+='<div class="mkt-trades-toggle" onclick="this.classList.toggle(\'open\');document.getElementById(\''+tid+'\').style.display=this.classList.contains(\'open\')?\'block\':\'none\'">';
    h+='<span class="arrow">\u25B6</span> '+r.recipe_name+' <span style="color:var(--muted);font-weight:400;font-size:.72rem">('+r.trades.length+' trades cerrados)</span></div>';
    h+='<div id="'+tid+'" class="mkt-trades-body" style="display:none">';
    if(!r.trades.length){
      h+='<div style="padding:16px;color:var(--muted);font-size:.78rem;text-align:center">Sin operaciones cerradas</div>';
    }else{
      h+='<table><thead><tr><th>#</th><th>Simbolo</th><th>Side</th><th>Entry</th><th>Exit</th><th>Tipo</th><th>P&L %</th><th>P&L $</th></tr></thead><tbody>';
      for(var ti=0;ti<r.trades.length;ti++){
        var t=r.trades[ti];
        var tc=t.pnl_pct>=0?'var(--buy)':'var(--sell)';
        h+='<tr>';
        h+='<td>'+(ti+1)+'</td>';
        h+='<td>'+t.symbol+'</td>';
        h+='<td style="color:'+(t.side==='BUY'?'var(--buy)':'var(--sell)')+'">'+t.side+'</td>';
        h+='<td>'+t.entry_price+'</td>';
        h+='<td>'+t.exit_price+'</td>';
        h+='<td>'+t.exit_type+'</td>';
        h+='<td style="color:'+tc+';font-weight:700">'+(t.pnl_pct>=0?'+':'')+t.pnl_pct.toFixed(2)+'%</td>';
        h+='<td style="color:'+tc+';font-weight:700">'+(t.net_pnl_abs>=0?'+$':'$')+t.net_pnl_abs.toFixed(2)+'</td>';
        h+='</tr>';
      }
      h+='</tbody></table>';
    }
    h+='</div></div>';
  }
  h+='</div>';

  h+='<div style="margin-top:16px;text-align:center"><button class="btn btn-outline btn-sm" onclick="downloadMktPdf()" style="padding:8px 20px">Descargar PDF</button></div>';
  h+='<div class="mkt-note">Solo se muestran operaciones ejecutadas y cerradas (OCO completados). Las recetas sin trades aparecen con 0 en todas las m\u00e9tricas.</div>';
  panel.innerHTML=h;
  panel.scrollIntoView({behavior:'smooth'});
}

function downloadMktPdf(){
  if(!_mktLastResults||!_mktLastResults.length){toast('No hay resultados para exportar','warn');return}
  var jsPDF=window.jspdf.jsPDF;
  var doc=new jsPDF({orientation:'landscape',unit:'mm',format:'a4'});
  var now=new Date();
  var fecha=now.toLocaleDateString('es-AR',{year:'numeric',month:'2-digit',day:'2-digit'})+' '+now.toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit'});
  var names=_mktLastResults.map(function(r){return r.recipe_name});

  // Title
  doc.setFontSize(16);
  doc.setFont(undefined,'bold');
  doc.text('Analizador de Recetas',14,18);
  doc.setFontSize(9);
  doc.setFont(undefined,'normal');
  doc.setTextColor(120);
  doc.text('Fecha: '+fecha,14,25);
  doc.text('Recetas: '+names.join(', '),14,30);
  doc.setTextColor(0);

  // Comparison table
  var head=[['M\u00e9trica']];
  for(var r of _mktLastResults) head[0].push(r.recipe_name);

  var metricsDef=[
    ['Trades','total_trades',false],['Ganados','wins',false],['Perdidos','losses',false],
    ['Win Rate','win_rate',true],['P&L Neto','net_pnl',true],['P&L Bruto','gross_pnl',true],
    ['Avg Ganancia','avg_win',true],['Avg P\u00e9rdida','avg_loss',true],
    ['Profit Factor','profit_factor',false],['Mejor Trade','best_trade',true],['Peor Trade','worst_trade',true],
  ];
  var body=[];
  for(var md of metricsDef){
    var row=[md[0]];
    for(var r of _mktLastResults){
      var v=r[md[1]];
      if(v===null||v===undefined)row.push('N/A');
      else if(md[2])row.push((v>=0?'+':'')+v.toFixed(2));
      else row.push(String(v!==null?v:'N/A'));
    }
    body.push(row);
  }

  doc.autoTable({head:head,body:body,startY:36,
    theme:'grid',styles:{fontSize:8,cellPadding:2},
    headStyles:{fillColor:[30,35,60],textColor:255,fontStyle:'bold',fontSize:8},
    alternateRowStyles:{fillColor:[245,245,250]},
    columnStyles:{0:{fontStyle:'bold',cellWidth:30}},
  });

  // Trade details per recipe
  for(var ri=0;ri<_mktLastResults.length;ri++){
    var rec=_mktLastResults[ri];
    if(!rec.trades.length)continue;
    doc.addPage();
    doc.setFontSize(12);doc.setFont(undefined,'bold');
    doc.text(rec.recipe_name+' \u2014 Detalle de Trades',14,18);
    doc.setFontSize(8);doc.setFont(undefined,'normal');doc.setTextColor(120);
    doc.text(rec.symbol+' \u00b7 '+rec.interval+' \u00b7 '+rec.trades.length+' trades',14,24);
    doc.setTextColor(0);

    var tHead=[['#','Simbolo','Side','Entry','Exit','Tipo','P&L %','P&L $']];
    var tBody=[];
    for(var ti=0;ti<rec.trades.length;ti++){
      var t=rec.trades[ti];
      tBody.push([
        String(ti+1),t.symbol,t.side,
        String(t.entry_price),String(t.exit_price),t.exit_type,
        (t.pnl_pct>=0?'+':'')+t.pnl_pct.toFixed(2)+'%',
        (t.net_pnl_abs>=0?'+$':'$')+t.net_pnl_abs.toFixed(2),
      ]);
    }
    doc.autoTable({head:tHead,body:tBody,startY:28,
      theme:'grid',styles:{fontSize:7,cellPadding:1.5},
      headStyles:{fillColor:[30,35,60],textColor:255,fontStyle:'bold',fontSize:7},
      alternateRowStyles:{fillColor:[245,245,250]},
    });
  }

  // Footer note
  var pageCount=doc.internal.getNumberOfPages();
  for(var i=1;i<=pageCount;i++){
    doc.setPage(i);
    doc.setFontSize(7);doc.setTextColor(150);
    doc.text('Carl Friedrich Gauss \u2014 Analizador de Recetas \u2014 '+fecha,14,doc.internal.pageSize.height-8);
    doc.text('P\u00e1gina '+i+'/'+pageCount,doc.internal.pageSize.width-30,doc.internal.pageSize.height-8);
  }

  var slug=names.join('_vs_').replace(/[^a-zA-Z0-9_]/g,'').substring(0,60);
  doc.save('analisis_'+slug+'_'+now.toISOString().slice(0,10)+'.pdf');
}
</script>

<!-- MOBILE BOTTOM NAV -->
<nav class="mobile-bottom-nav" id="mobileBottomNav">
  <div class="mobile-bottom-nav-inner">
    <button class="mob-nav-btn active" onclick="mobNavTo('recipes',this)" data-tab="recipes">
      <span class="mob-nav-icon">&#128214;</span><span>Recetas</span>
    </button>
    <button class="mob-nav-btn" onclick="mobNavTo('approvals',this)" data-tab="approvals">
      <span class="mob-nav-icon">&#9989;</span><span>Aprobar</span>
    </button>
    <button class="mob-nav-btn" onclick="mobNavTo('operations',this)" data-tab="operations">
      <span class="mob-nav-icon">&#128200;</span><span>Operar</span>
    </button>
    <button class="mob-nav-btn" onclick="mobNavTo('setup',this)" data-tab="setup">
      <span class="mob-nav-icon">&#9881;</span><span>Setup</span>
    </button>
    <button class="mob-nav-btn" onclick="toggleMoreDrawer()" data-tab="more">
      <span class="mob-nav-icon">&#8943;</span><span>M&aacute;s</span>
    </button>
  </div>
</nav>

<!-- MOBILE MORE DRAWER -->
<div class="mob-more-overlay" id="mobMoreOverlay" onclick="toggleMoreDrawer()"></div>
<div class="mob-more-drawer" id="mobMoreDrawer">
  <div class="mob-more-handle"></div>
  <div class="mob-more-title">M&aacute;s opciones</div>
  <button class="mob-more-item" onclick="mobNavTo('strategies');toggleMoreDrawer()">
    <span class="mob-more-icon">&#128202;</span> Estrategias
  </button>
  <button class="mob-more-item" onclick="mobNavTo('flowcharts');toggleMoreDrawer()">
    <span class="mob-more-icon">&#128300;</span> Flujo de C&aacute;lculo
  </button>
  <button class="mob-more-item" onclick="mobNavTo('marketplace');toggleMoreDrawer()">
    <span class="mob-more-icon">&#128269;</span> Analizador
  </button>
  <div class="mob-more-divider"></div>
  <div class="mob-more-item" style="cursor:default">
    <span class="mob-more-icon">&#127912;</span>
    <span>Tema</span>
    <select class="theme-select" id="mobThemeSelect" onchange="setTheme(this.value)" style="margin-left:auto">
      <option value="dark">&#127761; Dark</option>
      <option value="medium">&#127764; Twilight</option>
      <option value="light">&#9728;&#65039; Light</option>
    </select>
  </div>
  <button class="mob-more-item" onclick="openSettings();toggleMoreDrawer()">
    <span class="mob-more-icon">&#9881;</span> Configuraci&oacute;n
  </button>
  <div class="mob-more-divider"></div>
  <button class="mob-more-item" style="color:var(--sell)" onclick="logout();toggleMoreDrawer()">
    <span class="mob-more-icon">&#10006;</span> Salir
  </button>
</div>

</body>
</html>
